<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Photo Feed - HC Sibir (Optimized)</title>
    <style>
        @font-face {
            font-family: 'MyCustomFont';
            src: url('fonts/DrukCyr-HeavyItalic.ttf') format('truetype');
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: transparent; 
            font-family: 'MyCustomFont', sans-serif; color: white; 
        }

        #bg-video {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -2;
        }
        .video-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; 
        }

        /* --- QR SCREEN --- */
        .qr-scene {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 60px;
            justify-content: center;
            backdrop-filter: blur(10px);
            z-index: 100;
            
            opacity: 0;
            visibility: hidden;
            transform: scale(1.1) translateZ(0); /* GPU acceleration */
            transition: opacity 0.6s ease, transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.6s;
            will-change: opacity, transform;
        }

        .qr-scene.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateZ(0);
        }

        .qr-row { display: flex; gap: 100px; justify-content: center; align-items: flex-start; }
        .qr-item { display: flex; flex-direction: column; align-items: center; }
        .qr-item img { 
            width: 700px; border: 10px solid white; border-radius: 20px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        }
        
        .qr-title { 
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); 
            font-size: 160px; 
            margin-top: 40px;
            text-transform: uppercase;
            animation: pulse-glow 2s ease-in-out infinite; 
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1) translateZ(0); text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); }
            50% { transform: scale(1.03) translateZ(0); text-shadow: 0 0 50px rgba(0, 242, 255, 0.9); }
        }

        /* --- PHOTO FEED --- */
        .container { 
            display: flex; 
            width: 100%; 
            height: 100%; 
            opacity: 1;
            visibility: visible;
            transform: scale(1) translateZ(0);
            transition: opacity 0.6s ease, transform 0.6s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.6s;
            will-change: opacity, transform;
        }

        .container.hidden {
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95) translateZ(0);
        }

        .feed-area { 
            width: 80%; height: 100%; position: relative; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; 
        }
        
        .sidebar { 
            width: 20%; height: 100%; display: flex; 
            flex-direction: column; align-items: center; 
            justify-content: space-around; padding: 20px; 
            box-sizing: border-box; z-index: 10; 
        }
        
        .logo-img { width: 85%; filter: drop-shadow(0 0 15px rgba(0,242,255,0.6)); }
        
        .qr-sidebar-block { text-align: center; }
        .qr-sidebar-block p { 
            font-size: 42px; margin: 0 0 15px 0; 
            text-transform: uppercase; 
            text-shadow: 0 0 15px rgba(0, 242, 255, 0.8); 
            line-height: 1; 
        }
        .qr-sidebar-block img { 
            width: 85%; border: 5px solid white; 
            border-radius: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.5); 
        }

        /* --- PHOTO CARD (GPU-OPTIMIZED) --- */
        .photo-card {
            position: absolute; 
            background: #1a1a1a; 
            padding: 15px; 
            border: 4px solid #00f2ff; 
            border-radius: 12px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.9), 0 0 40px rgba(0, 242, 255, 0.3);
            max-width: 85vw; 
            max-height: 80vh; 
            display: flex; 
            flex-direction: column; 
            opacity: 0; 
            will-change: transform, opacity;
            transform: translateZ(0); /* Force GPU layer */
            backface-visibility: hidden; /* Prevent flickering */
        }

        .user-badge {
            position: absolute; top: -30px; left: -30px; 
            background: #00f2ff; color: #000;
            padding: 10px 25px 10px 10px; 
            border-radius: 60px; 
            display: flex; align-items: center; gap: 15px;
            box-shadow: 10px 10px 25px rgba(0,0,0,0.4); 
            z-index: 5;
            will-change: transform;
            transform: translateZ(0);
        }
        
        .user-badge img { 
            width: 70px; height: 70px; 
            border-radius: 50%; border: 3px solid white; 
            object-fit: cover; background: white; 
        }
        
        .user-badge span { font-size: 32px; font-weight: bold; }
        
        .photo-image { 
            max-width: 100%; max-height: 75vh; 
            display: block; border-radius: 6px; 
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast; /* Better performance */
        }

        @keyframes flowAnimation {
            0% { 
                transform: translateY(-130%) rotate(-8deg) scale(0.9) translateZ(0); 
                opacity: 0; 
            }
            50% { 
                transform: translateY(0) rotate(var(--rot)) scale(1) translateZ(0); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(130%) rotate(8deg) scale(1.05) translateZ(0); 
                opacity: 0; 
            }
        }
        
        .animate-card { 
            animation: flowAnimation 4.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; 
        }

        /* Preload indicator (optional) */
        .loading-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 242, 255, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .loading-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <video autoplay muted loop playsinline id="bg-video">
        <source src="media/backgroundvideo.webm" type="video/webm">
    </video>
    <div class="video-overlay"></div>

    <div id="qr-screen" class="qr-scene">
        <div class="qr-row">
            <div class="qr-item"><img src="media/telegramqr.png"></div>
            <div class="qr-item"><img src="media/max.jpg"></div>
        </div>
        <h1 class="qr-title">–ü—Ä–∏—Å—ã–ª–∞–π—Ç–µ —Å–≤–æ–∏ —Ñ–æ—Ç–æ!</h1>
    </div>

    <div class="container" id="main-ui">
        <div class="feed-area" id="feed"></div>

        <div class="sidebar">
            <img src="media/HC_Sibir_Logo.svg.png" class="logo-img">
            <div class="qr-sidebar-block">
                <p>–ü—Ä–∏—Å—ã–ª–∞–π —Ñ–æ—Ç–æ</p>
                <img src="media/telegramqr.png" style="margin-bottom: 25px;"> 
                <img src="media/max.jpg">
            </div>
        </div>
    </div>

    <div class="loading-indicator" id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
            authDomain: "arenawork-94e68.firebaseapp.com",
            databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
            projectId: "arenawork-94e68",
            storageBucket: "arenawork-94e68.firebasestorage.app",   
            messagingSenderId: "504372844993",
            appId: "1:504372844993:web:1783bb75879ee074953740"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ========== PERFORMANCE OPTIMIZATIONS ==========
        
        let approvedPhotos = [];
        let currentIndex = 0;
        let currentState = 'photo_feed';
        const imageCache = new Map();
        const loadingQueue = new Set();
        
        const feedContainer = document.getElementById('feed');
        const qrScreen = document.getElementById('qr-screen');
        const mainUI = document.getElementById('main-ui');
        const loader = document.getElementById('loader');

        // DOM element pool for reuse (prevent GC)
        let cardPool = [];
        const MAX_POOL_SIZE = 3;

        // –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
        const PRELOAD_AHEAD = 10; // –°–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ –≥—Ä—É–∑–∏—Ç—å –Ω–∞–ø–µ—Ä–µ–¥
        const ANIMATION_DURATION = 4500; // ms
        const TRANSITION_BUFFER = -1000; // ms

        // ========== PERSISTENT CACHE ==========
        
        const CACHE_KEY = 'hc_sibir_image_cache';
        const CACHE_TIMESTAMP_KEY = 'hc_sibir_cache_timestamp';
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–µ—à –∏–∑ localStorage
        function loadCacheFromStorage() {
            try {
                const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                const now = Date.now();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª –ª–∏ –∫–µ—à
                if (timestamp && (now - parseInt(timestamp)) < CACHE_EXPIRY) {
                    const cached = localStorage.getItem(CACHE_KEY);
                    if (cached) {
                        const urls = JSON.parse(cached);
                        console.log(`Loaded ${urls.length} cached images from localStorage`);
                        urls.forEach(url => imageCache.set(url, true));
                        return urls.length;
                    }
                }
            } catch (e) {
                console.warn('Failed to load cache:', e);
            }
            return 0;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–µ—à –≤ localStorage (—Å –¥–µ–±–∞—É–Ω—Å–æ–º)
        let saveTimeout = null;
        function saveCacheToStorage() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                try {
                    const urls = Array.from(imageCache.keys());
                    localStorage.setItem(CACHE_KEY, JSON.stringify(urls));
                    localStorage.setItem(CACHE_TIMESTAMP_KEY, Date.now().toString());
                } catch (e) {
                    console.warn('Failed to save cache:', e);
                    // –ï—Å–ª–∏ localStorage –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω, –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                    if (e.name === 'QuotaExceededError') {
                        localStorage.removeItem(CACHE_KEY);
                        localStorage.removeItem(CACHE_TIMESTAMP_KEY);
                    }
                }
            }, 1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–µ—à –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        const cachedCount = loadCacheFromStorage();
        if (cachedCount > 0) {
            console.log(`üöÄ Fast start: ${cachedCount} images in cache`);
        }

        function scaleUpImage(imgElement) {
            imgElement.onload = function() {
                const naturalWidth = this.naturalWidth;
                const naturalHeight = this.naturalHeight;
                const viewportWidth = window.innerWidth * 0.8; // 80% –æ—Ç —à–∏—Ä–∏–Ω—ã (feed-area)
                const viewportHeight = window.innerHeight;
                
                // –ï—Å–ª–∏ —Ñ–æ—Ç–æ –º–∞–ª–µ–Ω—å–∫–æ–µ (–º–µ–Ω—å—à–µ 40% viewport), —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –µ–≥–æ
                const widthRatio = naturalWidth / viewportWidth;
                const heightRatio = naturalHeight / viewportHeight;
                const minRatio = Math.max(widthRatio, heightRatio);
                
                if (minRatio < 0.4) {
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 60% viewport
                    const scale = 0.6 / minRatio;
                    this.style.width = (naturalWidth * scale) + 'px';
                    this.style.height = (naturalHeight * scale) + 'px';
                    this.style.maxWidth = '80vw';
                    this.style.maxHeight = '75vh';
                }
            };
        }

        // ========== OPTIMIZED IMAGE PRELOADING ==========
        
        function preloadImage(url) {
            if (!url || imageCache.has(url) || loadingQueue.has(url)) {
                return Promise.resolve();
            }

            loadingQueue.add(url);

            return new Promise((resolve) => {
                const img = new Image();
                // –£–±—Ä–∞–ª–∏ crossOrigin - –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                
                img.onload = () => {
                    imageCache.set(url, true); // –ö–µ—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ URL, –Ω–µ —Å–∞–º –æ–±—ä–µ–∫—Ç
                    loadingQueue.delete(url);
                    saveCacheToStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    resolve(true);
                };
                
                img.onerror = () => {
                    console.warn(`Failed to load: ${url}`);
                    loadingQueue.delete(url);
                    resolve(null);
                };
                
                img.src = url;
            });
        }

        // –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–∏—Ö N —Ñ–æ—Ç–æ
        function preloadAhead(fromIndex, count = PRELOAD_AHEAD) {
            const promises = [];
            for (let i = 0; i < count; i++) {
                const idx = (fromIndex + i) % approvedPhotos.length;
                if (approvedPhotos[idx]) {
                    promises.push(preloadImage(approvedPhotos[idx].photo));
                }
            }
            return Promise.allSettled(promises);
        }

        // ========== DOM POOL MANAGEMENT ==========
        
        function getCardFromPool() {
            if (cardPool.length > 0) {
                return cardPool.pop();
            }
            const card = document.createElement('div');
            card.className = 'photo-card';
            return card;
        }

        function returnCardToPool(card) {
            if (cardPool.length < MAX_POOL_SIZE) {
                card.className = 'photo-card'; // Reset animation
                card.style.cssText = '';
                cardPool.push(card);
            }
        }

        // ========== FIREBASE LISTENER ==========
        
        let updateTimeout = null;

        onValue(ref(db, 'competition'), (snapshot) => {
            const data = snapshot.val() || {};
            
            // –î–µ–±–∞—É–Ω—Å –¥–ª—è —á–∞—Å—Ç—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                const messages = data.allMessages || {};
                const newPhotos = Object.values(messages).filter(m => m.isImage && m.approved);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (JSON.stringify(newPhotos) !== JSON.stringify(approvedPhotos)) {
                    approvedPhotos = newPhotos;
                    
                    // –ù–ï –ñ–î–ï–ú –∑–∞–≥—Ä—É–∑–∫—É! –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É
                    if (approvedPhotos.length > 0) {
                        preloadAhead(currentIndex);
                    }
                }

                // –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
                const newState = data.slideshowState === 'slideshow_qr' ? 'qr' : 'photo_feed';
                
                if (newState !== currentState) {
                    currentState = newState;
                    
                    if (currentState === 'qr') {
                        qrScreen.classList.add('active');
                        mainUI.classList.add('hidden');
                    } else {
                        qrScreen.classList.remove('active');
                        mainUI.classList.remove('hidden');
                    }
                }
            }, 100); // 100ms debounce
        });

        // ========== PHOTO DISPLAY LOOP ==========
        
        let animationFrameId = null;
        let lastPhotoTime = 0;

        function showNextPhoto(timestamp) {
            animationFrameId = requestAnimationFrame(showNextPhoto);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–∏–Ω–≥–æ–≤
            if (timestamp - lastPhotoTime < ANIMATION_DURATION + TRANSITION_BUFFER) {
                return;
            }

            if (currentState === 'qr' || approvedPhotos.length === 0) {
                return;
            }

            if (currentIndex >= approvedPhotos.length) {
                currentIndex = 0;
            }

            const item = approvedPhotos[currentIndex];

            // –ü–û–ö–ê–ó–´–í–ê–ï–ú –°–†–ê–ó–£, –Ω–µ –∂–¥–µ–º –∫–µ—à!
            // –ë—Ä–∞—É–∑–µ—Ä —Å–∞–º –∑–∞–≥—Ä—É–∑–∏—Ç —Ñ–æ—Ç–æ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            
            // –ü–æ–ª—É—á–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ –ø—É–ª–∞
            const card = getCardFromPool();
            
            const randomRot = (Math.random() * 8 - 4) + 'deg';
            card.style.setProperty('--rot', randomRot);

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º URL –Ω–∞–ø—Ä—è–º—É—é - –±—Ä–∞—É–∑–µ—Ä –∑–∞–≥—Ä—É–∑–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            card.innerHTML = `
                <div class="user-badge">
                    <img src="${item.userPhoto || 'media/tg_logo.png'}">
                    <span>${item.name || 'FAN'}</span>
                </div>
                <img src="${item.photo}" class="photo-image">
            `;

            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            const oldCards = feedContainer.querySelectorAll('.photo-card');
            setTimeout(() => {
                oldCards.forEach(old => {
                    if (old !== card) {
                        returnCardToPool(old);
                        old.remove();
                    }
                });
            }, 500);

            feedContainer.appendChild(card);
            
            // Trigger reflow –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            void card.offsetWidth;
            card.classList.add('animate-card');

            lastPhotoTime = timestamp;
            currentIndex++;

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫—É —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–æ—Ç–æ
            preloadAhead(currentIndex);
        }

        // –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
        requestAnimationFrame(showNextPhoto);

        // ========== PERFORMANCE MONITORING (optional) ==========
        
        if (window.performance && window.performance.memory) {
            setInterval(() => {
                const memory = window.performance.memory;
                console.log(`Memory: ${(memory.usedJSHeapSize / 1048576).toFixed(2)} MB`);
            }, 10000);
        }

    </script>
</body>
</html>


