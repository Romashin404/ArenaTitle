<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Шумомер - ХК Сибирь</title>
    <style>
        @font-face {
            font-family: 'MyCustomFont';
            src: url('fonts/DrukCyr-HeavyItalic.ttf') format('truetype');
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: transparent;
            font-family: 'MyCustomFont', sans-serif; color: white;
        }

        /* Фоновое видео */
        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: 0;
            object-fit: cover;
            background-size: cover;
        }

        .video-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; 
        }

        .noise-container {
            display: flex; width: 100%; height: 100%;
            background: transparent;
            position: relative;
        }

        .video-side { width: 55%; height: 100%; }

        .ui-side {
            width: 45%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        .label-top {
            font-size: 110px; text-transform: uppercase;
            margin-bottom: 30px; 
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.8);
            letter-spacing: 2px;
        }

        .meter-wrapper { display: flex; align-items: center; gap: 50px; }
        .scale-column { display: flex; flex-direction: column-reverse; gap: 10px; }

        .segment {
            width: 170px; height: 32px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.15s ease, box-shadow 0.15s ease; /* Плавная смена цвета */
        }

        .db-circle {
            width: 320px; height: 320px;
            border-radius: 50%;
            background: rgba(0, 5, 26, 0.9);
            border: 12px solid #001a33;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }

        .db-value { font-size: 120px; color: white; font-weight: bold; font-style: italic; }
        .db-unit { position: absolute; bottom: 65px; font-size: 24px; color: #00f2ff; }

        .circle-svg { position: absolute; transform: rotate(-90deg); }
        .circle-progress {
            fill: none; stroke: #ffff00;
            stroke-width: 12;
            stroke-dasharray: 880; stroke-dashoffset: 880;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.2s ease-out; /* Плавное кольцо */
        }
    </style>
</head>
<body>

<video autoplay muted loop playsinline id="bg-video">
    <source src="media/backgroundvideo.mp4" type="video/mp4">
    <source src="media/backgroundvideo.webm" type="video/webm">
    </video>

<div class="noise-container">
    <div class="video-side"></div>
    <div class="ui-side">
        <div class="label-top">ГРОМЧЕ!</div>
        <div class="meter-wrapper">
            <div class="scale-column" id="scale"></div>
            <div class="db-circle">
                <svg class="circle-svg" width="320" height="320">
                    <circle cx="160" cy="160" r="140" fill="none" stroke="#00f2ff" stroke-width="4" opacity="0.3"></circle>
                    <circle class="circle-progress" id="progress" cx="160" cy="160" r="140"></circle>
                </svg>
                <div class="db-value" id="dbText">0</div>
                <div class="db-unit">ДЦБ</div>
            </div>
        </div>
    </div>
</div>

<script>
    const scale = document.getElementById('scale');
    const dbText = document.getElementById('dbText');
    const progress = document.getElementById('progress');
    const segments = [];

    for (let i = 0; i < 15; i++) {
        const seg = document.createElement('div');
        seg.className = 'segment';
        scale.appendChild(seg);
        segments.push(seg);
    }

    function getSegmentColor(index) {
        if (index < 5) return '#00ff00'; 
        if (index < 10) return '#ffff00'; 
        return '#ff0000'; 
    }

    async function startAudio() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            
            analyser.fftSize = 256;
            // Увеличили сглаживание до 0.8 для "ленивого" отклика
            analyser.smoothingTimeConstant = 0.8; 
            source.connect(analyser);

            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function update() {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
                let average = sum / dataArray.length;

                // Масштабируем до 0-100
                let volume = Math.min(100, Math.round(average * 1.8)); 
                
                dbText.innerText = volume;

                let activeCount = Math.floor((volume / 100) * 15);
                
                segments.forEach((s, i) => {
                    if (i < activeCount) {
                        const color = getSegmentColor(i);
                        s.style.background = color;
                        s.style.boxShadow = `0 0 15px ${color}`;
                    } else {
                        s.style.background = 'rgba(255,255,255,0.2)';
                        s.style.boxShadow = 'none';
                    }
                });

                const offset = 880 - (volume / 100) * 880;
                progress.style.strokeDashoffset = offset;

                requestAnimationFrame(update);
            }
            update();
        } catch (e) {
            console.error("Ошибка аудио:", e);
            dbText.innerText = "Err";
        }
    }

    window.addEventListener('click', startAudio, { once: true });
    setTimeout(startAudio, 1000);
</script>
</body>
</html>
