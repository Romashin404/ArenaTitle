<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sibir Control Panel ‚Äî Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --sibir-blue: #05caff;
            --sibir-dark: #253566;
            --bg-body: #d8d8d8;
            --white: #ffffff;
            --gray: rgb(223, 223, 223);
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border-color:#05caff;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 20px; 
            padding: 20px; 
            height: 100vh;
            box-sizing: border-box;
        }

        .sidebar { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow-y: auto; 
            position: sticky; 
            top: 20px; 
            height: calc(100vh - 40px);
        }

        .main { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        h2 { 
            color: var(--sibir-dark); 
            font-size: 0.85rem; 
            font-weight: 800;
            margin: 25px 0 15px 0; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        h2::before {
            content: ""; display: inline-block; width: 4px; height: 16px; 
            background: var(--sibir-blue); margin-right: 8px; border-radius: 2px;
        }

        .btn { 
            padding: 12px 15px; border: none; border-radius: 12px; 
            font-weight: 600; font-size: 0.85rem; cursor: pointer; 
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
            gap: 8px; font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }

        .btn-scene { background: #f8f9fa; color: var(--text-main); border: 1px solid var(--border-color); width: 48%; }
        .btn-scene.active { background: var(--sibir-blue) !important; color: white !important; border-color: var(--sibir-blue) !important; box-shadow: 0 4px 12px rgba(5, 202, 255, 0.3); }
        
        .btn-stop { width: 100%; background: #ff9f43; color: white; margin-bottom: 20px; font-size: 1rem; }
        .btn-stop.closed { background: #ee5253; }
        
        .btn-primary { background: var(--sibir-blue); color: white; width: 100%; }

        .tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1rem; cursor: pointer; font-weight: 700; padding: 5px 10px; transition: 0.3s; }
        .tab-btn.active { color: var(--sibir-blue); border-bottom: 3px solid var(--sibir-blue); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        .message-item {
            display: flex; background: var(--gray); border-radius: 16px; margin-bottom: 15px; padding: 20px;
            border: 1px solid var(--white); gap: 20px; align-items: flex-start; transition: 0.3s;
        }

        .message-left { min-width: 140px; display: flex; flex-direction: column; gap: 10px; }
        .message-content { flex-grow: 1; }

        .photo-container { 
            margin-top: 10px; border-radius: 12px; overflow: hidden; border: 1px solid var(--white); 
            max-width: 400px;
        }
        .photo-container img { width: 100%; display: block; }

        input, select { 
            width: 100%; height: 45px; padding: 0 15px; background: #fff; 
            border: 1.5px solid var(--sibir-blue); color: var(--text-main); 
            border-radius: 12px; margin-bottom: 15px; font-family: inherit;
            font-size: 0.9rem; box-sizing: border-box; display: block; outline: none;
        }

        select {
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2305caff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 15px;
        }

        .votes-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .vote-card { 
            background: var(--gray); padding: 15px; border-radius: 16px; text-align: center; 
            border: 2px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative;
        }
        .vote-card.correct {background: #b8ffbe; border-color: #10ac84;}
        .vote-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-body); background: #fff; }
        
        .player-tag { 
            background: #edf2f7; padding: 5px 12px; margin: 3px; display: inline-block; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        
    </style>
</head>
<body>

<div class="sidebar">
    <button id="stopBtn" class="btn btn-stop" onclick="toggleVoting()">üõë –°–¢–û–ü –ü–†–ò–ï–ú –ì–û–õ–û–°–û–í</button>

    <h2>–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º</h2>
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button id="mode-voting" class="btn btn-scene" onclick="setActiveMode('voting')">üèí –ü–µ—Ä–≤–∞—è —à–∞–π–±–∞</button>
        <button id="mode-slideshow" class="btn btn-scene" onclick="setActiveMode('slideshow')">üì∏ –°–ª–∞–π–¥-—à–æ—É</button>
    </div>

    <div id="controls-voting">
        <h2>–°—Ü–µ–Ω—ã –∫–æ–Ω–∫—É—Ä—Å–∞</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="scene-announcement" class="btn btn-scene" onclick="setScene('announcement')">–ê–Ω–æ–Ω—Å</button>
            <button id="scene-qr" class="btn btn-scene" onclick="setScene('qr')">QR-–∫–æ–¥</button>
            <button id="scene-roulette" class="btn btn-scene" onclick="setScene('roulette')">–†—É–ª–µ—Ç–∫–∞</button>
            <button id="scene-winner" class="btn btn-scene" onclick="setScene('winner')">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; background:#e0e0e0" onclick="pickWinnerManual()">üé≤ –ü–µ—Ä–µ–≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</button>
    </div>

    <div id="controls-slideshow" style="display: none;">
        <h2>–°—Ü–µ–Ω—ã —Å–ª–∞–π–¥-—à–æ—É</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="scene-slideshow_qr" class="btn btn-scene"
                    onclick="setScene('slideshow_qr')">QR-–∫–æ–¥—ã</button>

            <button id="scene-slideshow_photo" class="btn btn-scene"
                    onclick="setScene('slideshow_photo')">–°–ª–∞–π–¥-—à–æ—É</button>
        </div>
    </div>

    <h2>–§–æ–Ω –æ–≤–µ—Ä–ª–µ—è</h2>
    <input type="text" id="bgUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ .webm –∏–ª–∏ .jpg">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-scene" style="width: 48%" onclick="updateBg()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-scene" style="width: 48%" onclick="removeBackground()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>   
    
    <div id="players-controls">
        <h2>–ê–≤—Ç–æ—Ä –≥–æ–ª–∞</h2>
        <select id="goalScorer" onchange="setScorer(this.value)"></select>

        <h2>–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤</h2>
        <input type="text" id="pName" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
        <input type="text" id="pKeys" placeholder="–ù–æ–º–µ—Ä, —Ñ–∞–º–∏–ª–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
        <button class="btn btn-primary" style="background: var(--sibir-dark);" onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        <div id="playersList" style="margin-top:15px;"></div>
        
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
        <button class="btn" style="width: 100%; background: #f8f9fa; color: #ee5253; border: 1px solid #eee;" onclick="resetVotes()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–∞</button>
    </div>
</div>

<div class="main">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('votes')">–ì–æ–ª–æ—Å–∞ –±–æ–ª–µ–ª—å—â–∏–∫–æ–≤</button>
        <button class="tab-btn" onclick="switchTab('chat')">–≠—Ñ–∏—Ä (–ß–∞—Ç –∏ –§–æ—Ç–æ)</button>
    </div>

    <div id="tab-votes" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <select id="filterMode" onchange="renderVotes()" style="width: 250px; margin: 0;">
                <option value="all">–í—Å–µ –≥–æ–ª–æ—Å–∞</option>
                <option value="correct">–¢–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</option>
            </select>
            <b id="vCount" style="color: var(--sibir-blue);"></b>
        </div>
        <div id="votesList" class="votes-list"></div>
    </div>

    <div id="tab-chat" class="tab-content">
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
            <button class="btn" style="background: #ff9f43; color: white;" onclick="clearApprovedPhotos()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç—Ñ–∏—Ä</button>
            <button class="btn" style="background: #ee5253; color: white;" onclick="clearChat()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
        </div>
        <div id="messagesList"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
        authDomain: "arenawork-94e68.firebaseapp.com",
        databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
        projectId: "arenawork-94e68",
        storageBucket: "arenawork-94e68.firebasestorage.app",   
        messagingSenderId: "504372844993",
        appId: "1:504372844993:web:1783bb75879ee074953740"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentData = {};
    const tgLogo = "media/tg_logo.png";

    // --- –õ–û–ì–ò–ö–ê –û–ö–ù–ê ---

    window.toggleVoting = () => set(ref(db, 'competition/acceptingVotes'), !currentData.acceptingVotes);
    
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
    };

    window.setActiveMode = (mode) => set(ref(db, 'competition/activeMode'), mode);
    
    // --- –í–û–¢ –°–Æ–î–ê –í–°–¢–ê–í–õ–ï–ù–ê –õ–û–ì–ò–ö–ê –†–£–õ–ï–¢–ö–ò –ò –í–´–ë–û–†–ê –ü–û–ë–ï–î–ò–¢–ï–õ–Ø ---
    window.setScene = (scene) => {
        const mode = currentData.activeMode || 'voting';

        if (mode === 'voting') {

            if (scene === 'roulette') {
                const votes = currentData.votes || {};
                const scorer = currentData.scorer;

                if (!scorer) {
                    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–≤—Ç–æ—Ä–∞ –≥–æ–ª–∞!");
                    return;
                }

                const luckyOnes = Object.values(votes).filter(v => v.votedFor === scorer);

                set(ref(db, 'competition/votingState'), scene);

                if (luckyOnes.length > 0) {
                    setTimeout(() => {
                        const winner = luckyOnes[Math.floor(Math.random() * luckyOnes.length)];
                        winner.selectionId = Date.now();
                        set(ref(db, 'competition/winner'), winner);
                    }, 600);
                }
            } else {
                set(ref(db, 'competition/votingState'), scene);
            }

        } else if (mode === 'slideshow') {
            set(ref(db, 'competition/slideshowState'), scene);
        }
    };


    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–≤—ã–±–æ—Ä–∞ –±–µ–∑ —Å–º–µ–Ω—ã —Å—Ü–µ–Ω—ã
    window.pickWinnerManual = () => {
        const votes = currentData.votes || {};
        const scorer = currentData.scorer;
        if (!scorer) { 
            alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–≤—Ç–æ—Ä–∞ –≥–æ–ª–∞!"); 
            return; 
        }

        const luckyOnes = Object.values(votes).filter(v => v.votedFor === scorer);
        if (luckyOnes.length > 0) {
            const winner = luckyOnes[Math.floor(Math.random() * luckyOnes.length)];
            winner.selectionId = Date.now(); 
            set(ref(db, 'competition/winner'), winner);
            alert("–ù–æ–≤—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å: " + winner.name);
        } else {
            alert("–ù–∏–∫—Ç–æ –Ω–µ —É–≥–∞–¥–∞–ª —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞!");
        }
    };
    // -----------------------------------------------------------

    window.updateBg = () => { const url = document.getElementById('bgUrl').value; if(url) set(ref(db, 'competition/background'), url); };
    window.removeBackground = () => {
        if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ–Ω –Ω–∞ –æ–≤–µ—Ä–ª–µ–µ?")) {
            set(ref(db, 'competition/background'), null);
            document.getElementById('bgUrl').value = '';
        }
    };

    window.togglePhotoSelection = (id, status) => set(ref(db, `competition/allMessages/${id}/approved`), !status);
    window.removeMessage = (id) => confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?") && remove(ref(db, `competition/allMessages/${id}`));
    window.clearChat = () => confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π?") && remove(ref(db, 'competition/allMessages'));
    window.resetVotes = () => confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –≥–æ–ª–æ—Å–æ–≤?") && remove(ref(db, 'competition/votes'));
    
    window.clearApprovedPhotos = () => {
        if (confirm("–£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ —ç—Ñ–∏—Ä–∞?")) {
            const msgs = currentData.allMessages || {};
            const updates = {};
            for(let id in msgs) {
                if(msgs[id].approved) updates[`competition/allMessages/${id}/approved`] = false;
            }
            if(Object.keys(updates).length) update(ref(db), updates);
        }
    };

    window.sendReply = (chatId, name) => {
        if (!chatId) {
            alert("–ù–µ—Ç Chat ID. –ù–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å.");
            return;
        }
        const msg = prompt(`–û—Ç–≤–µ—Ç –¥–ª—è ${name}:`);
        if (msg) push(ref(db, 'competition/replies'), { chatId, text: msg });
    };

    window.addPlayer = () => {
        const name = document.getElementById('pName').value;
        const keywords = document.getElementById('pKeys').value;
        if(name && keywords) {
            push(ref(db, 'competition/players'), { name, keywords });
            document.getElementById('pName').value = '';
            document.getElementById('pKeys').value = '';
        }
    };

    window.removePlayer = (id) => remove(ref(db, `competition/players/${id}`));
    window.setScorer = (val) => set(ref(db, 'competition/scorer'), val);
    window.removeVote = (id) => remove(ref(db, `competition/votes/${id}`));

    // --- –°–õ–£–®–ê–¢–ï–õ–¨ –î–ê–ù–ù–´–• ---
    function updateActiveSceneButtons() {
        const mode = currentData.activeMode || 'voting';

        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω
        document
            .querySelectorAll('.btn-scene[id^="scene-"]')
            .forEach(btn => btn.classList.remove('active'));

        if (mode === 'voting') {
            const votingState = currentData.votingState || 'announcement';
            const activeBtn = document.getElementById(`scene-${votingState}`);
            if (activeBtn) activeBtn.classList.add('active');

        } else if (mode === 'slideshow') {
            const slideshowState = currentData.slideshowState || 'slideshow_photo';

            // üîë –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
            const activeBtn = document.getElementById(`scene-${slideshowState}`);
            if (activeBtn) activeBtn.classList.add('active');
        }
    }


    onValue(ref(db, 'competition'), (snapshot) => {
        currentData = snapshot.val() || {};
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —Å—Ü–µ–Ω—ã
        updateActiveSceneButtons();

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –ø–∞–Ω–µ–ª–µ–π
        const mode = currentData.activeMode || 'voting';
        document.getElementById('mode-voting').classList.toggle('active', mode === 'voting');
        document.getElementById('mode-slideshow').classList.toggle('active', mode === 'slideshow');
        
        if (mode === 'slideshow') {
            document.getElementById('controls-voting').style.display = 'none';
            document.getElementById('controls-slideshow').style.display = 'block';
            document.getElementById('players-controls').style.display = 'none';
        } else {
            document.getElementById('controls-voting').style.display = 'block';
            document.getElementById('controls-slideshow').style.display = 'none';
            document.getElementById('players-controls').style.display = 'block';
        }

        const sBtn = document.getElementById('stopBtn');
        sBtn.textContent = currentData.acceptingVotes ? "üõë –°–¢–û–ü –ü–†–ò–ï–ú –ì–û–õ–û–°–û–í" : "‚ñ∂Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–ò–ï–ú";
        sBtn.classList.toggle('closed', !currentData.acceptingVotes);

        renderPlayers(); 
        renderVotes(); 
        renderMessages();
    });


    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è DOM
    let lastMsgsHtml = "";
    let lastVotesHtml = "";

    function renderMessages() {
        const container = document.getElementById('messagesList');
        const msgs = currentData.allMessages || {};
        
        let list = Object.keys(msgs).map(id => ({id, ...msgs[id]}));
        list.sort((a, b) => b.timestamp - a.timestamp); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É

        let newHtml = '';
        list.forEach(m => {
            const userAvatar = (m.userPhoto && m.userPhoto.length > 10) ? m.userPhoto : tgLogo;
            const date = m.timestamp ? new Date(m.timestamp) : new Date();
            const timeStr = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');
            
            newHtml += `    
                <div class="message-item" style="border-left: 5px solid ${m.approved ? '#10ac84' : '#d1d8e0'}">
                    <div class="message-left">
                        <button class="btn" style="width:100%; background:${m.approved ? '#10ac84' : '#f1f2f6'}; color:${m.approved ? 'white' : 'black'}" 
                                onclick="togglePhotoSelection('${m.id}', ${m.approved})">
                            ${m.approved ? '‚úÖ –í –≠–§–ò–†–ï' : 'üì∫ –í –≠–§–ò–†'}
                        </button>
                        <span style="font-size: 11px; color: #666; text-align: center; margin-top: 5px;">${timeStr}</span>
                    </div>
                    <div class="message-content">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <div style="width:40px; height:40px; flex-shrink:0;">
                                <img src="${userAvatar}" onerror="this.onerror=null; this.src='${tgLogo}'" style="width:40px; height:40px; border-radius:50%; object-fit: cover; background: #eee;">
                            </div>
                            <div>
                                <b>${m.name}</b> <span style="color:#7f8c8d; font-size:0.9em">@${m.handle || ''}</span>
                            </div>
                        </div>
                        <div>${m.text || ''}</div>
                        ${m.isImage ? `<div class="photo-container"><img src="${m.photo}" onclick="window.open('${m.photo}')" style="cursor:pointer"></div>` : ''}
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button class="btn" style="font-size:11px; padding:5px 10px;" onclick="sendReply('${m.chatId}', '${m.name}')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            <button class="btn" style="font-size:11px; padding:5px 10px; color:#ee5253" onclick="removeMessage('${m.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>`;
        });

        if (lastMsgsHtml !== newHtml) {
            container.innerHTML = newHtml;
            lastMsgsHtml = newHtml;
        }
    }

    window.renderVotes = () => {
        const container = document.getElementById('votesList');
        const filter = document.getElementById('filterMode').value;
        const votes = currentData.votes || {};
        
        let list = Object.keys(votes).map(id => ({id, ...votes[id]}));
        if(filter === 'correct') list = list.filter(v => v.votedFor === currentData.scorer);
        document.getElementById('vCount').textContent = `–í—Å–µ–≥–æ: ${list.length}`;

        let newHtml = '';
        list.reverse().forEach(v => {
            const isCorrect = v.votedFor === currentData.scorer;
            const voteAvatar = (v.photo && v.photo.length > 10) ? v.photo : tgLogo;

            newHtml += `
                <div class="vote-card ${isCorrect ? 'correct' : ''}">
                    <span style="position:absolute; top:5px; right:10px; cursor:pointer; color:#ccc" onclick="removeVote('${v.id}')">√ó</span>
                    <div style="width:60px; height:60px; margin: 0 auto; background: #eee; border-radius: 50%; overflow: hidden;">
                        <img src="${voteAvatar}" onerror="this.onerror=null; this.src='${tgLogo}'" style="width:60px; height:60px; object-fit: cover;">
                    </div>
                    <div style="font-weight:700; font-size:0.9rem; margin-top:8px;">${v.name}</div>
                    <div style="color:var(--sibir-blue); font-size:0.8rem; font-weight:600;">${v.votedFor}</div>
                    <button class="btn" style="width:100%; margin-top:10px; font-size:10px; padding:5px;" onclick="sendReply('${v.chatId}', '${v.name}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                </div>`;
        });

        if (lastVotesHtml !== newHtml) {
            container.innerHTML = newHtml;
            lastVotesHtml = newHtml;
        }
    }

    function renderPlayers() {
        const pList = document.getElementById('playersList');
        const pSelect = document.getElementById('goalScorer');
        const players = currentData.players || {};
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞
        const scrollPos = pList.scrollTop;
        
        pList.innerHTML = '';
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞, —Å–æ—Ö—Ä–∞–Ω—è—è —Ç–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä
        let optionsHtml = '<option value="">-- –ö–¢–û –ó–ê–ë–ò–õ? --</option>';
        for(let id in players) {
            pList.innerHTML += `<div class="player-tag">${players[id].name} <span onclick="removePlayer('${id}')" style="color:#ee5253; cursor:pointer; margin-left:5px">√ó</span></div>`;
            optionsHtml += `<option value="${players[id].name}" ${currentData.scorer === players[id].name ? 'selected' : ''}>${players[id].name}</option>`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º select —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (—á—Ç–æ–±—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Ñ–æ–∫—É—Å/–≤—ã–±–æ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ –±–∞–∑—ã)
        if (pSelect.innerHTML !== optionsHtml) {
             pSelect.innerHTML = optionsHtml;
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª
        pList.scrollTop = scrollPos;
    }
</script>
</body>
</html>
