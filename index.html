<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sibir Control Panel ‚Äî Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        :root {
            --sibir-blue: #05caff;
            --sibir-dark: #253566;
            --bg-body: #d8d8d8;
            --white: #ffffff;
            --gray: rgb(223, 223, 223);
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border-color:#253566;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            display: grid; 
            grid-template-columns: 350px 1fr; 
            gap: 20px; 
            padding: 20px; 
            height: 100vh;
            box-sizing: border-box;
        }

        .sidebar { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow-y: auto; 
            position: sticky; 
            top: 20px; 
            height: calc(100vh - 40px);
        }

        .main { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        h2 { 
            color: var(--sibir-dark); 
            font-size: 0.85rem; 
            font-weight: 800;
            margin: 25px 0 15px 0; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }
        h2::before {
            content: ""; display: inline-block; width: 4px; height: 16px; 
            background: var(--sibir-blue); margin-right: 8px; border-radius: 2px;
        }

        .btn { 
            padding: 12px 15px; border: none; border-radius: 12px; 
            font-weight: 600; font-size: 0.85rem; cursor: pointer; 
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
            gap: 8px; font-family: inherit;
        }
        .btn:active { transform: scale(0.98); }

        .btn-scene { background: #f8f9fa; color: var(--text-main); border: 1px solid var(--border-color); width: 48%; }
        .btn-scene.active { background: var(--sibir-blue) !important; color: white !important; border-color: var(--sibir-blue) !important; box-shadow: 0 4px 12px rgba(5, 202, 255, 0.3); }
        
        .btn-stop { width: 100%; background: #ff9f43; color: white; margin-bottom: 20px; font-size: 1rem; }
        .btn-stop.closed { background: #ee5253; }
        
        .btn-primary { background: var(--sibir-blue); color: white; width: 100%; }

        .tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .tab-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1rem; cursor: pointer; font-weight: 700; padding: 5px 10px; transition: 0.3s; }
        .tab-btn.active { color: var(--sibir-blue); border-bottom: 3px solid var(--sibir-blue); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        .message-item {
            display: flex; background: var(--gray); border-radius: 16px; margin-bottom: 15px; padding: 20px;
            border: 1px solid var(--white); gap: 20px; align-items: flex-start; transition: 0.3s;
        }

        .message-left { min-width: 140px; display: flex; flex-direction: column; gap: 10px; }
        .message-content { flex-grow: 1; }

        .photo-container { 
            margin-top: 10px; border-radius: 12px; overflow: hidden; border: 1px solid var(--white); 
            max-width: 400px;
        }
        .photo-container img { width: 100%; display: block; }

        input, select { 
            width: 100%; height: 45px; padding: 0 15px; background: #fff; 
            border: 1.5px solid var(--sibir-blue); color: var(--text-main); 
            border-radius: 12px; margin-bottom: 15px; font-family: inherit;
            font-size: 0.9rem; box-sizing: border-box; display: block; outline: none;
        }

        select {
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2305caff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 15px;
        }

        .votes-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .vote-card { 
            background: var(--gray); padding: 15px; border-radius: 16px; text-align: center; 
            border: 2px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative;
        }
        .vote-card.correct {background: #b8ffbe; border-color: #10ac84;}
        .vote-card img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-body); background: #fff; }
        
        .player-tag { 
            background: #edf2f7; padding: 5px 12px; margin: 3px; display: inline-block; 
            border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }

        .crop-container {
            max-width: 100%; height: 400px; background: #333;
            margin-bottom: 15px; border-radius: 12px; overflow: hidden; display: none;
        }
        .crop-container img { max-width: 100%; }
        
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .char-card { background: var(--gray); border-radius: 12px; overflow: hidden; border: 3px solid transparent; transition: 0.2s; }
        .char-card.active-char { border-color: #9ef01a; background: #fff; box-shadow: 0 0 15px rgba(24, 164, 14, 0.4); }
        .char-img { width: 100%; aspect-ratio: 8/9; object-fit: cover; display: block; background: #000; }
        .char-info { padding: 10px; }
        .char-name { font-weight: 700; font-size: 1rem; margin-bottom: 10px; text-align: center; }

        .upload-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .upload-box {
            background: white; border-radius: 20px; padding: 40px;
            text-align: center; min-width: 280px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º</h2>
    <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button id="mode-voting" class="btn btn-scene" style="width: 50%;" onclick="setActiveMode('voting')">üèí –®–∞–π–±–∞</button>
            <button id="mode-slideshow" class="btn btn-scene" style="width: 50%;" onclick="setActiveMode('slideshow')">üì∏ –°–ª–∞–π–¥</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button id="mode-lookslike" class="btn btn-scene" style="width: 50%;" onclick="setActiveMode('lookslike')">üëØ Looks Like Cam</button>
            <button id="mode-mvp" class="btn btn-scene" style="width: 50%;" onclick="setActiveMode('mvp')">üèÜ –ò–≥—Ä–æ–∫ –º–∞—Ç—á–∞</button>
        </div>
    </div>

    <div id="controls-voting">
        <h2>–°—Ü–µ–Ω—ã: –ü–µ—Ä–≤–∞—è —à–∞–π–±–∞</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="scene-announcement" class="btn btn-scene" onclick="setScene('announcement')">–ê–Ω–æ–Ω—Å</button>
            <button id="scene-qr" class="btn btn-scene" onclick="setScene('qr')">QR-–∫–æ–¥</button>
            <button id="scene-roulette" class="btn btn-scene" onclick="setScene('roulette')">–†—É–ª–µ—Ç–∫–∞</button>
            <button id="scene-winner" class="btn btn-scene" onclick="setScene('winner')">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
        </div>
        <button class="btn" style="width:100%; margin-top:10px; border: 1px solid var(--border-color); background:#05caff" onclick="pickWinnerManual()">üé≤ –ü–µ—Ä–µ–≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</button>
    </div>

    <div id="voting-mode-switch" style="display: none; margin-top: 20px;">
        <h2>–ü—Ä–∏–µ–º –≥–æ–ª–æ—Å–æ–≤</h2>
        <div style="display: flex; gap: 10px;">
            <button id="vote-first-goal" class="btn btn-scene" style="width: 50%;" onclick="setVotingMode('first_goal')">üèí –ü–µ—Ä–≤–∞—è —à–∞–π–±–∞</button>
            <button id="vote-mvp" class="btn btn-scene" style="width: 50%;" onclick="setVotingMode('match_mvp')">üèÜ –ò–≥—Ä–æ–∫ –º–∞—Ç—á–∞</button>
        </div>
        <button id="stopVotingBtn" class="btn btn-stop" style="margin-top: 10px;" onclick="toggleVoting()">üõë –°–¢–û–ü –ü–†–ò–ï–ú</button>
    </div>

    <div id="controls-slideshow" style="display: none;">
        <h2>–°—Ü–µ–Ω—ã: –°–ª–∞–π–¥-—à–æ—É</h2>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button id="scene-slideshow-qr" class="btn btn-scene" onclick="setScene('slideshow_qr')">QR-–∫–æ–¥—ã</button>
            <button id="scene-slideshow-photo_feed" class="btn btn-scene" onclick="setScene('slideshow_photo')">–°–ª–∞–π–¥-—à–æ—É</button>
        </div>
    </div>

    <div id="controls-lookslike" style="display: none;">
        <h2>–°—Ü–µ–Ω—ã: Looks Like</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="scene-ll-announcement" class="btn btn-scene" onclick="setScene('announcement')">–ê–Ω–æ–Ω—Å</button>
            <button id="scene-ll-character" class="btn btn-scene" onclick="setScene('character')">–ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button id="scene-ll-fan" class="btn btn-scene" onclick="setScene('fan')">–ë–æ–ª–µ–ª—å—â–∏–∫</button>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 10px; line-height: 1.3;">
            üí° –í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–Ω–æ–ø–∫–æ–π "–í –≠–§–ò–†" –≤ –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ —Å—Ü–µ–Ω—É "–ü–µ—Ä—Å–æ–Ω–∞–∂".
        </p>
    </div>

    <!-- ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û: –°—Ü–µ–Ω—ã MVP ‚Äî —É–±—Ä–∞–Ω—ã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã, –¥–æ–±–∞–≤–ª–µ–Ω—ã Winline –∏ –ê–Ω–æ–Ω—Å -->
    <div id="controls-mvp" style="display: none;"> 
        <h2>–°—Ü–µ–Ω—ã: –ò–≥—Ä–æ–∫ –º–∞—Ç—á–∞</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button id="scene-mvp-winline_logo" class="btn btn-scene" onclick="setScene('winline_logo')">üü° Winline</button>
            <button id="scene-mvp-announcement" class="btn btn-scene" onclick="setScene('announcement')">üì¢ –ê–Ω–æ–Ω—Å</button>
            <button id="scene-mvp-qr" class="btn btn-scene" onclick="setScene('qr')">QR-–∫–æ–¥</button>
            <button id="scene-mvp-winner" class="btn btn-scene" onclick="setScene('winner')">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
        </div>
    </div>

    <h2>–§–æ–Ω –æ–≤–µ—Ä–ª–µ—è</h2>
    <input type="text" id="bgUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ .webm –∏–ª–∏ .jpg">
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="btn btn-scene" style="width: 48%" onclick="updateBg()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-scene" style="width: 48%" onclick="removeBackground()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>   
    
    <div id="players-controls">
        <h2>–ê–≤—Ç–æ—Ä –≥–æ–ª–∞</h2>
        <select id="goalScorer" onchange="setScorer(this.value)"></select>
        <h2>–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤</h2>
        <input type="text" id="pName" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
        <input type="text" id="pKeys" placeholder="–ù–æ–º–µ—Ä, —Ñ–∞–º–∏–ª–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
        <button class="btn btn-primary" style="background: var(--sibir-dark);" onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        <div id="playersList" style="margin-top:15px;"></div>
    </div>
</div>

<div class="main">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('votes')">–ì–æ–ª–æ—Å–∞</button>
        <button class="tab-btn" onclick="switchTab('chat')">–≠—Ñ–∏—Ä (–ß–∞—Ç)</button>
        <button class="tab-btn" onclick="switchTab('lookslike')">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (Looks Like)</button>
        <button class="tab-btn" onclick="switchTab('mvp')">–ò–≥—Ä–æ–∫ –º–∞—Ç—á–∞</button>
    </div>

    <div id="tab-votes" class="tab-content active">
        <div style="justify-content: space-between; display: flex; align-items: center; margin-bottom: 20px;">
            <select id="filterMode" onchange="renderVotes()" style="width: 250px; margin: 0;">
                <option value="all">–í—Å–µ –≥–æ–ª–æ—Å–∞</option>
                <option value="correct">–¢–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</option>
            </select>
            <div style="display: flex; align-items: center; gap: 15px;">
                <b id="vCount" style="color: var(--sibir-blue);"></b>
                <button class="btn" style="background: #ee5253; color: white;" onclick="resetVotes()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>
        <div id="votesList" class="votes-list"></div>
    </div>

    <div id="tab-chat" class="tab-content">
        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 20px;">
            <button class="btn" style="background: #ff9f43; color: white;" onclick="clearApprovedPhotos()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç—Ñ–∏—Ä</button>
            <button class="btn" style="background: #ee5253; color: white;" onclick="clearChat()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
        </div>
        <div id="messagesList"></div>
    </div>

    <div id="tab-lookslike" class="tab-content">
        <div style="background: #f1f2f6; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
            <h3 style="margin-top:0">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
            <input type="text" id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
            <input type="file" id="charFile" accept="image/*" style="padding-top: 10px;">
            <div id="cropWrapper" class="crop-container">
                <img id="imageToCrop" src="">
            </div>
            <button id="btnSaveChar" class="btn btn-primary" onclick="saveCharacter()" style="display: none;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">–°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h3>
            <button class="btn" style="background: #ee5253; color: white;" onclick="clearAllCharacters()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
        </div>
        <div id="charactersList" class="char-grid"></div>
    </div>

    <div id="tab-mvp" class="tab-content">
        <div style="background: #f1f2f6; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
            <h3 style="margin: 0 0 15px 0;">–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤ (—Ñ–æ—Ç–æ –¥–ª—è –æ–≤–µ—Ä–ª–µ—è)</h3>
            <div id="mvpPlayersList"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">–ì–æ–ª–æ—Å–∞ –∑–∞ –∏–≥—Ä–æ–∫–∞ –º–∞—Ç—á–∞</h3>
            <div style="display: flex; align-items: center; gap: 15px;">
                <b id="mvpCount" style="color: var(--sibir-blue);"></b>
                <button class="btn" style="background: #ee5253; color: white;" onclick="resetMvpVotes()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
        </div>
        <div id="mvpResultsList"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
        authDomain: "arenawork-94e68.firebaseapp.com",
        databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
        projectId: "arenawork-94e68",
        storageBucket: "arenawork-94e68.firebasestorage.app",   
        messagingSenderId: "504372844993",
        appId: "1:504372844993:web:1783bb75879ee074953740"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentData = {};
    const tgLogo = "media/tg_logo.png";
    let cropper;
    let editingCharId = null;

    const UPLOAD_URL = 'http://localhost:3000/upload';

    async function uploadViaBot(blob, folder) {
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('folder', folder);
        const res = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.url) throw new Error('–ù–µ—Ç URL –≤ –æ—Ç–≤–µ—Ç–µ');
        return data.url;
    }

    function showUploadOverlay(text) {
        const el = document.createElement('div');
        el.className = 'upload-overlay';
        el.id = 'upload-overlay';
        el.innerHTML = `<div class="upload-box">
            <div style="font-size:2rem;margin-bottom:10px">‚òÅÔ∏è</div>
            <div style="font-weight:700;font-size:1.1rem">${text}</div>
            <div style="color:#999;font-size:0.85rem;margin-top:8px">–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ Yandex Cloud...</div>
        </div>`;
        document.body.appendChild(el);
    }

    function hideUploadOverlay(success = true) {
        const el = document.getElementById('upload-overlay');
        if (!el) return;
        el.querySelector('.upload-box').innerHTML = `
            <div style="font-size:2.5rem">${success ? '‚úÖ' : '‚ùå'}</div>
            <div style="font-weight:700;margin-top:10px">${success ? '–ì–æ—Ç–æ–≤–æ!' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</div>`;
        setTimeout(() => el.remove(), 1000);
    }

    window.toggleVoting = () => {
        const votingMode = currentData.votingMode || 'first_goal';
        const isAccepting = votingMode === 'first_goal' ? currentData.acceptingVotes : currentData.acceptingMvpVotes;
        if (votingMode === 'first_goal') {
            set(ref(db, 'competition/acceptingVotes'), !isAccepting);
        } else {
            set(ref(db, 'competition/acceptingMvpVotes'), !isAccepting);
        }
    };
    
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        if (tab === 'mvp') renderMvpPlayers();
    };

    window.setActiveMode = (mode) => {
        set(ref(db, 'competition/activeMode'), mode);
        if(mode === 'lookslike') window.switchTab('lookslike');
    };

    window.setVotingMode = (mode) => {
        set(ref(db, 'competition/acceptingVotes'), false);
        set(ref(db, 'competition/acceptingMvpVotes'), false);
        set(ref(db, 'competition/votingMode'), mode);
        if (mode === 'first_goal') {
            set(ref(db, 'competition/acceptingVotes'), true);
        } else {
            set(ref(db, 'competition/acceptingMvpVotes'), true);
        }
    };

    window.resetMvpVotes = () => {
        if(confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ –∏–≥—Ä–æ–∫–∞ –º–∞—Ç—á–∞?")) remove(ref(db, 'competition/mvpVotes'));
    };
    
    window.setScene = (scene) => {
        const mode = currentData.activeMode || 'voting';
        if (mode === 'voting') {
            if (scene === 'roulette') {
                const votes = currentData.votes || {};
                const scorer = currentData.scorer;
                if (!scorer) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–≤—Ç–æ—Ä–∞ –≥–æ–ª–∞!"); return; }
                const luckyOnes = Object.values(votes).filter(v => v.votedFor === scorer);
                set(ref(db, 'competition/votingState'), scene);
                if (luckyOnes.length > 0) {
                    setTimeout(() => {
                        const winner = luckyOnes[Math.floor(Math.random() * luckyOnes.length)];
                        winner.selectionId = Date.now();
                        set(ref(db, 'competition/winner'), winner);
                    }, 600);
                }
            } else {
                set(ref(db, 'competition/votingState'), scene);
            }
        } else if (mode === 'slideshow') {
            set(ref(db, 'competition/slideshowState'), scene);
        } else if (mode === 'lookslike') {
            if (scene === 'character') {
                const pending = currentData.lookslike?.pendingCharacter;
                if (pending) set(ref(db, 'competition/lookslike/activeCharacter'), pending);
            }
            set(ref(db, 'competition/lookslikeState'), scene);
        } else if (mode === 'mvp') {
            set(ref(db, 'competition/mvpState'), scene);
        }
    };

    window.pickWinnerManual = () => {
        const votes = currentData.votes || {};
        const scorer = currentData.scorer;
        if (!scorer) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–≤—Ç–æ—Ä–∞ –≥–æ–ª–∞!"); return; }
        const luckyOnes = Object.values(votes).filter(v => v.votedFor === scorer);
        if (luckyOnes.length > 0) {
            const winner = luckyOnes[Math.floor(Math.random() * luckyOnes.length)];
            winner.selectionId = Date.now(); 
            set(ref(db, 'competition/winner'), winner);
            alert("–ù–æ–≤—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å: " + winner.name);
        } else {
            alert("–ù–∏–∫—Ç–æ –Ω–µ —É–≥–∞–¥–∞–ª —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞!");
        }
    };

    window.updateBg = () => { const url = document.getElementById('bgUrl').value; if(url) set(ref(db, 'competition/background'), url); };
    window.removeBackground = () => {
        if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ–Ω –Ω–∞ –æ–≤–µ—Ä–ª–µ–µ?")) {
            set(ref(db, 'competition/background'), null);
            document.getElementById('bgUrl').value = '';
        }
    };

    window.togglePhotoSelection = (id, status) => set(ref(db, `competition/allMessages/${id}/approved`), !status);
    window.removeMessage = (id) => confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?") && remove(ref(db, `competition/allMessages/${id}`));
    window.clearChat = () => confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π?") && remove(ref(db, 'competition/allMessages'));
    window.resetVotes = () => confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –≥–æ–ª–æ—Å–æ–≤ (–ü–µ—Ä–≤–∞—è —à–∞–π–±–∞)?") && remove(ref(db, 'competition/votes'));
    
    window.clearApprovedPhotos = () => {
        if (confirm("–£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ —ç—Ñ–∏—Ä–∞?")) {
            const msgs = currentData.allMessages || {};
            const updates = {};
            for(let id in msgs) {
                if(msgs[id].approved) updates[`competition/allMessages/${id}/approved`] = false;
            }
            if(Object.keys(updates).length) update(ref(db), updates);
        }
    };

    window.clearAllCharacters = () => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –±–∞–∑—ã?")) remove(ref(db, 'competition/lookslike/characters'));
    };

    window.sendReply = (chatId, name) => {
        if (!chatId) { alert("–ù–µ—Ç Chat ID. –ù–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å."); return; }
        const msg = prompt(`–û—Ç–≤–µ—Ç –¥–ª—è ${name}:`);
        if (msg) push(ref(db, 'competition/replies'), { chatId, text: msg });
    };

    window.addPlayer = () => {
        const name = document.getElementById('pName').value;
        const keywords = document.getElementById('pKeys').value;
        if(name && keywords) {
            push(ref(db, 'competition/players'), { name, keywords });
            document.getElementById('pName').value = '';
            document.getElementById('pKeys').value = '';
        }
    };

    window.removePlayer = (id) => remove(ref(db, `competition/players/${id}`));
    window.setScorer = (val) => set(ref(db, 'competition/scorer'), val);
    window.removeVote = (id) => remove(ref(db, `competition/votes/${id}`));

    window.uploadPlayerPhoto = (playerId) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/png,image/jpeg,image/jpg';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showUploadOverlay('üì∑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ –∏–≥—Ä–æ–∫–∞...');
            try {
                const photoUrl = await uploadViaBot(file, 'players');
                await update(ref(db, `competition/players/${playerId}`), { photo: photoUrl });
                hideUploadOverlay(true);
                renderMvpPlayers();
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                hideUploadOverlay(false);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message + '\n–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (–ø–æ—Ä—Ç 3000)');
            }
        };
        input.click();
    };

    window.deletePlayerPhoto = (playerId) => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –∏–≥—Ä–æ–∫–∞?')) {
            update(ref(db, `competition/players/${playerId}`), { photo: null });
        }
    };

    document.getElementById('charFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const image = document.getElementById('imageToCrop');
                image.src = event.target.result;
                document.getElementById('cropWrapper').style.display = 'block';
                document.getElementById('btnSaveChar').style.display = 'block';
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, { aspectRatio: 8 / 9, viewMode: 1 });
            };
            reader.readAsDataURL(file);
        }
    });

    window.saveCharacter = async () => {
        const name = document.getElementById('charName').value;
        if (!name) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!"); return; }
        if (!cropper) { alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!"); return; }
        showUploadOverlay('üëØ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...');
        try {
            const canvas = cropper.getCroppedCanvas({ height: 800 });
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
            const imageUrl = await uploadViaBot(blob, 'characters');
            await push(ref(db, 'competition/lookslike/characters'), { name, image: imageUrl });
            hideUploadOverlay(true);
            cropper.destroy(); cropper = null;
            document.getElementById('charName').value = '';
            document.getElementById('charFile').value = '';
            document.getElementById('imageToCrop').src = '';
            document.getElementById('cropWrapper').style.display = 'none';
            document.getElementById('btnSaveChar').style.display = 'none';
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞:', err);
            hideUploadOverlay(false);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message + '\n–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (–ø–æ—Ä—Ç 3000)');
        }
    };

    window.setActiveCharacter = (id) => set(ref(db, 'competition/lookslike/pendingCharacter'), id);
    window.deleteCharacter = (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞?")) remove(ref(db, `competition/lookslike/characters/${id}`));
    };

    // =============================================
    // ‚úÖ –û–ë–ù–û–í–õ–ï–ù–û: –∫–∞—Ä—Ç–∞ —Å—Ü–µ–Ω MVP
    // =============================================
    function updateActiveSceneButtons() {
        const mode = currentData.activeMode || 'voting';
        document.querySelectorAll('[id^="scene-"]').forEach(btn => btn.classList.remove('active'));
        if (mode === 'voting') {
            const btn = document.getElementById(`scene-${currentData.votingState || 'announcement'}`);
            if (btn) btn.classList.add('active');
        } else if (mode === 'slideshow') {
            const map = { slideshow_qr: 'scene-slideshow-qr', slideshow_photo: 'scene-slideshow-photo_feed' };
            const btn = document.getElementById(map[currentData.slideshowState]);
            if (btn) btn.classList.add('active');
        } else if (mode === 'lookslike') {
            const map = { announcement: 'scene-ll-announcement', character: 'scene-ll-character', fan: 'scene-ll-fan' };
            const btn = document.getElementById(map[currentData.lookslikeState]);
            if (btn) btn.classList.add('active');
        } else if (mode === 'mvp') {
            // winline_logo –∏ announcement ‚Äî –Ω–æ–≤—ã–µ —Å—Ü–µ–Ω—ã; qr –∏ winner ‚Äî —Å—Ç–∞—Ä—ã–µ
            const map = {
                winline_logo: 'scene-mvp-winline_logo',
                announcement: 'scene-mvp-announcement',
                qr:           'scene-mvp-qr',
                winner:       'scene-mvp-winner'
            };
            const btn = document.getElementById(map[currentData.mvpState]);
            if (btn) btn.classList.add('active');
        }
    }

    onValue(ref(db, 'competition'), (snapshot) => {
        currentData = snapshot.val() || {};
        updateActiveSceneButtons();

        const mode = currentData.activeMode || 'voting';
        document.getElementById('mode-voting').classList.toggle('active', mode === 'voting');
        document.getElementById('mode-slideshow').classList.toggle('active', mode === 'slideshow');
        document.getElementById('mode-lookslike').classList.toggle('active', mode === 'lookslike');
        document.getElementById('mode-mvp').classList.toggle('active', mode === 'mvp');
        
        ['controls-voting','controls-slideshow','controls-lookslike','controls-mvp','players-controls']
            .forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById('voting-mode-switch').style.display = 'none';

        if (mode === 'voting') {
            document.getElementById('controls-voting').style.display = 'block';
            document.getElementById('players-controls').style.display = 'block';
            document.getElementById('voting-mode-switch').style.display = 'block';
        } else if (mode === 'slideshow') {
            document.getElementById('controls-slideshow').style.display = 'block';
        } else if (mode === 'lookslike') {
            document.getElementById('controls-lookslike').style.display = 'block';
        } else if (mode === 'mvp') {
            document.getElementById('controls-mvp').style.display = 'block';
            document.getElementById('players-controls').style.display = 'block';
            document.getElementById('voting-mode-switch').style.display = 'block';
        }

        const votingMode = currentData.votingMode || 'first_goal';
        const isAccepting = votingMode === 'first_goal' ? currentData.acceptingVotes : currentData.acceptingMvpVotes;
        document.getElementById('vote-first-goal')?.classList.toggle('active', votingMode === 'first_goal');
        document.getElementById('vote-mvp')?.classList.toggle('active', votingMode === 'match_mvp');

        const stopBtn = document.getElementById('stopVotingBtn');
        if (stopBtn) {
            stopBtn.textContent = isAccepting ? "üõë –°–¢–û–ü –ü–†–ò–ï–ú" : "‚ñ∂Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–ò–ï–ú";
            stopBtn.classList.toggle('closed', !isAccepting);
        }

        renderPlayers(); 
        renderVotes(); 
        renderMessages();
        renderCharacters();
        renderMvpResults();
    });

    let lastMsgsHtml = "";
    let lastVotesHtml = "";

    function renderCharacters() {
        const container = document.getElementById('charactersList');
        const chars = currentData.lookslike?.characters || {};
        const pendingId = currentData.lookslike?.pendingCharacter;
        const activeId = currentData.lookslike?.activeCharacter;
        let html = '';
        for (let id in chars) {
            const char = chars[id];
            const isPending = (id === pendingId);
            const isActiveInAir = (id === activeId);
            const isEditing = (id === editingCharId);
            html += `
            <div class="char-card ${isActiveInAir ? 'active-char' : ''}">
                <img src="${char.image}" class="char-img">
                <div class="char-info">
                    ${isEditing ? 
                        `<input type="text" id="edit-name-${id}" value="${char.name}" style="margin-bottom: 5px; height: 35px;">
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <button class="btn btn-primary" style="flex:1; padding:5px; background:#10ac84" onclick="saveEditName('${id}')">üíæ</button>
                            <button class="btn" style="flex:1; padding:5px; background:#ee5253; color:white" onclick="cancelEditName()">‚úñ</button>
                        </div>` 
                        : 
                        `<div class="char-name" style="display:flex; justify-content:center; align-items:center; gap:10px;">
                            <span>${char.name}</span>
                            <span style="cursor:pointer; font-size:12px; opacity:0.5" onclick="startEditName('${id}')">‚úèÔ∏è</span>
                        </div>`
                    }
                    <button class="btn" style="width:100%; margin-bottom:5px; background: ${isPending ? '#9ef01a' : '#ecf0f1'}; color: ${isPending ? 'white' : 'black'}" onclick="setActiveCharacter('${id}')">
                        ${isPending ? 'üì∫ –í –≠–§–ò–†–ï' : 'üì∫ –í –≠–§–ò–†'}
                    </button>
                    ${isActiveInAir ? '<div style="font-size:10px; color:green; text-align:center">‚óè –°–ï–ô–ß–ê–° –í OBS</div>' : ''}
                    <button class="btn" style="width:100%; background:#fab1a0; color:#c0392b; font-size: 0.8rem; margin-top:5px" onclick="deleteCharacter('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }

    function renderMessages() {
        const container = document.getElementById('messagesList');
        const msgs = currentData.allMessages || {};
        let list = Object.keys(msgs).map(id => ({id, ...msgs[id]}));
        list.sort((a, b) => b.timestamp - a.timestamp);
        let newHtml = '';
        list.forEach(m => {
            const userAvatar = (m.userPhoto && m.userPhoto.length > 10) ? m.userPhoto : tgLogo;
            const date = m.timestamp ? new Date(m.timestamp) : new Date();
            const timeStr = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');
            newHtml += `    
                <div class="message-item" style="border-left: 5px solid ${m.approved ? '#10ac84' : '#d1d8e0'}">
                    <div class="message-left">
                        <button class="btn" style="width:100%; background:${m.approved ? '#10ac84' : '#f1f2f6'}; color:${m.approved ? 'white' : 'black'}" 
                                onclick="togglePhotoSelection('${m.id}', ${m.approved})">
                            ${m.approved ? '‚úÖ –í –≠–§–ò–†–ï' : 'üì∫ –í –≠–§–ò–†'}
                        </button>
                        <span style="font-size: 11px; color: #666; text-align: center; margin-top: 5px;">${timeStr}</span>
                    </div>
                    <div class="message-content">
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                            <div style="width:40px; height:40px; flex-shrink:0;">
                                <img src="${userAvatar}" onerror="this.onerror=null; this.src='${tgLogo}'" style="width:40px; height:40px; border-radius:50%; object-fit: cover; background: #eee;">
                            </div>
                            <div><b>${m.name}</b> <span style="color:#7f8c8d; font-size:0.9em">@${m.handle || ''}</span></div>
                        </div>
                        <div>${m.text || ''}</div>
                        ${m.isImage ? `<div class="photo-container"><img src="${m.photo}" onclick="window.open('${m.photo}')" style="cursor:pointer"></div>` : ''}
                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button class="btn" style="font-size:11px; padding:5px 10px;" onclick="sendReply('${m.chatId}', '${m.name}')">‚Ü© –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                            <button class="btn" style="font-size:11px; padding:5px 10px; color:#ee5253" onclick="removeMessage('${m.id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>`;
        });
        if (lastMsgsHtml !== newHtml) { container.innerHTML = newHtml; lastMsgsHtml = newHtml; }
    }

    function renderMvpResults() {
        const container = document.getElementById('mvpResultsList');
        const votes = currentData.mvpVotes || {};
        const voteCounts = {};
        const votersList = {};
        Object.entries(votes).forEach(([userId, vote]) => {
            const player = vote.votedFor;
            voteCounts[player] = (voteCounts[player] || 0) + 1;
            if (!votersList[player]) votersList[player] = [];
            votersList[player].push(vote);
        });
        const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);
        document.getElementById('mvpCount').textContent = `–í—Å–µ–≥–æ: ${Object.keys(votes).length} –≥–æ–ª–æ—Å–æ–≤`;
        let html = '<div class="votes-list">';
        sorted.forEach(([player, count], index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
            const voters = votersList[player] || [];
            const votersPreview = voters.slice(0, 3).map(v => v.name).join(', ');
            const moreVoters = voters.length > 3 ? ` –∏ –µ—â—ë ${voters.length - 3}` : '';
            html += `
                <div class="vote-card ${index === 0 ? 'correct' : ''}" style="cursor: pointer" onclick="showVotersPopup('${player}')">
                    <div style="font-size: 36px;">${medal}</div>
                    <div style="font-weight:700; font-size:1.2rem; margin-top:8px;">${player}</div>
                    <div style="color:var(--sibir-blue); font-size:2rem; font-weight:800; margin-top:5px;">${count}</div>
                    <div style="color:#7f8c8d; font-size:0.8rem;">${count === 1 ? '–≥–æ–ª–æ—Å' : count < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤'}</div>
                    <div style="font-size:0.7rem; color:#999; margin-top:8px; line-height:1.2;">${votersPreview}${moreVoters}</div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
        window.mvpVotersData = votersList;
    }

    function renderMvpPlayers() {
        const container = document.getElementById('mvpPlayersList');
        if (!container) return;
        const players = currentData.players || {};
        const votes = currentData.mvpVotes || {};
        const voteCounts = {};
        Object.values(votes).forEach(vote => {
            voteCounts[vote.votedFor] = (voteCounts[vote.votedFor] || 0) + 1;
        });
        let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px;">';
        for (let id in players) {
            const player = players[id];
            const voteCount = voteCounts[player.name] || 0;
            const hasPhoto = player.photo && player.photo.startsWith('http');
            html += `
                <div style="background: var(--white); border-radius: 12px; padding: 15px; border: 2px solid ${hasPhoto ? '#10ac84' : '#ddd'};">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="font-weight: 700; font-size: 1rem;">${player.name}</div>
                        <div style="background: var(--sibir-blue); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">${voteCount}</div>
                    </div>
                    <div style="width: 100%; aspect-ratio: 8/9; background: #f0f0f0; border-radius: 8px; overflow: hidden; margin-bottom: 10px; display: flex; align-items: center; justify-content: center;">
                        ${hasPhoto ? 
                            `<img src="${player.photo}" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">` : 
                            `<span style="color: #999; font-size: 3rem;">üë§</span>`
                        }
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button class="btn" style="flex: 1; font-size: 0.75rem; padding: 8px; background: ${hasPhoto ? '#ff9f43' : '#10ac84'}; color: white;" 
                                onclick="uploadPlayerPhoto('${id}')">
                            ${hasPhoto ? 'üîÑ –ó–∞–º–µ–Ω–∏—Ç—å' : 'üì∑ –î–æ–±–∞–≤–∏—Ç—å'}
                        </button>
                        ${hasPhoto ? `<button class="btn" style="padding: 8px; background: #ee5253; color: white; font-size: 0.75rem;" onclick="deletePlayerPhoto('${id}')">üóëÔ∏è</button>` : ''}
                    </div>
                </div>`;
        }
        html += '</div>';
        container.innerHTML = html;
    }

    window.showVotersPopup = (player) => {
        const voters = window.mvpVotersData[player] || [];
        const list = voters.map(v => `${v.name} (@${v.handle || '–±–µ–∑ –Ω–∏–∫–∞'})`).join('\n');
        alert(`–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ ${player}:\n\n${list}`);
    };

    window.startEditName = (id) => { editingCharId = id; renderCharacters(); };
    window.cancelEditName = () => { editingCharId = null; renderCharacters(); };
    window.saveEditName = (id) => {
        const newName = document.getElementById(`edit-name-${id}`).value;
        if (!newName) { alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"); return; }
        update(ref(db, `competition/lookslike/characters/${id}`), { name: newName })
            .then(() => { editingCharId = null; });
    };

    window.renderVotes = () => {
        const container = document.getElementById('votesList');
        const filter = document.getElementById('filterMode').value;
        const votes = currentData.votes || {};
        let list = Object.keys(votes).map(id => ({id, ...votes[id]}));
        if(filter === 'correct') list = list.filter(v => v.votedFor === currentData.scorer);
        document.getElementById('vCount').textContent = `–í—Å–µ–≥–æ: ${list.length}`;
        let newHtml = '';
        list.reverse().forEach(v => {
            const isCorrect = v.votedFor === currentData.scorer;
            const voteAvatar = (v.photo && v.photo.length > 10) ? v.photo : tgLogo;
            newHtml += `
                <div class="vote-card ${isCorrect ? 'correct' : ''}">
                    <span style="position:absolute; top:5px; right:10px; cursor:pointer; color:#ccc" onclick="removeVote('${v.id}')">√ó</span>
                    <div style="width:60px; height:60px; margin: 0 auto; background: #eee; border-radius: 50%; overflow: hidden;">
                        <img src="${voteAvatar}" onerror="this.onerror=null; this.src='${tgLogo}'" style="width:60px; height:60px; object-fit: cover;">
                    </div>
                    <div style="font-weight:700; font-size:0.9rem; margin-top:8px;">${v.name}</div>
                    <div style="color:var(--sibir-blue); font-size:0.8rem; font-weight:600;">${v.votedFor}</div>
                    <button class="btn" style="width:100%; margin-top:10px; font-size:10px; padding:5px;" onclick="sendReply('${v.chatId}', '${v.name}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
                </div>`;
        });
        if (lastVotesHtml !== newHtml) { container.innerHTML = newHtml; lastVotesHtml = newHtml; }
    }

    function renderPlayers() {
        const pList = document.getElementById('playersList');
        const pSelect = document.getElementById('goalScorer');
        const players = currentData.players || {};
        const scrollPos = pList.scrollTop;
        pList.innerHTML = '';
        let optionsHtml = '<option value="">-- –ö–¢–û –ó–ê–ë–ò–õ? --</option>';
        for(let id in players) {
            const player = players[id];
            pList.innerHTML += `
                <div class="player-tag" style="display: inline-flex; align-items: center; gap: 5px;">
                    ${player.name}
                    <span onclick="removePlayer('${id}')" style="color:#ee5253; cursor:pointer; margin-left:3px">√ó</span>
                </div>`;
            optionsHtml += `<option value="${player.name}" ${currentData.scorer === player.name ? 'selected' : ''}>${player.name}</option>`;
        }
        if (pSelect.innerHTML !== optionsHtml) pSelect.innerHTML = optionsHtml;
        pList.scrollTop = scrollPos;
    }
</script>
</body>
</html>
