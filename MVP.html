<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <style>
        #bg-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1; 
            transition: opacity 1s ease-in-out;
            background-color: transparent;
        }
        @font-face {
            font-family: 'MyCustomFont';
            src: url('fonts/PFDinTextCondPro-Bold.ttf') format('truetype');
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); }
            50% { transform: scale(1.03); text-shadow: 0 0 50px rgba(0, 242, 255, 0.9); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: url('media/BG.png') center/cover no-repeat; font-family: 'MyCustomFont', sans-serif; color: white; }
        
        .scene {
            position: absolute; 
            width: 100%; 
            height: 100%;
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.8s;
        }

        .scene.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
            z-index: 5;
        }

        h1 { font-size: 80px; text-transform: uppercase; text-shadow: 4px 4px 15px rgba(0,0,0,0.8); margin: 20px; }

        /* --- СЦЕНЫ С ВИДЕО --- */
        .video-scene video {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* --- СЦЕНА QR --- */
        .qr-row { display: flex; gap: 100px; justify-content: center; align-items: flex-start; }
        .qr-item { display: flex; flex-direction: column; align-items: center; }
        .qr-item img { width: 700px; border: 10px solid white; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* --- СЦЕНА ПОБЕДИТЕЛЯ --- */
        #winner {
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 0;
            padding: 0;
        }

        .winner-photo-container {
            height: 100%;
            width: 50%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            flex-shrink: 0;
            align-self: flex-end;
        }

        .winner-photo {
            height: 100%;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            object-position: bottom center;
            transition: opacity 0.5s ease;
        }

        .winner-photo.loading {
            opacity: 0;
        }

        .photo-placeholder {
            width: 60%;
            height: 70%;
            border-radius: 20px;
            background: linear-gradient(
                90deg,
                rgba(5, 202, 255, 0.05) 25%,
                rgba(5, 202, 255, 0.15) 50%,
                rgba(5, 202, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            align-self: center;
        }

        .winner-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 0 50px;
            align-self: center;
        }

        .winner-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .winner-player-name {
            font-size: 90px;
            font-weight: bold;
            text-shadow: 0 0 30px rgba(5, 202, 255, 0.9);
            line-height: 1;
            text-align: center;
            text-transform: uppercase; 
            transform: skewX(-8deg);
            color: white;
        }

        .winner-made-difference {
            font-size: 130px;
            font-weight: bold;
            line-height: 1;
            text-align: center;
            margin-top: 20px;
            transform: skewX(-8deg);
        }

        .winner-made-difference .white {
            color: white;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
        }

        .winner-made-difference .orange {
            color: rgb(255, 106, 19);
            text-shadow: 0 0 30px rgba(255, 107, 53, 0.8);
        }

        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; transition: opacity 1s ease-in-out; }
    </style>
</head>
<body>
    <div id="bg-layer"></div>

    <!-- СЦЕНА: Логотип Winline -->
    <div id="winline_logo" class="scene video-scene">
        <video id="video-winline-logo" autoplay muted playsinline>
            <source src="media/WINLINE_logo.webm" type="video/webm">
        </video>
    </div>

    <!-- СЦЕНА: Анонс -->
    <div id="announcement" class="scene video-scene">
        <video id="video-announcement" autoplay muted playsinline>
            <source src="media/WINLINE_anons.webm" type="video/webm">
        </video>
    </div>

    <!-- СЦЕНА: QR -->
    <div id="qr" class="scene">
        <div class="qr-row">
            <div class="qr-item"><img src="media/telegramqr.png"></div>
            <div class="qr-item"><img src="media/max.jpg"></div>
        </div>
        <h1 style="text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); font-size: 160px; animation: pulse-glow 2s ease-in-out infinite;">
            Голосуй за игрока матча!
        </h1>
    </div>

    <!-- СЦЕНА: Победитель -->
    <div id="winner" class="scene">
        <div id="winner-photo" class="winner-photo-container"></div>
        <div class="winner-info">
            <div id="winner-display" class="winner-content"></div>
        </div>
    </div>

    <div id="bg-video">
        <source src="media/BG.png" type="image/png">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
            authDomain: "arenawork-94e68.firebaseapp.com",
            databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
            projectId: "arenawork-94e68",
            storageBucket: "arenawork-94e68.firebasestorage.app",
            messagingSenderId: "504372844993",
            appId: "1:504372844993:web:1783bb75879ee074953740"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const bgLayer = document.getElementById('bg-layer');
        const bgVideo = document.getElementById('bg-video');
        const imageCache = new Set();

        // Видео-элементы для управления воспроизведением
        const videoScenes = {
            winline_logo: document.getElementById('video-winline-logo'),
            announcement: document.getElementById('video-announcement'),
        };

        function preloadImage(src) {
            if (!src || imageCache.has(src)) return Promise.resolve();
            imageCache.add(src);
            return new Promise((resolve) => {
                const img = new Image();
                img.onload  = resolve;
                img.onerror = resolve;
                img.src = src;
            });
        }

        function preloadAllAssets(data) {
            const urls = [
                'media/telegramqr.png',
                'media/max.jpg',
                data.background,
            ];
            if (data.players) {
                Object.values(data.players).forEach(p => {
                    if (p.photo) urls.push(p.photo);
                });
            }
            urls.forEach(url => preloadImage(url));
        }

        let lastScene = "";

        onValue(ref(db, 'competition'), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            preloadAllAssets(data);

            const currentScene = data.mvpState || 'winline_logo';

            // Управление фоном
            if (data.background && data.background.trim() !== "") {
                bgLayer.style.backgroundImage = `url('${data.background}')`;
                bgLayer.style.opacity = "1";
                bgVideo.style.opacity = "0";
            } else {
                bgLayer.style.opacity = "0";
                bgVideo.style.opacity = "1";
            }

            if (currentScene !== lastScene) {
                // Подготовка контента до показа
                if (currentScene === 'winner') {
                    displayWinner(data.mvpVotes, data.players);
                }

                // Пауза всех видео, затем запуск нужного
                Object.entries(videoScenes).forEach(([key, videoEl]) => {
                    if (videoEl) {
                        if (key === currentScene) {
                            videoEl.currentTime = 0;
                            videoEl.play().catch(() => {});
                        } else {
                            videoEl.pause();
                        }
                    }
                });

                document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
                const target = document.getElementById(currentScene);
                if (target) target.classList.add('active');

                lastScene = currentScene;
            }
        });

        function displayWinner(votes, players) {
            const photoContainer = document.getElementById('winner-photo');
            const infoContainer  = document.getElementById('winner-display');

            if (!votes) {
                infoContainer.innerHTML = '<p style="font-size: 48px;">Нет голосов</p>';
                photoContainer.innerHTML = '';
                return;
            }

            const voteCounts = {};
            Object.values(votes).forEach(vote => {
                const player = vote.votedFor;
                voteCounts[player] = (voteCounts[player] || 0) + 1;
            });

            const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);
            if (sorted.length === 0) return;

            const [winnerName] = sorted[0];

            infoContainer.innerHTML = `
                <div class="winner-player-name">${winnerName}</div>
                <div class="winner-made-difference">
                    <div class="white">СДЕЛАЛ</div>
                    <div class="orange">РАЗНИЦУ</div>
                </div>
            `;

            let winnerPhotoSrc = null;
            if (players) {
                for (let id in players) {
                    if (players[id].name === winnerName && players[id].photo) {
                        winnerPhotoSrc = players[id].photo;
                        break;
                    }
                }
            }

            if (!winnerPhotoSrc) {
                photoContainer.innerHTML = '';
                return;
            }

            if (imageCache.has(winnerPhotoSrc)) {
                photoContainer.innerHTML = `<img src="${winnerPhotoSrc}" class="winner-photo">`;
            } else {
                photoContainer.innerHTML = `<div class="photo-placeholder"></div>`;

                preloadImage(winnerPhotoSrc).then(() => {
                    if (lastScene !== 'winner') return;
                    const img = document.createElement('img');
                    img.src = winnerPhotoSrc;
                    img.className = 'winner-photo loading';
                    photoContainer.innerHTML = '';
                    photoContainer.appendChild(img);
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => img.classList.remove('loading'));
                    });
                });
            }
        }
    </script>
</body>
</html>