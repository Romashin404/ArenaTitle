<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <style>
        #bg-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1; 
            transition: opacity 1s ease-in-out;
            background-color: transparent;
        }
        @font-face {
            font-family: 'PFDinComp';
            font-weight: 400;
            font-style: normal;
            src: url('fonts/PFDinTextCompPro-Regular.ttf') format('truetype');
        }
        @font-face {
            font-family: 'PFDinComp';
            font-weight: 700;
            font-style: normal;
            src: url('fonts/PFDinTextCompPro-Bold.ttf') format('truetype');
        }
        @font-face {
            font-family: 'PFDinComp';
            font-weight: 700;
            font-style: italic;
            src: url('fonts/PFDinTextCompPro-BoldItalic.ttf') format('truetype');
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); }
            50% { transform: scale(1.03); text-shadow: 0 0 50px rgba(0, 242, 255, 0.9); }
        }

        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        /* --- Анимации победителя --- */

        /* Панели: раскрываются из центра в стороны */
        @keyframes winExpandFromCenter {
            from { clip-path: inset(0 50% 0 50%); }
            to   { clip-path: inset(0 0% 0 0%); }
        }

        /* Фото: выезжает с левого края */
        @keyframes winPhotoSlideIn {
            from { transform: translateX(-110%); }
            to   { transform: translateX(0); }
        }

        /* Тексты: выезжают с правого края */
        @keyframes winSlideFromRight {
            from { transform: translate(calc(-50% + 110vw), -50%) skewX(-8deg); }
            to   { transform: translate(-50%, -50%) skewX(-8deg); }
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background: url('media/BG.png') center/cover no-repeat;
            font-family: 'PFDinComp', sans-serif;
            color: white;
        }
        
        .scene {
            position: absolute; 
            width: 100%; 
            height: 100%;
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.8s;
        }

        .scene.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
            z-index: 5;
        }

        h1 { font-size: 80px; text-transform: uppercase; text-shadow: 4px 4px 15px rgba(0,0,0,0.8); margin: 20px; }

        /* --- СЦЕНЫ С ВИДЕО --- */
        .video-scene video {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* --- СЦЕНА QR --- */
        .qr-row { display: flex; gap: 100px; justify-content: center; align-items: flex-start; }
        .qr-item { display: flex; flex-direction: column; align-items: center; }
        .qr-item img { width: 700px; border: 10px solid white; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        /* --- СЦЕНА ПОБЕДИТЕЛЯ --- */
        #winner {
            padding: 0;
            overflow: hidden;
        }

        .winner-photo-container {
            position: absolute;
            left: 0; bottom: 0;
            height: 100%;
            width: 50%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .winner-photo {
            height: 100%;
            width: auto;
            max-width: 100%;
            object-fit: contain;
            object-position: bottom center;
            transition: opacity 0.5s ease;
            display: block;
        }

        .winner-photo.loading { opacity: 0; }

        .photo-placeholder {
            width: 60%;
            height: 70%;
            border-radius: 20px;
            background: linear-gradient(
                90deg,
                rgba(5, 202, 255, 0.05) 25%,
                rgba(5, 202, 255, 0.15) 50%,
                rgba(5, 202, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            align-self: center;
        }

        /* --- Абсолютно позиционированные элементы победителя --- */

        /* Панель номера игрока */
        .winner-panel-number {
            position: absolute;
            left: 1244.8159px;
            top: 262.4047px;
            background: #1761FF;
            font-family: 'PFDinComp', sans-serif;
            font-weight: 700;
            font-style: normal;
            font-size: 80px;
            line-height: 1;
            transform: translate(-50%, -50%) skewX(-8deg);
            color: white;
            white-space: nowrap;
            padding: 10px 28px;
        }

        /* Панель имени/фамилии */
        .winner-panel-name {
            position: absolute;
            left: 1333.7986px;
            top: 428.8628px;
            background: #1761FF;
            font-family: 'PFDinComp', sans-serif;
            font-weight: 700;
            font-style: normal;
            font-size: 80px;
            line-height: 1;
            text-transform: uppercase;
            transform: translate(-50%, -50%) skewX(-8deg);
            color: white;
            white-space: nowrap;
            padding: 10px 28px;
        }

        /* "СДЕЛАЛ" */
        .winner-label-made {
            position: absolute;
            left: 1257.1521px;
            top: 605.8955px;
            font-family: 'PFDinComp', sans-serif;
            font-weight: 700;
            font-style: italic;
            font-size: 215.2px;
            line-height: 1;
            text-transform: uppercase;
            transform: translate(-50%, -50%) skewX(-8deg);
            color: white;
            white-space: nowrap;
        }

        /* "РАЗНИЦУ" */
        .winner-label-diff {
            position: absolute;
            left: 1344.0158px;
            top: 798.583px;
            font-family: 'PFDinComp', sans-serif;
            font-weight: 700;
            font-style: italic;
            font-size: 215.2px;
            line-height: 1;
            text-transform: uppercase;
            transform: translate(-50%, -50%) skewX(-8deg);
            color: #FF6A13;
            white-space: nowrap;
        }

        /* --- Запуск анимаций при активации сцены победителя ---
           Тайминг:
             0.00s  номер раскрывается   (0.45s)
             0.35s  имя раскрывается     (0.45s)  → конец: 0.80s
             0.72s  фото выезжает слева  (0.70s)  → ≈ конец имени
             0.85s  СДЕЛАЛ из правого    (0.80s)
             1.41s  РАЗНИЦУ из правого   (0.80s)  → 0.85 + 0.80×0.70 = 1.41s
        */
        #winner.anim-active .winner-panel-number {
            animation: winExpandFromCenter 0.45s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
        }
        #winner.anim-active .winner-panel-name {
            animation: winExpandFromCenter 0.45s cubic-bezier(0.4, 0, 0.2, 1) 0.35s both;
        }
        #winner.anim-active .winner-photo-container {
            animation: winPhotoSlideIn 0.70s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.72s both;
        }
        #winner.anim-active .winner-label-made {
            animation: winSlideFromRight 0.80s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.85s both;
        }
        #winner.anim-active .winner-label-diff {
            animation: winSlideFromRight 0.80s cubic-bezier(0.25, 0.46, 0.45, 0.94) 1s both;
        }

        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; transition: opacity 1s ease-in-out; }
    </style>
</head>
<body>
    <div id="bg-layer"></div>

    <!-- СЦЕНА: Логотип Winline -->
    <div id="winline_logo" class="scene video-scene">
        <video id="video-winline-logo" autoplay muted playsinline>
            <source src="media/WINLINE_logo.webm" type="video/webm">
        </video>
    </div>

    <!-- СЦЕНА: Анонс -->
    <div id="announcement" class="scene video-scene">
        <video id="video-announcement" autoplay muted playsinline>
            <source src="media/WINLINE_anons.webm" type="video/webm">
        </video>
    </div>

    <!-- СЦЕНА: QR -->
    <div id="qr" class="scene">
        <div class="qr-row">
            <div class="qr-item"><img src="media/telegramqr.png"></div>
            <div class="qr-item"><img src="media/max.jpg"></div>
        </div>
        <h1 style="text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); font-size: 160px; animation: pulse-glow 2s ease-in-out infinite;">
            Голосуй за игрока матча!
        </h1>
    </div>

    <!-- СЦЕНА: Победитель -->
    <div id="winner" class="scene">
        <div id="winner-photo"  class="winner-photo-container"></div>
        <div id="winner-number" class="winner-panel-number"></div>
        <div id="winner-name"   class="winner-panel-name"></div>
        <div class="winner-label-made">СДЕЛАЛ</div>
        <div class="winner-label-diff">РАЗНИЦУ</div>
    </div>

    <div id="bg-video">
        <source src="media/BG.png" type="image/png">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
            authDomain: "arenawork-94e68.firebaseapp.com",
            databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
            projectId: "arenawork-94e68",
            storageBucket: "arenawork-94e68.firebasestorage.app",
            messagingSenderId: "504372844993",
            appId: "1:504372844993:web:1783bb75879ee074953740"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const bgLayer = document.getElementById('bg-layer');
        const bgVideo = document.getElementById('bg-video');
        const imageCache = new Set();

        const videoScenes = {
            winline_logo: document.getElementById('video-winline-logo'),
            announcement:  document.getElementById('video-announcement'),
        };

        function preloadImage(src) {
            if (!src || imageCache.has(src)) return Promise.resolve();
            imageCache.add(src);
            return new Promise((resolve) => {
                const img = new Image();
                img.onload  = resolve;
                img.onerror = resolve;
                img.src = src;
            });
        }

        function preloadAllAssets(data) {
            const urls = ['media/telegramqr.png', 'media/max.jpg', data.background];
            if (data.players) Object.values(data.players).forEach(p => { if (p.photo) urls.push(p.photo); });
            urls.forEach(url => preloadImage(url));
        }

        let lastScene = "";

        onValue(ref(db, 'competition'), (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            preloadAllAssets(data);

            const currentScene = data.mvpState || 'winline_logo';

            if (data.background && data.background.trim() !== "") {
                bgLayer.style.backgroundImage = `url('${data.background}')`;
                bgLayer.style.opacity = "1";
                bgVideo.style.opacity = "0";
            } else {
                bgLayer.style.opacity = "0";
                bgVideo.style.opacity = "1";
            }

            if (currentScene !== lastScene) {
                // Сбрасываем анимации победителя если уходим с этой сцены
                if (lastScene === 'winner') {
                    document.getElementById('winner').classList.remove('anim-active');
                }

                if (currentScene === 'winner') {
                    displayWinner(data.mvpVotes, data.players);
                }

                Object.entries(videoScenes).forEach(([key, videoEl]) => {
                    if (!videoEl) return;
                    if (key === currentScene) {
                        videoEl.currentTime = 0;
                        videoEl.play().catch(() => {});
                    } else {
                        videoEl.pause();
                    }
                });

                document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
                const target = document.getElementById(currentScene);
                if (target) target.classList.add('active');

                // Запускаем анимации победителя через 2 кадра
                // (чтобы fill-mode: both успел применить from-состояния до появления сцены)
                if (currentScene === 'winner') {
                    requestAnimationFrame(() => requestAnimationFrame(() => {
                        document.getElementById('winner').classList.add('anim-active');
                    }));
                }

                lastScene = currentScene;
            }
        });

        function displayWinner(votes, players) {
            const photoContainer = document.getElementById('winner-photo');
            const namePanel      = document.getElementById('winner-name');
            const numberPanel    = document.getElementById('winner-number');

            if (!votes) {
                namePanel.textContent    = '';
                numberPanel.textContent  = '';
                photoContainer.innerHTML = '';
                return;
            }

            const voteCounts = {};
            Object.values(votes).forEach(vote => {
                voteCounts[vote.votedFor] = (voteCounts[vote.votedFor] || 0) + 1;
            });

            const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);
            if (sorted.length === 0) return;

            const [winnerName] = sorted[0];

            // Ищем данные игрока в базе
            let winnerPhotoSrc = null;
            let winnerKeywords = '';
            if (players) {
                for (let id in players) {
                    if (players[id].name === winnerName) {
                        winnerPhotoSrc = players[id].photo || null;
                        winnerKeywords = players[id].keywords || '';
                        break;
                    }
                }
            }

            // keywords = "42, Фамилия" — первый элемент номер, второй фамилия
            const parts  = winnerKeywords.split(',').map(s => s.trim());
            const number = parts[0] || '';

            namePanel.textContent   = winnerName;
            numberPanel.textContent = number ? `#${number}` : '';

            if (!winnerPhotoSrc) {
                photoContainer.innerHTML = '';
                return;
            }

            if (imageCache.has(winnerPhotoSrc)) {
                photoContainer.innerHTML = `<img src="${winnerPhotoSrc}" class="winner-photo">`;
            } else {
                photoContainer.innerHTML = `<div class="photo-placeholder"></div>`;
                preloadImage(winnerPhotoSrc).then(() => {
                    if (lastScene !== 'winner') return;
                    const img = document.createElement('img');
                    img.src = winnerPhotoSrc;
                    img.className = 'winner-photo loading';
                    photoContainer.innerHTML = '';
                    photoContainer.appendChild(img);
                    requestAnimationFrame(() => requestAnimationFrame(() => img.classList.remove('loading')));
                });
            }
        }
    </script>
</body>
</html>
