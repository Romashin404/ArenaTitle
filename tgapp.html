<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sibir Control Panel ‚Äî Mini App</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<style>
:root{
  --blue:#05caff;
  --dark:#253566;
}

body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:var(--tg-theme-bg-color);
  color:var(--tg-theme-text-color);
}

.header{
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid rgba(0,0,0,.1);
}

.btn{
  border:none;
  border-radius:12px;
  padding:10px 14px;
  font-weight:600;
  cursor:pointer;
}

.btn-primary{background:var(--blue);color:#fff;}
.btn-danger{background:#ee5253;color:#fff;}

.mode-switch{
  display:flex;
  gap:8px;
  padding:10px;
}

.mode-switch button{
  flex:1;
  background:#f1f2f6;
}

.mode-switch button.active{
  background:var(--blue);
  color:#fff;
}

.tabs{
  display:flex;
  border-bottom:1px solid #ddd;
}

.tabs button{
  flex:1;
  padding:12px;
  border:none;
  background:none;
  font-weight:600;
}

.tabs button.active{
  border-bottom:3px solid var(--blue);
  color:var(--blue);
}

.section{
  padding:15px;
}

.card{
  background:#f1f2f6;
  border-radius:14px;
  padding:15px;
  margin-bottom:12px;
}

.vote-card{
  text-align:center;
}

.vote-card img{
  width:60px;
  height:60px;
  border-radius:50%;
  object-fit:cover;
}

.char-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:12px;
}

.char-card img{
  width:100%;
  border-radius:10px;
}

.crop-container{
  height:300px;
  display:none;
}

input,select{
  width:100%;
  height:40px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid #ccc;
  padding:0 10px;
}

</style>
</head>
<body>

<div class="header">
  <b>üèí SIBIR ADMIN</b>
  <button id="stopBtn" class="btn btn-danger">üõë –°–¢–û–ü</button>
</div>

<div class="mode-switch">
  <button id="mode-voting">–®–∞–π–±–∞</button>
  <button id="mode-slideshow">–°–ª–∞–π–¥</button>
  <button id="mode-lookslike">LooksLike</button>
</div>

<div class="tabs">
  <button class="tab active" data-tab="votes">–ì–æ–ª–æ—Å–∞</button>
  <button class="tab" data-tab="chat">–ß–∞—Ç</button>
  <button class="tab" data-tab="characters">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
</div>

<div id="content" class="section"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, update } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const tg = window.Telegram.WebApp;
tg.expand();

const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_ID",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentData = {};
let currentTab = "votes";
let cropper;

const content = document.getElementById("content");

onValue(ref(db,"competition"), snap=>{
  currentData = snap.val() || {};
  render();
});

/* ==============================
   UI NAVIGATION
============================== */

document.querySelectorAll(".tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentTab=btn.dataset.tab;
    render();
  }
});

document.getElementById("stopBtn").onclick=()=>{
  set(ref(db,"competition/acceptingVotes"),
  !currentData.acceptingVotes);
};

["voting","slideshow","lookslike"].forEach(mode=>{
  document.getElementById("mode-"+mode).onclick=()=>{
    set(ref(db,"competition/activeMode"),mode);
  };
});

/* ==============================
   RENDER FUNCTIONS
============================== */

function render(){
  if(currentTab==="votes") renderVotes();
  if(currentTab==="chat") renderChat();
  if(currentTab==="characters") renderCharacters();
}

/* ---------- VOTES ---------- */

function renderVotes(){
  const votes=currentData.votes||{};
  let html="";
  Object.keys(votes).reverse().forEach(id=>{
    const v=votes[id];
    html+=`
    <div class="card vote-card">
      <img src="${v.photo||''}">
      <div><b>${v.name}</b></div>
      <div>${v.votedFor}</div>
      <button class="btn btn-primary"
        onclick="removeVote('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  });
  content.innerHTML=html;
}

window.removeVote=id=>{
  remove(ref(db,"competition/votes/"+id));
};

/* ---------- CHAT ---------- */

function renderChat(){
  const msgs=currentData.allMessages||{};
  let html="";
  Object.keys(msgs).reverse().forEach(id=>{
    const m=msgs[id];
    html+=`
    <div class="card">
      <b>${m.name}</b>
      <div>${m.text||""}</div>
      <button class="btn btn-danger"
        onclick="removeMsg('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  });
  content.innerHTML=html;
}

window.removeMsg=id=>{
  remove(ref(db,"competition/allMessages/"+id));
};

/* ---------- CHARACTERS ---------- */

function renderCharacters(){
  const chars=currentData.lookslike?.characters||{};
  let html=`
    <input type="text" id="charName" placeholder="–ò–º—è">
    <input type="file" id="charFile">
    <div class="crop-container">
      <img id="cropImg">
    </div>
    <button class="btn btn-primary" onclick="saveChar()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <hr>
    <div class="char-grid">
  `;
  Object.keys(chars).forEach(id=>{
    const c=chars[id];
    html+=`
      <div class="card char-card">
        <img src="${c.image}">
        <div><b>${c.name}</b></div>
        <button class="btn"
          onclick="setChar('${id}')">–í —ç—Ñ–∏—Ä</button>
        <button class="btn btn-danger"
          onclick="delChar('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
      </div>`;
  });
  html+="</div>";
  content.innerHTML=html;

  document.getElementById("charFile").onchange=e=>{
    const file=e.target.files[0];
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=document.getElementById("cropImg");
      img.src=ev.target.result;
      document.querySelector(".crop-container").style.display="block";
      cropper=new Cropper(img,{aspectRatio:8/9});
    };
    reader.readAsDataURL(file);
  };
}

window.saveChar=()=>{
  const name=document.getElementById("charName").value;
  if(!name||!cropper){
    tg.showPopup({message:"–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ"});
    return;
  }
  const canvas=cropper.getCroppedCanvas({height:800});
  push(ref(db,"competition/lookslike/characters"),{
    name,
    image:canvas.toDataURL("image/jpeg",0.8)
  });
};

window.setChar=id=>{
  set(ref(db,"competition/lookslike/pendingCharacter"),id);
};

window.delChar=id=>{
  remove(ref(db,"competition/lookslike/characters/"+id));
};

</script>
</body>
</html>

