<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sibir Control Panel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <style>
    :root {
      --sibir-blue: #05caff;
      --sibir-dark: #253566;
      --bg-body: #f4f7f9;
      --white: #ffffff;
      --gray: rgb(223, 223, 223);
      --text-main: #2c3e50;
      --text-muted: #7f8c8d;
      --border-color: #05caff;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: 0;
    }

    .tabs {
      display: flex;
      position: sticky;
      top: 0;
      background: var(--bg-body);
      z-index: 100;
      padding: 10px;
      gap: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .tab-btn {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 700;
      padding: 12px 8px;
      cursor: pointer;
      transition: 0.3s;
      border-bottom: 3px solid transparent;
      text-align: center;
    }

    .tab-btn.active {
      color: var(--sibir-blue);
      border-bottom: 3px solid var(--sibir-blue);
    }

    .tab-content {
      display: none;
      padding: 15px;
    }

    .tab-content.active {
      display: block;
    }

    h2, h3 {
      color: var(--sibir-dark);
      font-size: 0.95rem;
      font-weight: 800;
      margin: 20px 0 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
    }

    h2::before, h3::before {
      content: "";
      display: inline-block;
      width: 4px;
      height: 16px;
      background: var(--sibir-blue);
      margin-right: 8px;
      border-radius: 2px;
    }

    .btn {
      padding: 12px 15px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-scene {
      background: #f8f9fa;
      color: var(--text-main);
      border: 1px solid var(--border-color);
    }

    .btn-scene.active {
      background: var(--sibir-blue) !important;
      color: white !important;
      border-color: var(--sibir-blue) !important;
      box-shadow: 0 4px 12px rgba(5, 202, 255, 0.3);
    }

    .btn-primary {
      background: var(--sibir-blue);
      color: white;
      width: 100%;
      border: none;
    }

    .btn-stop {
      width: 100%;
      background: #ff9f43;
      color: white;
      font-size: 1.05rem;
      margin-bottom: 20px;
    }

    .btn-stop.closed {
      background: #ee5253;
    }

    .btn-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 15px 0;
    }

    .btn-grid-full {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    input, select {
      width: 100%;
      height: 48px;
      padding: 0 15px;
      background: #fff;
      border: 1.5px solid var(--sibir-blue);
      color: var(--text-main);
      border-radius: 12px;
      margin-bottom: 12px;
      font-family: inherit;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2305caff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 15px;
    }

    .votes-list {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .vote-card {
      background: var(--gray);
      padding: 12px;
      border-radius: 16px;
      text-align: center;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      position: relative;
    }

    .vote-card.correct {
      background: #b8ffbe;
      border-color: #10ac84;
    }

    .vote-card img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      background: #fff;
    }

    .remove-vote {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 1.3rem;
      color: #ee5253;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .remove-vote:hover {
      background: #ee5253;
      color: white;
    }

    .player-tag {
      background: #edf2f7;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin: 4px 4px 4px 0;
      display: inline-block;
    }

    .char-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .char-card {
      background: var(--gray);
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid transparent;
      transition: 0.2s;
    }

    .char-card.active-char {
      border-color: #9ef01a;
      background: #fff;
      box-shadow: 0 0 15px rgba(24, 164, 14, 0.4);
    }

    .char-img {
      width: 100%;
      aspect-ratio: 8/9;
      object-fit: cover;
      background: #000;
    }

    .char-info {
      padding: 12px;
      text-align: center;
    }

    .crop-container {
      width: 100%;
      height: 300px;
      background: #333;
      margin: 12px 0;
      border-radius: 12px;
      overflow: hidden;
      display: none;
    }

    .mode-indicator {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px;
      text-align: center;
      font-weight: 700;
      font-size: 0.9rem;
      border-top: 3px solid var(--sibir-blue);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      z-index: 999;
    }
  </style>
</head>
<body>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('main')">üïπ –ü–£–õ–¨–¢</button>
  <button class="tab-btn" onclick="switchTab('chat')">üí¨ –≠–§–ò–†</button>
  <button class="tab-btn" onclick="switchTab('votes')">üèí –ì–û–õ–û–°–ê</button>
  <button class="tab-btn" onclick="switchTab('lookslike')">üëØ LOOKS LIKE</button>
</div>

<!-- MAIN -->
<div id="tab-main" class="tab-content active">
  <button id="stopBtn" class="btn btn-stop" onclick="toggleVoting()">üõë –°–¢–û–ü –ü–†–ò–ï–ú –ì–û–õ–û–°–û–í</button>

  <h2>–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º</h2>
  <div class="btn-grid">
    <button id="mode-voting" class="btn btn-scene" onclick="setActiveMode('voting')">üèí –®–∞–π–±–∞</button>
    <button id="mode-slideshow" class="btn btn-scene" onclick="setActiveMode('slideshow')">üì∏ –°–ª–∞–π–¥</button>
    <button id="mode-lookslike" class="btn btn-scene" onclick="setActiveMode('lookslike')">üëØ Looks Like</button>
  </div>

  <div id="controls-voting" style="display:none">
    <h2>–°—Ü–µ–Ω—ã</h2>
    <div class="btn-grid">
      <button class="btn btn-scene" onclick="setScene('announcement')">–ê–Ω–æ–Ω—Å</button>
      <button class="btn btn-scene" onclick="setScene('qr')">QR-–∫–æ–¥</button>
      <button class="btn btn-scene" onclick="setScene('roulette')">–†—É–ª–µ—Ç–∫–∞</button>
      <button class="btn btn-scene" onclick="setScene('winner')">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
    </div>
    <h2>–ê–≤—Ç–æ—Ä –≥–æ–ª–∞</h2>
    <select id="goalScorer" onchange="setScorer(this.value)"></select>
  </div>

  <div id="controls-slideshow" style="display:none">
    <h2>–°–ª–∞–π–¥-—à–æ—É</h2>
    <div class="btn-grid">
      <button class="btn btn-scene" onclick="setScene('slideshow_qr')">QR-–∫–æ–¥—ã</button>
      <button class="btn btn-scene" onclick="setScene('slideshow_photo')">–°–ª–∞–π–¥—ã</button>
    </div>
  </div>

  <h2>–§–æ–Ω –æ–≤–µ—Ä–ª–µ—è</h2>
  <input type="text" id="bgUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ .webm –∏–ª–∏ .jpg">
  <div class="btn-grid">
    <button class="btn btn-scene" onclick="updateBg()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    <button class="btn btn-scene" onclick="removeBackground()">–£–¥–∞–ª–∏—Ç—å</button>
  </div>
</div>

<!-- –≠–§–ò–† / –ß–ê–¢ -->
<div id="tab-chat" class="tab-content">
  <div class="btn-grid">
    <button class="btn btn-scene" style="background:#ff9f43; color:white;" onclick="clearApprovedPhotos()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç—Ñ–∏—Ä</button>
    <button class="btn btn-scene" style="background:#ee5253; color:white;" onclick="clearChat()">üóë –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
  </div>
  <div id="messagesList"></div>
</div>

<!-- –ì–û–õ–û–°–ê -->
<div id="tab-votes" class="tab-content">
  <select id="filterMode" onchange="renderVotes()">
    <option value="all">–í—Å–µ –≥–æ–ª–æ—Å–∞</option>
    <option value="correct">–¢–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</option>
  </select>
  <div id="votesList" class="votes-list"></div>

  <h2>–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤</h2>
  <input type="text" id="pName" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
  <input type="text" id="pKeys" placeholder="–ù–æ–º–µ—Ä, —Ñ–∞–º–∏–ª–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
  <button class="btn btn-primary" onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
  <div id="playersList" style="margin-top:12px;"></div>
</div>

<!-- LOOKS LIKE -->
<div id="tab-lookslike" class="tab-content">
  <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
  <input type="text" id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
  <input type="file" id="charFile" accept="image/*">
  <div id="cropWrapper" class="crop-container">
    <img id="imageToCrop" src="">
  </div>
  <button id="btnSaveChar" class="btn btn-primary" style="display:none;" onclick="saveCharacter()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <h3>–°–ø–∏—Å–æ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h3>
  <div id="charactersList" class="char-grid"></div>
</div>

<div class="mode-indicator" id="current-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
  authDomain: "arenawork-94e68.firebaseapp.com",
  databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
  projectId: "arenawork-94e68",
  storageBucket: "arenawork-94e68.firebasestorage.app",
  messagingSenderId: "504372844993",
  appId: "1:504372844993:web:1783bb75879ee074953740"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentData = {};
let cropper = null;
let editingCharId = null;

const tg = window.Telegram.WebApp;
tg.expand();

window.switchTab = (tab) => {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
};

window.toggleVoting = () => set(ref(db, 'competition/acceptingVotes'), !currentData.acceptingVotes);

window.setActiveMode = (mode) => {
  set(ref(db, 'competition/activeMode'), mode);
  tg.HapticFeedback.impactOccurred('light');
};

window.setScene = (scene) => {
  const mode = currentData.activeMode || 'voting';
  let path = 'competition/votingState';
  if (mode === 'slideshow') path = 'competition/slideshowState';
  if (mode === 'lookslike') path = 'competition/lookslikeState';
  set(ref(db, path), scene);

  if (mode === 'lookslike' && scene === 'character') {
    const pending = currentData.lookslike?.pendingCharacter;
    if (pending) set(ref(db, 'competition/lookslike/activeCharacter'), pending);
  }
  tg.HapticFeedback.impactOccurred('medium');
};

window.updateBg = () => {
  const url = document.getElementById('bgUrl').value.trim();
  if (url) set(ref(db, 'competition/background'), url);
};

window.removeBackground = () => {
  if (confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω?")) set(ref(db, 'competition/background'), null);
  document.getElementById('bgUrl').value = '';
};

window.togglePhotoSelection = (id, status) => set(ref(db, `competition/allMessages/${id}/approved`), !status);

window.removeMessage = (id) => {
  if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) remove(ref(db, `competition/allMessages/${id}`));
};

window.clearChat = () => {
  if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å —á–∞—Ç?")) remove(ref(db, 'competition/allMessages'));
};

window.clearApprovedPhotos = () => {
  if (confirm("–£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ —ç—Ñ–∏—Ä–∞?")) {
    const updates = {};
    Object.keys(currentData.allMessages || {}).forEach(id => {
      if (currentData.allMessages[id]?.approved) {
        updates[`competition/allMessages/${id}/approved`] = false;
      }
    });
    if (Object.keys(updates).length) update(ref(db), updates);
  }
};

window.sendReply = (chatId, name) => {
  const msg = prompt(`–û—Ç–≤–µ—Ç –¥–ª—è ${name}:`);
  if (msg) push(ref(db, 'competition/replies'), { chatId, text: msg });
};

window.addPlayer = () => {
  const name = document.getElementById('pName').value.trim();
  const keywords = document.getElementById('pKeys').value.trim();
  if (name && keywords) {
    push(ref(db, 'competition/players'), { name, keywords });
    document.getElementById('pName').value = '';
    document.getElementById('pKeys').value = '';
  }
};

window.removePlayer = (id) => remove(ref(db, `competition/players/${id}`));

window.setScorer = (val) => set(ref(db, 'competition/scorer'), val);

window.removeVote = (id) => remove(ref(db, `competition/votes/${id}`));

// Looks Like logic (cropper, save, edit, delete) ‚Äî —Ç–∞ –∂–µ, —á—Ç–æ –±—ã–ª–∞
document.getElementById('charFile').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = document.getElementById('imageToCrop');
    img.src = ev.target.result;
    document.getElementById('cropWrapper').style.display = 'block';
    document.getElementById('btnSaveChar').style.display = 'block';
    if (cropper) cropper.destroy();
    cropper = new Cropper(img, {
      aspectRatio: 8 / 9,
      viewMode: 1,
      autoCropArea: 1,
      responsive: true
    });
  };
  reader.readAsDataURL(file);
});

window.saveCharacter = () => {
  const name = document.getElementById('charName').value.trim();
  if (!name || !cropper) {
    alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!");
    return;
  }
  const canvas = cropper.getCroppedCanvas({ height: 800 });
  const base64 = canvas.toDataURL('image/jpeg', 0.85);
  push(ref(db, 'competition/lookslike/characters'), { name, image: base64 })
    .then(() => {
      document.getElementById('charName').value = '';
      document.getElementById('charFile').value = '';
      document.getElementById('imageToCrop').src = '';
      document.getElementById('cropWrapper').style.display = 'none';
      document.getElementById('btnSaveChar').style.display = 'none';
      if (cropper) cropper.destroy();
      cropper = null;
    });
};

window.setActiveCharacter = (id) => set(ref(db, 'competition/lookslike/pendingCharacter'), id);

window.deleteCharacter = (id) => {
  if (confirm("–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞?")) remove(ref(db, `competition/lookslike/characters/${id}`));
};

window.startEditName = (id) => {
  editingCharId = id;
  renderCharacters();
};

window.cancelEditName = () => {
  editingCharId = null;
  renderCharacters();
};

window.saveEditName = (id) => {
  const newName = document.getElementById(`edit-name-${id}`).value.trim();
  if (newName) {
    update(ref(db, `competition/lookslike/characters/${id}`), { name: newName });
  }
  editingCharId = null;
  renderCharacters();
};

onValue(ref(db, 'competition'), snapshot => {
  currentData = snapshot.val() || {};

  const mode = currentData.activeMode || 'voting';

  // –ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∂–∏–º—ã
  document.getElementById('mode-voting').className = `btn btn-scene ${mode === 'voting' ? 'active' : ''}`;
  document.getElementById('mode-slideshow').className = `btn btn-scene ${mode === 'slideshow' ? 'active' : ''}`;
  document.getElementById('mode-lookslike').className = `btn btn-scene ${mode === 'lookslike' ? 'active' : ''}`;

  document.getElementById('controls-voting').style.display = mode === 'voting' ? 'block' : 'none';
  document.getElementById('controls-slideshow').style.display = mode === 'slideshow' ? 'block' : 'none';

  const accepting = currentData.acceptingVotes !== false;
  const stopBtn = document.getElementById('stopBtn');
  stopBtn.textContent = accepting ? "üõë –°–¢–û–ü –ü–†–ò–ï–ú –ì–û–õ–û–°–û–í" : "‚ñ∂Ô∏è –ó–ê–ü–£–°–¢–ò–¢–¨ –ü–†–ò–ï–ú";
  stopBtn.className = accepting ? "btn btn-stop" : "btn btn-stop closed";

  document.getElementById('current-info').innerHTML = `
    –†–ï–ñ–ò–ú: <span style="color:var(--sibir-blue)">${mode.toUpperCase()}</span> | 
    –°–¶–ï–ù–ê: <span style="color:var(--sibir-blue)">${(currentData.votingState || currentData.slideshowState || currentData.lookslikeState || '---').toUpperCase()}</span>
  `;

  renderMessages();
  renderVotes();
  renderPlayers();
  renderCharacters();
});

function renderMessages() {
  const container = document.getElementById('messagesList');
  const msgs = currentData.allMessages || {};
  container.innerHTML = '';
  Object.keys(msgs).sort((a,b) => (msgs[b].timestamp || 0) - (msgs[a].timestamp || 0)).forEach(id => {
    const m = msgs[id];
    const avatar = m.userPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(m.name)}&background=05caff&color=fff`;
    container.innerHTML += `
      <div class="message-item" style="border-left-color: ${m.approved ? '#10ac84' : '#d1d8e0'}">
        <div class="msg-header">
          <img src="${avatar}" onerror="this.src='https://via.placeholder.com/40'">
          <b>${m.name} ${m.handle ? '@'+m.handle : ''}</b>
        </div>
        <div class="msg-body">
          ${m.text ? `<div>${m.text}</div>` : ''}
          ${m.isImage ? `<img src="${m.photo}" alt="—Ñ–æ—Ç–æ">` : ''}
        </div>
        <div class="msg-actions">
          <button class="btn btn-scene ${m.approved ? 'active' : ''}" onclick="togglePhotoSelection('${id}', ${m.approved})">
            ${m.approved ? '‚úÖ –í –≠–§–ò–†–ï' : 'üì∫ –í –≠–§–ò–†'}
          </button>
          <button class="btn btn-scene" onclick="sendReply('${m.chatId}', '${m.name}')">‚Ü© –û—Ç–≤–µ—Ç</button>
          <button class="btn btn-scene btn-danger" onclick="removeMessage('${id}')">üóë</button>
        </div>
      </div>`;
  });
}

function renderVotes() {
  const container = document.getElementById('votesList');
  const filter = document.getElementById('filterMode').value;
  const votes = currentData.votes || {};
  container.innerHTML = '';
  let list = Object.keys(votes).map(id => ({id, ...votes[id]}));
  if (filter === 'correct') list = list.filter(v => v.votedFor === currentData.scorer);
  list.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

  list.forEach(v => {
    const avatar = v.photo || `https://ui-avatars.com/api/?name=${encodeURIComponent(v.name)}&background=05caff&color=fff`;
    container.innerHTML += `
      <div class="vote-card ${v.votedFor === currentData.scorer ? 'correct' : ''}">
        <span class="remove-vote" onclick="removeVote('${v.id}')">√ó</span>
        <img src="${avatar}">
        <div style="font-weight:700; margin:6px 0;">${v.name}</div>
        <div style="color:var(--sibir-blue); font-size:0.85rem;">${v.votedFor}</div>
        <button class="btn btn-scene" style="margin-top:8px; width:100%; font-size:0.85rem;" onclick="sendReply('${v.chatId}', '${v.name}')">üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
      </div>`;
  });
}

function renderPlayers() {
  const pList = document.getElementById('playersList');
  const pSelect = document.getElementById('goalScorer');
  const players = currentData.players || {};
  pList.innerHTML = '';
  pSelect.innerHTML = '<option value="">-- –ê–≤—Ç–æ—Ä –≥–æ–ª–∞ --</option>';
  Object.keys(players).forEach(id => {
    const p = players[id];
    pList.innerHTML += `
      <div class="player-tag">
        ${p.name}
        <span onclick="removePlayer('${id}')" style="color:#ee5253; margin-left:6px; cursor:pointer;">√ó</span>
      </div>`;
    pSelect.innerHTML += `<option value="${p.name}" ${currentData.scorer === p.name ? 'selected' : ''}>${p.name}</option>`;
  });
}

function renderCharacters() {
  const container = document.getElementById('charactersList');
  const chars = currentData.lookslike?.characters || {};
  const pending = currentData.lookslike?.pendingCharacter;
  const active = currentData.lookslike?.activeCharacter;
  container.innerHTML = '';
  Object.keys(chars).forEach(id => {
    const c = chars[id];
    const isPending = id === pending;
    const isActive = id === active;
    const isEditing = id === editingCharId;
    container.innerHTML += `
      <div class="char-card ${isActive ? 'active-char' : ''}">
        <img class="char-img" src="${c.image}">
        <div class="char-info">
          ${isEditing ? `
            <input id="edit-name-${id}" value="${c.name}" style="margin-bottom:8px; width:100%;">
            <div class="btn-grid">
              <button class="btn btn-primary btn-scene" onclick="saveEditName('${id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn btn-scene btn-danger" onclick="cancelEditName()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          ` : `
            <div style="font-weight:700; margin-bottom:8px;">${c.name}</div>
            <button class="btn btn-scene" onclick="startEditName('${id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º—è</button>
          `}
          <button class="btn btn-scene ${isPending ? 'active' : ''}" style="width:100%; margin:10px 0;" onclick="setActiveCharacter('${id}')">
            ${isPending ? 'üì∫ –í –≠–§–ò–†–ï' : '–í –≠–§–ò–†'}
          </button>
          ${isActive ? '<div style="color:#10ac84; font-size:0.85rem; margin:6px 0;">‚óè –°–µ–π—á–∞—Å –≤ —ç—Ñ–∏—Ä–µ</div>' : ''}
          <button class="btn btn-scene btn-danger" onclick="deleteCharacter('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>`;
  });
}
</script>
</body>
</html>
