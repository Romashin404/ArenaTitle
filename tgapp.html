<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sibir Control Panel ‚Äî Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <style>
        :root {
            --sibir-blue: #05caff;
            --sibir-dark: #253566;
            --bg-body: #f4f5f7;
            --white: #ffffff;
            --gray: #eef0f3;
            --text-main: #2c3e50;
            --text-muted: #7f8c8d;
            --border-color:#dcdde1;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            gap: 15px; 
            padding: 12px; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* –û—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏ —Ç–µ–ø–µ—Ä—å –Ω–∞ 100% —à–∏—Ä–∏–Ω—ã */
        .top-panel, .main-panel, .bottom-panel { 
            background: var(--white); 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            width: 100%;
            box-sizing: border-box;
        }

        h2 { 
            color: var(--sibir-dark); 
            font-size: 0.9rem; 
            font-weight: 800;
            margin: 0 0 15px 0; 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }
        h2::before {
            content: ""; display: inline-block; width: 4px; height: 16px; 
            background: var(--sibir-blue); margin-right: 8px; border-radius: 2px;
        }

        .btn { 
            padding: 14px 15px; border: none; border-radius: 12px; 
            font-weight: 600; font-size: 0.9rem; cursor: pointer; 
            transition: all 0.2s ease; display: flex; align-items: center; justify-content: center;
            gap: 8px; font-family: inherit; flex-shrink: 0;
        }
        .btn:active { transform: scale(0.96); }

        .btn-scene { background: #f8f9fa; color: var(--text-main); border: 1px solid var(--border-color); flex: 1; min-width: calc(50% - 5px); }
        .btn-scene.active { background: var(--sibir-blue) !important; color: white !important; border-color: var(--sibir-blue) !important; box-shadow: 0 4px 12px rgba(5, 202, 255, 0.3); }
        
        .btn-stop { width: 100%; background: #ff9f43; color: white; margin-bottom: 20px; font-size: 1rem; }
        .btn-stop.closed { background: #ee5253; }
        
        .btn-primary { background: var(--sibir-blue); color: white; width: 100%; }

        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Ç–∞–±—ã —Å–æ —Å–∫—Ä–æ–ª–ª–æ–º */
        .tabs { 
            display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); 
            padding-bottom: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tab-btn { 
            background: transparent; border: none; color: var(--text-muted); 
            font-size: 0.95rem; cursor: pointer; font-weight: 700; padding: 5px 0; 
            transition: 0.3s; white-space: nowrap; flex-shrink: 0;
        }
        .tab-btn.active { color: var(--sibir-blue); border-bottom: 3px solid var(--sibir-blue); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }

        .message-item {
            display: flex; flex-direction: column; background: var(--gray); border-radius: 16px; margin-bottom: 15px; padding: 16px;
            border: 1px solid var(--white); gap: 12px; transition: 0.3s;
        }

        .message-left { width: 100%; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .message-content { flex-grow: 1; width: 100%; }

        .photo-container { 
            margin-top: 10px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color); 
            width: 100%;
        }
        .photo-container img { width: 100%; display: block; }

        input, select { 
            width: 100%; height: 48px; padding: 0 15px; background: #fff; 
            border: 1.5px solid var(--border-color); color: var(--text-main); 
            border-radius: 12px; margin-bottom: 15px; font-family: inherit;
            font-size: 0.95rem; box-sizing: border-box; display: block; outline: none;
        }
        input:focus, select:focus { border-color: var(--sibir-blue); }

        select {
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2305caff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 15px center; background-size: 15px;
        }

        .votes-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; align-items: start; }
        .vote-card { 
            background: var(--gray); padding: 15px; border-radius: 16px; text-align: center; 
            border: 2px solid transparent; box-shadow: 0 2px 8px rgba(0,0,0,0.02); position: relative;
            display: flex; flex-direction: column; align-items: center;
            min-width: 0; word-break: break-word; overflow-wrap: break-word;
        }
        .vote-card.correct {background: #e8f9ec; border-color: #10ac84;}
        .vote-card img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid var(--sibir-blue); background: #fff; }
        
        .crop-container {
            width: 100%; height: 300px; background: #333;
            margin-bottom: 15px; border-radius: 12px; overflow: hidden; display: none;
        }
        .crop-container img { max-width: 100%; }
        
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .char-card { background: var(--gray); border-radius: 12px; overflow: hidden; border: 3px solid transparent; transition: 0.2s; cursor: grab; }
        .char-card.active-char { border-color: #9ef01a; background: #fff; box-shadow: 0 0 15px rgba(24, 164, 14, 0.4); }
        .char-card.dragging { opacity: 0.4; transform: scale(0.97); }
        .char-card.drag-over { border-color: var(--sibir-blue) !important; box-shadow: 0 0 0 3px rgba(5,202,255,0.3); }
        .char-img { width: 100%; aspect-ratio: 8/9; object-fit: cover; display: block; background: #000; }
        .char-info { padding: 10px; }
        .char-name { font-weight: 700; font-size: 0.95rem; margin-bottom: 10px; text-align: center; }
        .drag-handle { text-align: center; padding: 4px 0 0; font-size: 0.75rem; color: #aaa; letter-spacing: 3px; user-select: none; }

        /* ===== PLAYER LIST ===== */
        .player-row {
            background: var(--gray); border-radius: 12px; padding: 12px;
            margin-bottom: 10px;
        }
        .player-row-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .player-name-label { font-weight: 700; font-size: 0.95rem; }
        .keyword-tag {
            display: inline-flex; align-items: center; gap: 4px;
            background: #e8f4ff; color: var(--sibir-dark);
            border-radius: 20px; padding: 4px 10px; font-size: 0.8rem; font-weight: 600;
            margin: 2px;
        }
        .keyword-tag span { cursor: pointer; color: #ee5253; font-size: 1rem; line-height: 1; }
        .keyword-add-row { display: flex; gap: 6px; margin-top: 10px; }
        .keyword-add-row input { height: 40px; font-size: 0.85rem; margin: 0; flex: 1; padding: 0 10px; }
        .keyword-add-row button { height: 40px; padding: 0 15px; font-size: 0.85rem; border-radius: 10px; background: var(--sibir-blue); color: white; border: none; cursor: pointer; font-weight: 600; white-space: nowrap; }

        /* ===== EMOJI PICKER ===== */
        .emoji-btn {
            width: 48px; height: 48px; border-radius: 50%; background: var(--gray);
            border: none; cursor: pointer; font-size: 1.3rem; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .emoji-btn:hover { background: #ddd; }
        .emoji-picker-popup {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: white; border-radius: 16px; padding: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            z-index: 1100; width: calc(100% - 32px); max-width: 320px; max-height: 300px;
            display: none; flex-direction: column; gap: 8px;
        }
        .emoji-picker-popup.open { display: flex; }
        .emoji-cats { display: flex; gap: 6px; flex-wrap: nowrap; overflow-x: auto; border-bottom: 1px solid var(--gray); padding-bottom: 8px; scrollbar-width: none;}
        .emoji-cats::-webkit-scrollbar { display: none; }
        .emoji-cat-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 6px 8px; border-radius: 8px; transition: 0.15s; flex-shrink: 0;}
        .emoji-cat-btn.active, .emoji-cat-btn:hover { background: var(--gray); }
        .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; overflow-y: auto; }
        .emoji-grid button { background: none; border: none; cursor: pointer; font-size: 1.4rem; padding: 6px 0; border-radius: 6px; transition: 0.15s; text-align: center;}
        .emoji-grid button:hover { background: var(--gray); }

        .upload-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            padding: 20px;
        }
        .upload-box {
            background: white; border-radius: 20px; padding: 30px;
            text-align: center; width: 100%; max-width: 300px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ===== TOGGLE SWITCH ===== */
        .toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            border-radius: 14px; padding: 14px 16px;
            margin-top: 15px; margin-bottom: 5px;
            transition: background 0.3s ease;
        }
        .toggle-row.off { background: #fde8e8; }
        .toggle-row.on  { background: #d4f7dc; }
        .toggle-label {
            font-weight: 700; font-size: 0.95rem; color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
        }
        .toggle-switch {
            position: relative; width: 56px; height: 32px; flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-track {
            position: absolute; inset: 0; border-radius: 32px;
            background: #f5a5a5; cursor: pointer; transition: background 0.25s ease;
        }
        .toggle-track::after {
            content: ''; position: absolute;
            width: 26px; height: 26px; border-radius: 50%; background: white;
            top: 3px; left: 3px;
            transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch input:checked + .toggle-track { background: #4cd964; }
        .toggle-switch input:checked + .toggle-track::after { transform: translateX(24px); }

        /* ===== CHAT PANEL (Mobile Bottom-Up) ===== */
        .chat-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 999;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .chat-overlay.open { opacity: 1; pointer-events: all; }

        .chat-panel {
            position: fixed; left: 0; right: 0; bottom: 0; height: 85vh;
            width: 100%; background: var(--white);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -8px 40px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
        }
        .chat-panel.open { transform: translateY(0); }

        .chat-panel-header {
            padding: 16px 20px; border-bottom: 1px solid var(--gray);
            display: flex; align-items: center; gap: 12px; flex-shrink: 0;
        }
        .chat-panel-header img {
            width: 48px; height: 48px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--sibir-blue); flex-shrink: 0;
        }
        .chat-panel-header .close-btn {
            margin-left: auto; background: var(--gray); border: none;
            width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
            font-size: 1.1rem; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0;
        }
        .chat-panel-header .close-btn:hover { background: #ee5253; color: white; }

        .chat-messages {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .chat-bubble {
            max-width: 85%; padding: 12px 16px; border-radius: 20px;
            font-size: 0.95rem; line-height: 1.45; word-break: break-word;
        }
        .chat-bubble.received {
            background: var(--gray); border-bottom-left-radius: 4px; align-self: flex-start;
        }
        .chat-bubble.sent {
            background: var(--sibir-blue); color: white;
            border-bottom-right-radius: 4px; align-self: flex-end;
        }
        .chat-bubble .bubble-time {
            font-size: 0.75rem; opacity: 0.6; margin-top: 6px; display: block; text-align: right;
        }
        .chat-bubble.received .bubble-time { text-align: left; }
        .chat-bubble img.bubble-photo {
            max-width: 100%; border-radius: 12px; display: block; margin-top: 8px; cursor: pointer;
        }
        .chat-date-sep {
            text-align: center; font-size: 0.8rem; color: var(--text-muted);
            background: var(--gray); padding: 4px 14px; border-radius: 20px;
            align-self: center; margin: 8px 0; font-weight: 600;
        }
        .chat-panel-input {
            padding: 12px 16px 24px 16px; border-top: 1px solid var(--gray);
            display: flex; gap: 10px; align-items: flex-end; flex-shrink: 0; background: #fff;
        }
        .chat-panel-input textarea {
            flex: 1; border: 1.5px solid var(--border-color); border-radius: 20px;
            padding: 12px 16px; font-family: inherit; font-size: 0.95rem;
            resize: none; outline: none; height: 48px; max-height: 120px;
            box-sizing: border-box; line-height: 1.4; display: block; margin: 0;
        }
        .chat-panel-input textarea:focus { border-color: var(--sibir-blue); }
        .chat-panel-input .send-btn {
            width: 48px; height: 48px; border-radius: 50%; background: var(--sibir-blue);
            color: white; border: none; cursor: pointer; font-size: 1.3rem;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; flex-shrink: 0; padding-left: 4px; /* –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏ */
        }
        .chat-panel-input .send-btn:hover { background: var(--sibir-dark); }
        .chat-empty { text-align: center; color: var(--text-muted); font-size: 0.95rem; margin: auto; padding: 40px 0; }

        /* ===== QUIZ TAB ===== */
        .quiz-q-card {
            background: var(--gray); border-radius: 16px; padding: 16px;
            margin-bottom: 16px; border: 2px solid transparent; transition: 0.2s;
        }
        .quiz-q-card.active-q { border-color: #9ef01a; background: #f4fff0; box-shadow: 0 0 10px rgba(158,240,26,0.2); }
        .quiz-q-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
        .quiz-q-num { font-weight: 800; font-size: 0.9rem; color: var(--sibir-dark); }
        .quiz-active-badge { background: #9ef01a; color: #1a5c00; padding: 3px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
        .quiz-q-text { font-size: 1.05rem; font-weight: 600; margin-bottom: 16px; line-height: 1.4; }
        
        /* –ò–∑–º–µ–Ω–µ–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ */
        .quiz-answers-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        .quiz-answer-block {
            background: white; border-radius: 12px; padding: 12px 14px;
            border-left: 5px solid #ddd; font-size: 0.9rem;
        }
        .quiz-answer-block.is-correct { border-left-color: #10ac84; background: #f0fff8; }
        .quiz-answer-label { font-weight: 800; font-size: 1rem; margin-bottom: 4px; }
        .quiz-answer-text { color: var(--text-main); margin-bottom: 4px; font-size: 0.9rem; line-height: 1.3;}
        .quiz-answer-keys { color: var(--text-muted); font-size: 0.8rem; }
        .quiz-response-badge {
            background: var(--sibir-blue); color: white;
            padding: 2px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;
            margin-left: auto;
        }
        .quiz-mode-btn { 
            flex: 1; padding: 12px; border-radius: 12px; border: 2px solid var(--border-color);
            background: var(--gray); font-weight: 700; font-size: 0.85rem; cursor: pointer;
            transition: 0.2s; font-family: inherit; color: var(--text-main); text-align: center;
        }
        .quiz-mode-btn.selected { background: var(--sibir-dark); color: white; border-color: var(--sibir-dark); }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–π –≥—Ä–∏–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ */
        .quiz-add-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 16px; }
        
        .quiz-add-ans { 
            background: white; border-radius: 12px; padding: 12px;
            border-left: 5px solid #ddd;
        }
        .quiz-add-ans input { height: 42px; font-size: 0.9rem; margin-bottom: 8px; }
        .quiz-add-ans input:last-child { margin-bottom: 0; }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    </style>
</head>
<body>

<div class="top-panel">
    <h2>–ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º</h2>
    <div class="grid-2">
        <button id="mode-voting" class="btn btn-scene" onclick="setActiveMode('voting')">üèí –®–∞–π–±–∞</button>
        <button id="mode-slideshow" class="btn btn-scene" onclick="setActiveMode('slideshow')">üì∏ –°–ª–∞–π–¥</button>
        <button id="mode-lookslike" class="btn btn-scene" onclick="setActiveMode('lookslike')">üëØ Looks Like</button>
        <button id="mode-mvp" class="btn btn-scene" onclick="setActiveMode('mvp')">üèÜ –ò–≥—Ä–æ–∫</button>
        <button id="mode-noise" class="btn btn-scene" onclick="setActiveMode('noise')">üîä –®—É–º–æ–º–µ—Ä</button>
        <button id="mode-quiz" class="btn btn-scene" onclick="setActiveMode('quiz')">‚ùì –ö–≤–∏–∑</button>
    </div>

    <div id="controls-voting">
        <h2 style="margin-top:20px;">–°—Ü–µ–Ω—ã: –ü–µ—Ä–≤–∞—è —à–∞–π–±–∞</h2>
        <div class="grid-2">
            <button id="scene-announcement" class="btn btn-scene" onclick="setScene('announcement')">–ê–Ω–æ–Ω—Å</button>
            <button id="scene-qr" class="btn btn-scene" onclick="setScene('qr')">QR-–∫–æ–¥</button>
            <button id="scene-roulette" class="btn btn-scene" onclick="setScene('roulette')">–†—É–ª–µ—Ç–∫–∞</button>
            <button id="scene-winner" class="btn btn-scene" onclick="setScene('winner')">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
        </div>
        <button class="btn" style="width:100%; border: 1px solid var(--border-color); background:#05caff" onclick="pickWinnerManual()">üé≤ –ü–µ—Ä–µ–≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</button>
        <div class="toggle-row off" id="toggle-row-fg">
            <div class="toggle-label">üèí –ü—Ä–∏—ë–º –≥–æ–ª–æ—Å–æ–≤</div>
            <label class="toggle-switch">
                <input type="checkbox" id="toggle-first-goal" onchange="onVoteToggle('first_goal', this.checked)">
                <div class="toggle-track"></div>
            </label>
        </div>
    </div>

    <div id="controls-slideshow" style="display: none;">
        <h2 style="margin-top:20px;">–°—Ü–µ–Ω—ã: –°–ª–∞–π–¥-—à–æ—É</h2>
        <div class="grid-2">
            <button id="scene-slideshow-qr" class="btn btn-scene" onclick="setScene('slideshow_qr')">QR-–∫–æ–¥—ã</button>
            <button id="scene-slideshow-photo_feed" class="btn btn-scene" onclick="setScene('slideshow_photo')">–°–ª–∞–π–¥-—à–æ—É</button>
        </div>
    </div>

    <div id="controls-lookslike" style="display: none;">
        <h2 style="margin-top:20px;">–°—Ü–µ–Ω—ã: Looks Like</h2>
        <div class="grid-3">
            <button id="scene-ll-announcement" class="btn btn-scene" onclick="setScene('announcement')">–ê–Ω–æ–Ω—Å</button>
            <button id="scene-ll-character" class="btn btn-scene" onclick="setScene('character')">–ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button id="scene-ll-fan" class="btn btn-scene" onclick="setScene('fan')">–ë–æ–ª–µ–ª—å—â–∏–∫</button>
        </div>
        <p style="font-size: 0.85rem; color: #666; margin-top: 10px; line-height: 1.4;">
            üí° –í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫–Ω–æ–ø–∫–æ–π "–í –≠–§–ò–†" –≤ –º–µ–Ω—é –Ω–∏–∂–µ, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ —Å—Ü–µ–Ω—É "–ü–µ—Ä—Å–æ–Ω–∞–∂".
        </p>
    </div>

    <div id="controls-noise" style="display: none;">
        <h2 style="margin-top:20px;">–®—É–º–æ–º–µ—Ä: –∏–≥—Ä–æ–∫</h2>
        <div class="grid-3">
            <button id="noise-player-38" class="btn btn-scene" onclick="setNoisePlayer('38')">38</button>
            <button id="noise-player-11" class="btn btn-scene" onclick="setNoisePlayer('11')">11</button>
            <button id="noise-player-24" class="btn btn-scene" onclick="setNoisePlayer('24')">24</button>
        </div>
        <p style="font-size: 0.85rem; color: #666; margin-top: 10px; line-height: 1.4;">
            –í—ã–±—Ä–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ —à—É–º–æ–º–µ—Ä–µ –≤ OBS.
        </p>
    </div>

    <div id="controls-mvp" style="display: none;"> 
        <h2 style="margin-top:20px;">–°—Ü–µ–Ω—ã: –ò–≥—Ä–æ–∫ –º–∞—Ç—á–∞</h2>
        <div class="grid-2">
            <button id="scene-mvp-winline_logo" class="btn btn-scene" onclick="setScene('winline_logo')">üü° Winline</button>
            <button id="scene-mvp-announcement" class="btn btn-scene" onclick="setScene('announcement')">üì¢ –ê–Ω–æ–Ω—Å</button>
            <button id="scene-mvp-qr" class="btn btn-scene" onclick="setScene('qr')">QR-–∫–æ–¥</button>
            <button id="scene-mvp-winner" class="btn btn-scene" onclick="setScene('winner')">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
        </div>
        <div class="toggle-row off" id="toggle-row-mvp">
            <div class="toggle-label">üèÜ –ü—Ä–∏—ë–º –≥–æ–ª–æ—Å–æ–≤</div>
            <label class="toggle-switch">
                <input type="checkbox" id="toggle-mvp" onchange="onVoteToggle('match_mvp', this.checked)">
                <div class="toggle-track"></div>
            </label>
        </div>
    </div>

    <div id="controls-quiz" style="display: none;">
        <h2 style="margin-top:20px;">–°—Ü–µ–Ω—ã: –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h2>
        <div class="grid-2">
            <button id="scene-quiz-announcement" class="btn btn-scene" onclick="setScene('quiz_announcement')">üì£ –ê–Ω–æ–Ω—Å</button>
            <button id="scene-quiz-qr" class="btn btn-scene" onclick="setScene('quiz_qr')">üì± QR-–∫–æ–¥—ã</button>
            <button id="scene-quiz-question" class="btn btn-scene" onclick="setScene('quiz_question')">‚ùì –í–æ–ø—Ä–æ—Å</button>
            <button id="scene-quiz-results" class="btn btn-scene" onclick="setScene('quiz_results')">üìä –ò—Ç–æ–≥–∏</button>
            <button id="scene-quiz-roulette" class="btn btn-scene" onclick="quizLaunchRoulette()">üé≤ –†—É–ª–µ—Ç–∫–∞</button>
            <button id="scene-quiz-winner" class="btn btn-scene" onclick="quizPickWinner()">üèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª—å</button>
        </div>
        <button class="btn" style="width:100%; border: 1px solid var(--border-color); background:#05caff" onclick="quizPickWinner()">üé≤ –ü–µ—Ä–µ–≤—ã–±—Ä–∞—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</button>
        <div class="toggle-row off" id="toggle-row-quiz">
            <div class="toggle-label">‚ùì –ü—Ä–∏—ë–º –æ—Ç–≤–µ—Ç–æ–≤</div>
            <label class="toggle-switch">
                <input type="checkbox" id="toggle-quiz" onchange="onVoteToggle('quiz', this.checked)">
                <div class="toggle-track"></div>
            </label>
        </div>
    </div>
</div>

<div class="main-panel">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('votes')">–ì–æ–ª–æ—Å–∞</button>
        <button class="tab-btn" onclick="switchTab('chat')">–≠—Ñ–∏—Ä (–ß–∞—Ç)</button>
        <button class="tab-btn" onclick="switchTab('lookslike')">Looks Like</button>
        <button class="tab-btn" onclick="switchTab('mvp')">–ò–≥—Ä–æ–∫ –º–∞—Ç—á–∞</button>
        <button class="tab-btn" onclick="switchTab('quiz')">‚ùì –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</button>
    </div>

    <div id="tab-votes" class="tab-content active">
        <div class="flex-between" style="margin-bottom: 20px;">
            <select id="filterMode" onchange="renderVotes()" style="width: 100%; margin-bottom: 10px;">
                <option value="all">–í—Å–µ –≥–æ–ª–æ—Å–∞</option>
                <option value="correct">–¢–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</option>
            </select>
            <div class="flex-between" style="width: 100%;">
                <b id="vCount" style="color: var(--sibir-blue); font-size: 1.1rem;"></b>
                <button class="btn" style="background: #ee5253; color: white; padding: 10px 15px;" onclick="resetVotes()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        <div id="votesList" class="votes-list"></div>
    </div>

    <div id="tab-chat" class="tab-content">
        <div class="grid-2" style="margin-bottom: 20px;">
            <button class="btn" style="background: #ff9f43; color: white; padding: 12px 10px; font-size: 0.85rem;" onclick="clearApprovedPhotos()">üßπ –û—á–∏—Å—Ç–∏—Ç—å —ç—Ñ–∏—Ä</button>
            <button class="btn" style="background: #ee5253; color: white; padding: 12px 10px; font-size: 0.85rem;" onclick="clearChat()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë</button>
        </div>
        <div id="messagesList"></div>
    </div>

    <div id="tab-lookslike" class="tab-content">
        <div style="background: var(--gray); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
            <h3 style="margin:0 0 15px 0">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
            <input type="text" id="charName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞">
            <input type="file" id="charFile" accept="image/*" style="padding: 12px 15px; background: white;">
            <div id="cropWrapper" class="crop-container">
                <img id="imageToCrop" src="">
            </div>
            <button id="btnSaveChar" class="btn btn-primary" onclick="saveCharacter()" style="display: none; margin-top: 15px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="flex-between" style="margin-bottom: 15px;">
            <h3 style="margin: 0;">–ü–µ—Ä—Å–æ–Ω–∞–∂–∏</h3>
            <button class="btn" style="background: #ee5253; color: white; padding: 10px 15px;" onclick="clearAllCharacters()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
        </div>
        <div id="charactersList" class="char-grid"></div>
    </div>

    <div id="tab-mvp" class="tab-content">
        <div class="flex-between" style="margin-bottom: 20px;">
            <h3 style="margin: 0;">–ì–æ–ª–æ—Å–∞ –∑–∞ MVP</h3>
            <button class="btn" style="background: #ee5253; color: white; padding: 10px 15px;" onclick="resetMvpVotes()">üßπ –°–±—Ä–æ—Å</button>
        </div>
        <b id="mvpCount" style="color: var(--sibir-blue); display: block; margin-bottom: 15px; font-size: 1.1rem;"></b>
        <div id="mvpResultsList"></div>
        
        <div style="background: var(--gray); padding: 20px; border-radius: 16px; margin-top: 30px;">
            <h3 style="margin: 0 0 15px 0;">–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤ (—Ñ–æ—Ç–æ)</h3>
            <div id="mvpPlayersList"></div>
        </div>
    </div>

    <div id="tab-quiz" class="tab-content">
        <div style="background: var(--gray); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 12px 0;">–†–µ–∂–∏–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                <button id="quiz-mode-all" class="quiz-mode-btn" onclick="setQuizWinnerMode('all_correct')">üéØ –í—Å–µ –≤–µ—Ä–Ω—ã–µ</button>
                <button id="quiz-mode-any" class="quiz-mode-btn" onclick="setQuizWinnerMode('any_correct')">‚ö° –•–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π</button>
            </div>
            <p style="font-size: 0.85rem; color: #666; margin: 0; line-height: 1.4;">
                <b>–í—Å–µ –≤–µ—Ä–Ω—ã–µ:</b> –≤ —Ä—É–ª–µ—Ç–∫—É –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, –∫—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.<br>
                <b>–•–æ—Ç—è –±—ã –æ–¥–∏–Ω:</b> –∫–∞–∂–¥—ã–π –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç = +1 —à–∞–Ω—Å. 
            </p>
        </div>

        <div style="background: var(--gray); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0;">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</h3>
            <input type="text" id="quiz-q-text" placeholder="–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞" style="margin-bottom: 15px;">
            <div class="quiz-add-grid">
                <div class="quiz-add-ans" style="border-left-color: #05caff;">
                    <div class="flex-between" style="margin-bottom:8px;">
                        <span style="font-weight:800; color:#05caff; font-size:1.1rem;">A</span>
                        <input type="checkbox" id="quiz-a0-correct" style="width:24px;height:24px; margin:0;">
                    </div>
                    <input type="text" id="quiz-a0-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç A">
                    <input type="text" id="quiz-a0-keys" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞" style="margin-bottom:0;">
                </div>
                <div class="quiz-add-ans" style="border-left-color: #ff9f43;">
                    <div class="flex-between" style="margin-bottom:8px;">
                        <span style="font-weight:800; color:#ff9f43; font-size:1.1rem;">B</span>
                        <input type="checkbox" id="quiz-a1-correct" style="width:24px;height:24px; margin:0;">
                    </div>
                    <input type="text" id="quiz-a1-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç B">
                    <input type="text" id="quiz-a1-keys" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞" style="margin-bottom:0;">
                </div>
                <div class="quiz-add-ans" style="border-left-color: #9ef01a;">
                    <div class="flex-between" style="margin-bottom:8px;">
                        <span style="font-weight:800; color:#3d8b00; font-size:1.1rem;">C</span>
                        <input type="checkbox" id="quiz-a2-correct" style="width:24px;height:24px; margin:0;">
                    </div>
                    <input type="text" id="quiz-a2-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç C">
                    <input type="text" id="quiz-a2-keys" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞" style="margin-bottom:0;">
                </div>
                <div class="quiz-add-ans" style="border-left-color: #ee5253;">
                    <div class="flex-between" style="margin-bottom:8px;">
                        <span style="font-weight:800; color:#ee5253; font-size:1.1rem;">D</span>
                        <input type="checkbox" id="quiz-a3-correct" style="width:24px;height:24px; margin:0;">
                    </div>
                    <input type="text" id="quiz-a3-text" placeholder="–í–∞—Ä–∏–∞–Ω—Ç D">
                    <input type="text" id="quiz-a3-keys" placeholder="–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞" style="margin-bottom:0;">
                </div>
            </div>
            <button class="btn btn-primary" onclick="addQuizQuestion()">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
        </div>

        <div class="flex-between" style="margin-bottom: 15px;">
            <h3 style="margin: 0;">–í–æ–ø—Ä–æ—Å—ã</h3>
            <div style="display: flex; gap: 8px;">
                <button class="btn" style="background: #ff9f43; color: white; padding: 10px; font-size: 0.85rem;" onclick="clearQuizResponses()">üßπ –û—Ç–≤–µ—Ç—ã</button>
                <button class="btn" style="background: #ee5253; color: white; padding: 10px; font-size: 0.85rem;" onclick="clearAllQuizQuestions()">üóëÔ∏è –í—Å—ë</button>
            </div>
        </div>
        <div id="quizQuestionsList"></div>

        <div style="margin-top: 30px;">
            <h3 style="margin: 0 0 15px 0;" id="quizRespondentsTitle">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <div id="quizRespondentsList" class="votes-list"></div>
        </div>
    </div>
</div>

<div class="bottom-panel">
    <div id="players-controls" style="margin-bottom: 25px;">
        <h2>–ê–≤—Ç–æ—Ä –≥–æ–ª–∞</h2>
        <select id="goalScorer" onchange="setScorer(this.value)"></select>
        
        <h2 style="margin-top: 20px;">–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤</h2>
        <input type="text" id="pName" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞">
        <input type="text" id="pKeys" placeholder="–ù–æ–º–µ—Ä, —Ñ–∞–º–∏–ª–∏—è (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)">
        <button class="btn btn-primary" style="background: var(--sibir-dark);" onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        <div id="playersList" style="margin-top:20px;"></div>
    </div>

    <hr style="border:0; border-top: 1px solid var(--border-color); margin: 25px 0;">

    <h2>–§–æ–Ω –æ–≤–µ—Ä–ª–µ—è</h2>
    <input type="text" id="bgUrl" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ .webm –∏–ª–∏ .jpg">
    <div class="grid-2">
        <button class="btn btn-scene" onclick="updateBg()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="btn btn-scene" style="color: #ee5253;" onclick="removeBackground()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
</div>

<div class="chat-overlay" id="chatOverlay" onclick="closeChat()"></div>
<div class="chat-panel" id="chatPanel">
    <div class="chat-panel-header" id="chatHeader">
        <img id="chatAvatar" src="" onerror="this.src='media/tg_logo.png'">
        <div style="overflow: hidden;">
            <div id="chatName" style="font-weight:700; font-size:1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
            <div id="chatHandle" style="color:var(--text-muted); font-size:0.9rem;"></div>
        </div>
        <button class="close-btn" onclick="closeChat()">‚úï</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div style="position: relative; background: #fff;">
        <div class="emoji-picker-popup" id="emojiPickerPopup">
            <div class="emoji-cats" id="emojiCats"></div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
        <div class="chat-panel-input">
            <button class="emoji-btn" onclick="toggleEmojiPicker(event)" title="–°–º–∞–π–ª–∏–∫–∏">üòä</button>
            <textarea id="chatReplyInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChatReply();}"></textarea>
            <button class="send-btn" onclick="sendChatReply()">‚û§</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    
    const firebaseConfig = {
        apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
        authDomain: "arenawork-94e68.firebaseapp.com",
        databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
        projectId: "arenawork-94e68",
        storageBucket: "arenawork-94e68.firebasestorage.app",   
        messagingSenderId: "504372844993",
        appId: "1:504372844993:web:1783bb75879ee074953740"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentData = {};
    const tgLogo = "media/tg_logo.png";
    let cropper;
    let editingCharId = null;

    const UPLOAD_URL = 'http://localhost:3000/upload';

    async function uploadViaBot(blob, folder) {
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('folder', folder);
        const res = await fetch(UPLOAD_URL, { method: 'POST', body: formData });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.url) throw new Error('–ù–µ—Ç URL –≤ –æ—Ç–≤–µ—Ç–µ');
        return data.url;
    }

    function showUploadOverlay(text) {
        const el = document.createElement('div');
        el.className = 'upload-overlay';
        el.id = 'upload-overlay';
        el.innerHTML = `<div class="upload-box">
            <div style="font-size:3rem;margin-bottom:15px">‚òÅÔ∏è</div>
            <div style="font-weight:700;font-size:1.2rem">${text}</div>
            <div style="color:#999;font-size:0.95rem;margin-top:10px">–ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞ Yandex Cloud...</div>
        </div>`;
        document.body.appendChild(el);
    }

    function hideUploadOverlay(success = true) {
        const el = document.getElementById('upload-overlay');
        if (!el) return;
        el.querySelector('.upload-box').innerHTML = `
            <div style="font-size:3.5rem;margin-bottom:10px">${success ? '‚úÖ' : '‚ùå'}</div>
            <div style="font-weight:700;font-size:1.2rem">${success ? '–ì–æ—Ç–æ–≤–æ!' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</div>`;
        setTimeout(() => el.remove(), 1200);
    }

    window.onVoteToggle = (mode, checked) => {
        if (checked) {
            set(ref(db, 'competition/acceptingVotes'),    mode === 'first_goal');
            set(ref(db, 'competition/acceptingMvpVotes'), mode === 'match_mvp');
            set(ref(db, 'competition/acceptingQuizAnswers'), mode === 'quiz');
            set(ref(db, 'competition/votingMode'), mode);
        } else {
            set(ref(db, 'competition/acceptingVotes'),    false);
            set(ref(db, 'competition/acceptingMvpVotes'), false);
            set(ref(db, 'competition/acceptingQuizAnswers'), false);
        }
    };

    window.toggleVoting = () => {};
    window.setVotingMode = (mode) => { onVoteToggle(mode, true); };
    
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(`tab-${tab}`).classList.add('active');
        if (tab === 'mvp') renderMvpPlayers();
    };

    window.setActiveMode = (mode) => {
        set(ref(db, 'competition/activeMode'), mode);
        if (mode === 'lookslike') window.switchTab('lookslike');
        if (mode === 'quiz') window.switchTab('quiz');
    };

    window.resetMvpVotes = () => {
        if(confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –∑–∞ –∏–≥—Ä–æ–∫–∞ –º–∞—Ç—á–∞?")) remove(ref(db, 'competition/mvpVotes'));
    };
    
    window.setScene = (scene) => {
        const mode = currentData.activeMode || 'voting';
        if (mode === 'voting') {
            if (scene === 'roulette') {
                const votes = currentData.votes || {};
                const scorer = currentData.scorer;
                if (!scorer) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–≤—Ç–æ—Ä–∞ –≥–æ–ª–∞!"); return; }
                const luckyOnes = Object.values(votes).filter(v => v.votedFor === scorer);
                set(ref(db, 'competition/votingState'), scene);
                if (luckyOnes.length > 0) {
                    setTimeout(() => {
                        const winner = luckyOnes[Math.floor(Math.random() * luckyOnes.length)];
                        winner.selectionId = Date.now();
                        set(ref(db, 'competition/winner'), winner);
                    }, 600);
                }
            } else {
                set(ref(db, 'competition/votingState'), scene);
            }
        } else if (mode === 'slideshow') {
            set(ref(db, 'competition/slideshowState'), scene);
        } else if (mode === 'lookslike') {
            if (scene === 'character') {
                const pending = currentData.lookslike?.pendingCharacter;
                if (pending) set(ref(db, 'competition/lookslike/activeCharacter'), pending);
            }
            set(ref(db, 'competition/lookslikeState'), scene);
        } else if (mode === 'mvp') {
            set(ref(db, 'competition/mvpState'), scene);
            set(ref(db, 'competition/mvpStateTs'), Date.now());
        } else if (mode === 'quiz') {
            const prevScene = currentData.quizState;
            if (prevScene === 'quiz_question' && scene !== 'quiz_question') {
                const activeId = currentData.quiz?.activeQuestionId;
                if (activeId) {
                    set(ref(db, 'competition/acceptingQuizAnswers'), false);
                    set(ref(db, 'competition/quiz/revealQuestionId'), activeId);
                    set(ref(db, 'competition/quizState'), 'quiz_answer_reveal');
                    set(ref(db, 'competition/quizStateTs'), Date.now());
                    setTimeout(() => {
                        set(ref(db, 'competition/quizState'), scene);
                        set(ref(db, 'competition/quizStateTs'), Date.now());
                    }, 4000);
                    return;
                }
            }
            set(ref(db, 'competition/quizState'), scene);
            set(ref(db, 'competition/quizStateTs'), Date.now());
        }
    };

    window.pickWinnerManual = () => {
        const votes = currentData.votes || {};
        const scorer = currentData.scorer;
        if (!scorer) { alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–≤—Ç–æ—Ä–∞ –≥–æ–ª–∞!"); return; }
        const luckyOnes = Object.values(votes).filter(v => v.votedFor === scorer);
        if (luckyOnes.length > 0) {
            const winner = luckyOnes[Math.floor(Math.random() * luckyOnes.length)];
            winner.selectionId = Date.now(); 
            set(ref(db, 'competition/winner'), winner);
            alert("–ù–æ–≤—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å: " + winner.name);
        } else {
            alert("–ù–∏–∫—Ç–æ –Ω–µ —É–≥–∞–¥–∞–ª —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞!");
        }
    };

    window.updateBg = () => { const url = document.getElementById('bgUrl').value; if(url) set(ref(db, 'competition/background'), url); };
    window.removeBackground = () => {
        if(confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ–Ω –Ω–∞ –æ–≤–µ—Ä–ª–µ–µ?")) {
            set(ref(db, 'competition/background'), null);
            document.getElementById('bgUrl').value = '';
        }
    };

    window.togglePhotoSelection = (id, status) => set(ref(db, `competition/allMessages/${id}/approved`), !status);
    window.removeMessage = (id) => confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?") && remove(ref(db, `competition/allMessages/${id}`));
    window.clearChat = () => confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π?") && remove(ref(db, 'competition/allMessages'));
    window.resetVotes = () => confirm("–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –≥–æ–ª–æ—Å–æ–≤ (–ü–µ—Ä–≤–∞—è —à–∞–π–±–∞)?") && remove(ref(db, 'competition/votes'));
    
    window.clearApprovedPhotos = () => {
        if (confirm("–£–±—Ä–∞—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ –∏–∑ —ç—Ñ–∏—Ä–∞?")) {
            const msgs = currentData.allMessages || {};
            const updates = {};
            for(let id in msgs) {
                if(msgs[id].approved) updates[`competition/allMessages/${id}/approved`] = false;
            }
            if(Object.keys(updates).length) update(ref(db), updates);
        }
    };

    window.clearAllCharacters = () => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–∑ –±–∞–∑—ã?")) remove(ref(db, 'competition/lookslike/characters'));
    };

    window.sendReply = (chatId, name) => {
        if (!chatId) { alert("–ù–µ—Ç Chat ID. –ù–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å."); return; }
        const msg = prompt(`–û—Ç–≤–µ—Ç –¥–ª—è ${name}:`);
        if (msg) {
            push(ref(db, 'competition/replies'), { chatId, text: msg });
            push(ref(db, `competition/sentReplies/${chatId}`), { text: msg, timestamp: Date.now() });
        }
    };

    // ===== EMOJI PICKER =====
    const EMOJI_CATS = [
        { icon: 'üòÄ', label: '–°–º–∞–π–ª—ã', emojis: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü•∏','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü´£','ü§ó','ü´°','ü§î','ü´†','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï'] },
        { icon: 'üëç', label: '–ñ–µ—Å—Ç—ã', emojis: ['üëç','üëé','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü´∞','ü§ô','ü§ò','ü§ü','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','ü´µ','üëã','ü§ö','üñêÔ∏è','‚úã','üññ','ü´±','ü´≤','üí™','ü¶æ','üôè','ü§≤','üëè','ü´∂','üôå','ü§ù','üíÖ','ü§≥'] },
        { icon: '‚ù§Ô∏è', label: '–°–µ—Ä–¥—Ü–∞', emojis: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚ô•Ô∏è','ü´Ä','üíã'] },
        { icon: 'üèí', label: '–°–ø–æ—Ä—Ç', emojis: ['üèí','üèë','ü•Ö','üéØ','‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üèì','üè∏','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏Ô∏è','ü•å','üéø','üèÜ','ü•á','ü•à','ü•â','üèÖ','üéñÔ∏è'] },
        { icon: 'üî•', label: '–°–∏–º–≤–æ–ª—ã', emojis: ['üî•','‚≠ê','üåü','üí´','‚ú®','üí•','üéâ','üéä','üéà','üéÅ','üéÄ','üéóÔ∏è','üè≥Ô∏è','üöÄ','‚ö°','üåà','‚òÄÔ∏è','üåô','üíØ','‚úÖ','‚ùå','‚ÄºÔ∏è','‚ùì','üí¨','üì£','üì¢','üëÄ','üÜï','üÜí','üÜì','üî¥','üü†','üü°','üü¢','üîµ','üü£','‚ö´','‚ö™'] },
    ];
    let activeEmojiCat = 0;

    function initEmojiPicker() {
        const catsEl = document.getElementById('emojiCats');
        catsEl.innerHTML = EMOJI_CATS.map((c, i) =>
            `<button class="emoji-cat-btn ${i === 0 ? 'active' : ''}" onclick="setEmojiCat(${i})" title="${c.label}">${c.icon}</button>`
        ).join('');
        renderEmojiGrid(0);
    }

    window.setEmojiCat = (i) => {
        activeEmojiCat = i;
        document.querySelectorAll('.emoji-cat-btn').forEach((b, idx) => b.classList.toggle('active', idx === i));
        renderEmojiGrid(i);
    };

    function renderEmojiGrid(i) {
        const grid = document.getElementById('emojiGrid');
        grid.innerHTML = EMOJI_CATS[i].emojis.map(e =>
            `<button onclick="insertEmoji('${e}')" title="${e}">${e}</button>`
        ).join('');
    }

    window.insertEmoji = (emoji) => {
        const ta = document.getElementById('chatReplyInput');
        const start = ta.selectionStart, end = ta.selectionEnd;
        const val = ta.value;
        ta.value = val.slice(0, start) + emoji + val.slice(end);
        ta.selectionStart = ta.selectionEnd = start + emoji.length;
        ta.focus();
    };

    window.toggleEmojiPicker = (e) => {
        e.stopPropagation();
        const picker = document.getElementById('emojiPickerPopup');
        picker.classList.toggle('open');
    };

    document.addEventListener('click', (e) => {
        const picker = document.getElementById('emojiPickerPopup');
        if (picker && !picker.contains(e.target)) picker.classList.remove('open');
    });

    initEmojiPicker();

    // ===== CHAT PANEL =====
    let activeChatId = null;
    let activeChatUnsub = null;

    window.openChat = (chatId, name, avatar, handle) => {
        if (!chatId) { alert("–ù–µ—Ç Chat ID –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"); return; }
        activeChatId = chatId;

        document.getElementById('chatName').textContent = name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
        document.getElementById('chatHandle').textContent = handle ? `@${handle}` : '';
        const avatarEl = document.getElementById('chatAvatar');
        avatarEl.src = (avatar && avatar.length > 10) ? avatar : tgLogo;

        document.getElementById('chatPanel').classList.add('open');
        document.getElementById('chatOverlay').classList.add('open');
        document.getElementById('chatReplyInput').value = '';
        document.getElementById('chatReplyInput').focus();

        renderChatMessages(chatId);
    };

    window.closeChat = () => {
        activeChatId = null;
        document.getElementById('chatPanel').classList.remove('open');
        document.getElementById('chatOverlay').classList.remove('open');
    };

    function renderChatMessages(chatId) {
        const container = document.getElementById('chatMessages');
        if (!chatId) return;

        const allMsgs = currentData.allMessages || {};
        const received = Object.values(allMsgs)
            .filter(m => String(m.chatId) === String(chatId))
            .map(m => ({ type: 'received', text: m.text || '', photo: m.isImage ? m.photo : null, ts: m.timestamp || 0 }));

        const sentData = currentData.sentReplies?.[chatId] || {};
        const sent = Object.values(sentData)
            .map(r => ({ type: 'sent', text: r.text || '', ts: r.timestamp || 0 }));

        const all = [...received, ...sent].sort((a, b) => a.ts - b.ts);

        if (all.length === 0) {
            container.innerHTML = '<div class="chat-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            return;
        }

        let html = '';
        let lastDateStr = '';
        all.forEach(msg => {
            const date = new Date(msg.ts);
            const dateStr = date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            const timeStr = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');

            if (dateStr !== lastDateStr) {
                html += `<div class="chat-date-sep">${dateStr}</div>`;
                lastDateStr = dateStr;
            }

            html += `<div class="chat-bubble ${msg.type}">`;
            if (msg.text) html += `<span>${msg.text}</span>`;
            if (msg.photo) html += `<img class="bubble-photo" src="${msg.photo}" onclick="window.open('${msg.photo}')">`;
            html += `<span class="bubble-time">${timeStr}</span></div>`;
        });

        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
    }

    window.sendChatReply = async () => {
        const input = document.getElementById('chatReplyInput');
        const text = input.value.trim();
        if (!text || !activeChatId) return;

        input.value = '';
        const ts = Date.now();
        await push(ref(db, 'competition/replies'), { chatId: activeChatId, text });
        await push(ref(db, `competition/sentReplies/${activeChatId}`), { text, timestamp: ts });
    };

    window.addPlayer = () => {
        const name = document.getElementById('pName').value;
        const keywords = document.getElementById('pKeys').value;
        if(name && keywords) {
            push(ref(db, 'competition/players'), { name, keywords });
            document.getElementById('pName').value = '';
            document.getElementById('pKeys').value = '';
        }
    };

    window.removePlayer = (id) => remove(ref(db, `competition/players/${id}`));
    window.setScorer = (val) => set(ref(db, 'competition/scorer'), val);
    window.removeVote = (id) => remove(ref(db, `competition/votes/${id}`));

    window.uploadPlayerPhoto = (playerId) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/png,image/jpeg,image/jpg';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showUploadOverlay('üì∑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ...');
            try {
                const photoUrl = await uploadViaBot(file, 'players');
                await update(ref(db, `competition/players/${playerId}`), { photo: photoUrl });
                hideUploadOverlay(true);
                renderMvpPlayers();
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                hideUploadOverlay(false);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message + '\n–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω (–ø–æ—Ä—Ç 3000)');
            }
        };
        input.click();
    };

    window.deletePlayerPhoto = (playerId) => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –∏–≥—Ä–æ–∫–∞?')) {
            update(ref(db, `competition/players/${playerId}`), { photo: null });
        }
    };

    document.getElementById('charFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const image = document.getElementById('imageToCrop');
                image.src = event.target.result;
                document.getElementById('cropWrapper').style.display = 'block';
                document.getElementById('btnSaveChar').style.display = 'block';
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, { aspectRatio: 8 / 9, viewMode: 1 });
            };
            reader.readAsDataURL(file);
        }
    });

    window.saveCharacter = async () => {
        const name = document.getElementById('charName').value;
        if (!name) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!"); return; }
        if (!cropper) { alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ!"); return; }
        showUploadOverlay('üëØ –ó–∞–≥—Ä—É–∂–∞–µ–º...');
        try {
            const canvas = cropper.getCroppedCanvas({ height: 800 });
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
            const imageUrl = await uploadViaBot(blob, 'characters');
            await push(ref(db, 'competition/lookslike/characters'), { name, image: imageUrl });
            hideUploadOverlay(true);
            cropper.destroy(); cropper = null;
            document.getElementById('charName').value = '';
            document.getElementById('charFile').value = '';
            document.getElementById('imageToCrop').src = '';
            document.getElementById('cropWrapper').style.display = 'none';
            document.getElementById('btnSaveChar').style.display = 'none';
        } catch (err) {
            console.error('–û—à–∏–±–∫–∞:', err);
            hideUploadOverlay(false);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + err.message);
        }
    };

    window.setActiveCharacter = (id) => set(ref(db, 'competition/lookslike/pendingCharacter'), id);
    window.deleteCharacter = (id) => {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞?")) remove(ref(db, `competition/lookslike/characters/${id}`));
    };

    function updateActiveSceneButtons() {
        const mode = currentData.activeMode || 'voting';
        document.querySelectorAll('[id^="scene-"]').forEach(btn => btn.classList.remove('active'));
        if (mode === 'voting') {
            const btn = document.getElementById(`scene-${currentData.votingState || 'announcement'}`);
            if (btn) btn.classList.add('active');
        } else if (mode === 'slideshow') {
            const map = { slideshow_qr: 'scene-slideshow-qr', slideshow_photo: 'scene-slideshow-photo_feed' };
            const btn = document.getElementById(map[currentData.slideshowState]);
            if (btn) btn.classList.add('active');
        } else if (mode === 'lookslike') {
            const map = { announcement: 'scene-ll-announcement', character: 'scene-ll-character', fan: 'scene-ll-fan' };
            const btn = document.getElementById(map[currentData.lookslikeState]);
            if (btn) btn.classList.add('active');
        } else if (mode === 'mvp') {
            const map = { winline_logo: 'scene-mvp-winline_logo', announcement: 'scene-mvp-announcement', qr: 'scene-mvp-qr', winner: 'scene-mvp-winner' };
            const btn = document.getElementById(map[currentData.mvpState]);
            if (btn) btn.classList.add('active');
        } else if (mode === 'quiz') {
            const map = { quiz_announcement: 'scene-quiz-announcement', quiz_qr: 'scene-quiz-qr', quiz_question: 'scene-quiz-question', quiz_answer_reveal: 'scene-quiz-question', quiz_results: 'scene-quiz-results', quiz_roulette: 'scene-quiz-roulette', quiz_winner: 'scene-quiz-winner' };
            const btn = document.getElementById(map[currentData.quizState]);
            if (btn) btn.classList.add('active');
        }
    }

    onValue(ref(db, 'competition'), (snapshot) => {
        currentData = snapshot.val() || {};
        updateActiveSceneButtons();

        const mode = currentData.activeMode || 'voting';
        document.getElementById('mode-voting').classList.toggle('active', mode === 'voting');
        document.getElementById('mode-slideshow').classList.toggle('active', mode === 'slideshow');
        document.getElementById('mode-lookslike').classList.toggle('active', mode === 'lookslike');
        document.getElementById('mode-mvp').classList.toggle('active', mode === 'mvp');
        document.getElementById('mode-noise').classList.toggle('active', mode === 'noise');
        document.getElementById('mode-quiz').classList.toggle('active', mode === 'quiz');
        
        ['controls-voting','controls-slideshow','controls-lookslike','controls-mvp','controls-noise','controls-quiz']
            .forEach(id => document.getElementById(id).style.display = 'none');

        // –î–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ players-controls –º—ã –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–º–∏ –≤ –Ω–∏–∂–Ω–µ–º –±–ª–æ–∫–µ
        if (mode === 'voting') document.getElementById('controls-voting').style.display = 'block';
        else if (mode === 'slideshow') document.getElementById('controls-slideshow').style.display = 'block';
        else if (mode === 'lookslike') document.getElementById('controls-lookslike').style.display = 'block';
        else if (mode === 'mvp') document.getElementById('controls-mvp').style.display = 'block';
        else if (mode === 'noise') {
            document.getElementById('controls-noise').style.display = 'block';
            const np = currentData.noisePlayer || '38';
            document.getElementById('noise-player-38').classList.toggle('active', np === '38');
            document.getElementById('noise-player-11').classList.toggle('active', np === '11');
            document.getElementById('noise-player-24').classList.toggle('active', np === '24');
        } else if (mode === 'quiz') document.getElementById('controls-quiz').style.display = 'block';

        const fgOn   = !!currentData.acceptingVotes;
        const mvpOn  = !!currentData.acceptingMvpVotes;
        const quizOn = !!currentData.acceptingQuizAnswers;

        const toggleFG   = document.getElementById('toggle-first-goal');
        const toggleMVP  = document.getElementById('toggle-mvp');
        const toggleQuiz = document.getElementById('toggle-quiz');
        const rowFG      = document.getElementById('toggle-row-fg');
        const rowMVP     = document.getElementById('toggle-row-mvp');
        const rowQuiz    = document.getElementById('toggle-row-quiz');

        if (toggleFG)   toggleFG.checked   = fgOn;
        if (toggleMVP)  toggleMVP.checked  = mvpOn;
        if (toggleQuiz) toggleQuiz.checked = quizOn;
        if (rowFG)   rowFG.className   = 'toggle-row ' + (fgOn   ? 'on' : 'off');
        if (rowMVP)  rowMVP.className  = 'toggle-row ' + (mvpOn  ? 'on' : 'off');
        if (rowQuiz) rowQuiz.className = 'toggle-row ' + (quizOn ? 'on' : 'off');

        const winnerMode = currentData.quiz?.winnerMode || 'all_correct';
        const qmAll = document.getElementById('quiz-mode-all');
        const qmAny = document.getElementById('quiz-mode-any');
        if (qmAll) qmAll.classList.toggle('selected', winnerMode === 'all_correct');
        if (qmAny) qmAny.classList.toggle('selected', winnerMode === 'any_correct');

        renderPlayers(); 
        renderVotes(); 
        renderMessages();
        renderCharacters();
        renderMvpResults();
        renderMvpPlayers();
        renderQuiz();
        if (activeChatId) renderChatMessages(activeChatId);
    });

    let lastMsgsHtml = "";
    let lastVotesHtml = "";

    let dragSrcId = null;

    function renderCharacters() {
        const container = document.getElementById('charactersList');
        const chars = currentData.lookslike?.characters || {};
        const pendingId = currentData.lookslike?.pendingCharacter;
        const activeId = currentData.lookslike?.activeCharacter;
        const orderArr = currentData.lookslike?.characterOrder || Object.keys(chars);
        const knownIds = new Set(orderArr);
        const allIds = [...orderArr.filter(id => chars[id]), ...Object.keys(chars).filter(id => !knownIds.has(id))];

        let html = '';
        allIds.forEach(id => {
            const char = chars[id];
            if (!char) return;
            const isPending = (id === pendingId);
            const isActiveInAir = (id === activeId);
            const isEditing = (id === editingCharId);
            html += `
            <div class="char-card ${isActiveInAir ? 'active-char' : ''}" 
                 draggable="true" data-id="${id}"
                 ondragstart="onCharDragStart(event,'${id}')"
                 ondragover="onCharDragOver(event)"
                 ondrop="onCharDrop(event,'${id}')"
                 ondragend="onCharDragEnd(event)">
                <div class="drag-handle">‚†ø‚†ø‚†ø</div>
                <img src="${char.image}" class="char-img">
                <div class="char-info">
                    ${isEditing ? 
                        `<input type="text" id="edit-name-${id}" value="${char.name}" style="margin-bottom: 5px; height: 40px; font-size: 0.85rem;">
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <button class="btn btn-primary" style="flex:1; padding:8px; background:#10ac84" onclick="saveEditName('${id}')">üíæ</button>
                            <button class="btn" style="flex:1; padding:8px; background:#ee5253; color:white" onclick="cancelEditName()">‚úñ</button>
                        </div>` 
                        : 
                        `<div class="char-name" style="display:flex; justify-content:center; align-items:center; gap:8px;">
                            <span>${char.name}</span>
                            <span style="cursor:pointer; font-size:14px; opacity:0.5" onclick="startEditName('${id}')">‚úèÔ∏è</span>
                        </div>`
                    }
                    <button class="btn" style="width:100%; margin-bottom:8px; background: ${isPending ? '#9ef01a' : '#ecf0f1'}; color: ${isPending ? 'white' : 'black'}; font-size: 0.85rem;" onclick="setActiveCharacter('${id}')">
                        ${isPending ? 'üì∫ –í –≠–§–ò–†–ï' : 'üì∫ –í –≠–§–ò–†'}
                    </button>
                    ${isActiveInAir ? '<div style="font-size:11px; color:green; text-align:center; font-weight:700;">‚óè –°–ï–ô–ß–ê–° –í OBS</div>' : ''}
                    <button class="btn" style="width:100%; background:#fab1a0; color:#c0392b; font-size: 0.8rem; margin-top:8px;" onclick="deleteCharacter('${id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    window.onCharDragStart = (e, id) => {
        dragSrcId = id;
        e.currentTarget.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    };
    window.onCharDragOver = (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        document.querySelectorAll('.char-card').forEach(c => c.classList.remove('drag-over'));
        e.currentTarget.classList.add('drag-over');
    };
    window.onCharDragEnd = (e) => {
        document.querySelectorAll('.char-card').forEach(c => { c.classList.remove('dragging'); c.classList.remove('drag-over'); });
    };
    window.onCharDrop = (e, targetId) => {
        e.preventDefault();
        if (dragSrcId === targetId) return;
        const chars = currentData.lookslike?.characters || {};
        const orderArr = currentData.lookslike?.characterOrder || Object.keys(chars);
        const knownIds = new Set(orderArr);
        let allIds = [...orderArr.filter(id => chars[id]), ...Object.keys(chars).filter(id => !knownIds.has(id))];

        const fromIdx = allIds.indexOf(dragSrcId);
        const toIdx   = allIds.indexOf(targetId);
        if (fromIdx < 0 || toIdx < 0) return;
        allIds.splice(fromIdx, 1);
        allIds.splice(toIdx, 0, dragSrcId);
        set(ref(db, 'competition/lookslike/characterOrder'), allIds);
    };

    function renderMessages() {
        const container = document.getElementById('messagesList');
        const msgs = currentData.allMessages || {};
        let list = Object.keys(msgs).map(id => ({id, ...msgs[id]}));
        list.sort((a, b) => b.timestamp - a.timestamp);
        let newHtml = '';
        list.forEach(m => {
            const userAvatar = (m.userPhoto && m.userPhoto.length > 10) ? m.userPhoto : tgLogo;
            const date = m.timestamp ? new Date(m.timestamp) : new Date();
            const timeStr = date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');
            const safeName = (m.name||'').replace(/'/g,"\\'");
            const safeHandle = (m.handle||'').replace(/'/g,"\\'");
            newHtml += `    
                <div class="message-item" style="border-left: 6px solid ${m.approved ? '#10ac84' : '#d1d8e0'};" onclick="openChat('${m.chatId}','${safeName}','${userAvatar}','${safeHandle}')">
                    <div class="message-content">
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                            <img src="${userAvatar}" onerror="this.onerror=null; this.src='${tgLogo}'" style="width:44px; height:44px; border-radius:50%; object-fit: cover; background: #eee;">
                            <div style="flex:1; min-width:0;">
                                <div style="font-weight:700; font-size:0.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.name}</div>
                                <div style="color:#7f8c8d; font-size:0.85rem;">@${m.handle || ''}</div>
                            </div>
                            <span style="font-size: 0.8rem; color: #999;">${timeStr}</span>
                        </div>
                        <div style="font-size: 0.95rem; line-height: 1.4; margin-bottom: 10px;">${m.text || ''}</div>
                        ${m.isImage ? `<div class="photo-container"><img src="${m.photo}" onclick="event.stopPropagation(); window.open('${m.photo}')"></div>` : ''}
                    </div>
                    <div class="message-left">
                        <button class="btn" style="flex:1; background:${m.approved ? '#10ac84' : '#f1f2f6'}; color:${m.approved ? 'white' : 'black'}" 
                                onclick="event.stopPropagation(); togglePhotoSelection('${m.id}', ${m.approved})">
                            ${m.approved ? '‚úÖ –í –≠–§–ò–†–ï' : 'üì∫ –í –≠–§–ò–†'}
                        </button>
                        <button class="btn" style="padding:14px; background:var(--border-color);" onclick="event.stopPropagation(); openChat('${m.chatId}','${safeName}','${userAvatar}','${safeHandle}')">üí¨</button>
                        <button class="btn" style="padding:14px; color:white; background:#ee5253;" onclick="event.stopPropagation(); removeMessage('${m.id}')">üóë</button>
                    </div>
                </div>`;
        });
        if (lastMsgsHtml !== newHtml) { container.innerHTML = newHtml; lastMsgsHtml = newHtml; }
    }

    function renderMvpResults() {
        const container = document.getElementById('mvpResultsList');
        const votes = currentData.mvpVotes || {};
        const voteCounts = {};
        const votersList = {};
        Object.entries(votes).forEach(([userId, vote]) => {
            const player = vote.votedFor;
            voteCounts[player] = (voteCounts[player] || 0) + 1;
            if (!votersList[player]) votersList[player] = [];
            votersList[player].push(vote);
        });
        const sorted = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);
        document.getElementById('mvpCount').textContent = `–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤: ${Object.keys(votes).length}`;
        let html = '<div class="votes-list">';
        sorted.forEach(([player, count], index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
            const voters = votersList[player] || [];
            const votersPreview = voters.slice(0, 3).map(v => v.name).join(', ');
            const moreVoters = voters.length > 3 ? ` –∏ –µ—â—ë ${voters.length - 3}` : '';
            html += `
                <div class="vote-card ${index === 0 ? 'correct' : ''}" style="cursor: pointer" onclick="showVotersPopup('${player}')">
                    <div style="font-size: 28px;">${medal}</div>
                    <div style="font-weight:700; font-size:1.1rem; margin-top:5px;">${player}</div>
                    <div style="color:var(--sibir-blue); font-size:1.8rem; font-weight:800; margin-top:5px;">${count}</div>
                    <div style="color:#7f8c8d; font-size:0.8rem;">${count === 1 ? '–≥–æ–ª–æ—Å' : count < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤'}</div>
                    <div style="font-size:0.75rem; color:#999; margin-top:8px; line-height:1.2;">${votersPreview}${moreVoters}</div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
        window.mvpVotersData = votersList;
    }

    function renderMvpPlayers() {
        const container = document.getElementById('mvpPlayersList');
        if (!container) return;
        const players = currentData.players || {};
        const votes = currentData.mvpVotes || {};
        const voteCounts = {};
        const adminVoteCounts = {};
        Object.entries(votes).forEach(([key, vote]) => {
            voteCounts[vote.votedFor] = (voteCounts[vote.votedFor] || 0) + 1;
            if (vote.isAdmin) adminVoteCounts[vote.votedFor] = (adminVoteCounts[vote.votedFor] || 0) + 1;
        });
        let html = '<div style="display: grid; grid-template-columns: 1fr; gap: 15px;">';
        for (let id in players) {
            const player = players[id];
            const voteCount = voteCounts[player.name] || 0;
            const adminCount = adminVoteCounts[player.name] || 0;
            const hasPhoto = player.photo && player.photo.startsWith('http');
            html += `
                <div style="background: var(--white); border-radius: 16px; padding: 15px; border: 2px solid ${hasPhoto ? '#10ac84' : '#ddd'}; display:flex; flex-direction: column;">
                    <div class="flex-between" style="margin-bottom: 12px;">
                        <div style="font-weight: 700; font-size: 1.05rem;">${player.name}</div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            ${adminCount > 0 ? `<div style="background:#f39c12; color:white; padding:4px 10px; border-radius:20px; font-size:0.8rem; font-weight:700;">+${adminCount} üõ°Ô∏è</div>` : ''}
                            <div style="background: var(--sibir-blue); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 700;">${voteCount}</div>
                        </div>
                    </div>
                    <div style="width: 100%; aspect-ratio: 16/9; background: #f0f0f0; border-radius: 12px; overflow: hidden; margin-bottom: 12px; display: flex; align-items: center; justify-content: center;">
                        ${hasPhoto ? `<img src="${player.photo}" style="width: 100%; height: 100%; object-fit: cover;">` : `<span style="color: #999; font-size: 3rem;">üë§</span>`}
                    </div>
                    <div class="grid-2" style="gap:8px;">
                        <button class="btn" style="font-size:0.85rem; background:#9ef01a; color:#1a5c00;" onclick="addAdminVote('${player.name}')">‚ûï –ì–æ–ª–æ—Å</button>
                        <button class="btn" style="font-size:0.85rem; background: ${hasPhoto ? '#ff9f43' : '#10ac84'}; color: white;" onclick="uploadPlayerPhoto('${id}')">${hasPhoto ? 'üîÑ –ó–∞–º–µ–Ω–∏—Ç—å' : 'üì∑ –î–æ–±–∞–≤–∏—Ç—å'}</button>
                        ${adminCount > 0 ? `<button class="btn" style="background:#ffeaa7; color:#856404; font-size:0.85rem;" onclick="removeAdminVote('${player.name}')">‚Ü© –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–∞</button>` : ''}
                        ${hasPhoto ? `<button class="btn" style="background: #ee5253; color: white; font-size: 0.85rem;" onclick="deletePlayerPhoto('${id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>` : ''}
                    </div>
                </div>`;
        }
        html += '</div>';
        container.innerHTML = html;
    }

    window.setNoisePlayer = (number) => { set(ref(db, 'competition/noisePlayer'), number); };

    window.addAdminVote = (playerName) => {        
        const voteId = 'admin_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7);
        set(ref(db, `competition/mvpVotes/${voteId}`), { votedFor: playerName, name: 'üõ°Ô∏è –ê–¥–º–∏–Ω', handle: 'admin', isAdmin: true, timestamp: Date.now() });
    };

    window.removeAdminVote = (playerName) => {
        const votes = currentData.mvpVotes || {};
        const adminVotes = Object.entries(votes)
            .filter(([, v]) => v.votedFor === playerName && v.isAdmin)
            .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0));
        if (adminVotes.length > 0) remove(ref(db, `competition/mvpVotes/${adminVotes[0][0]}`));
    };

    window.showVotersPopup = (player) => {
        const voters = window.mvpVotersData[player] || [];
        const list = voters.map(v => `${v.name} (@${v.handle || '–±–µ–∑ –Ω–∏–∫–∞'})`).join('\n');
        alert(`–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ ${player}:\n\n${list}`);
    };

    window.startEditName = (id) => { editingCharId = id; renderCharacters(); };
    window.cancelEditName = () => { editingCharId = null; renderCharacters(); };
    window.saveEditName = (id) => {
        const newName = document.getElementById(`edit-name-${id}`).value;
        if (!newName) { alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"); return; }
        update(ref(db, `competition/lookslike/characters/${id}`), { name: newName }).then(() => { editingCharId = null; });
    };

    window.renderVotes = () => {
        const container = document.getElementById('votesList');
        const filter = document.getElementById('filterMode').value;
        const votes = currentData.votes || {};
        let list = Object.keys(votes).map(id => ({id, ...votes[id]}));
        if(filter === 'correct') list = list.filter(v => v.votedFor === currentData.scorer);
        document.getElementById('vCount').textContent = `–í—Å–µ–≥–æ: ${list.length}`;
        let newHtml = '';
        list.reverse().forEach(v => {
            const isCorrect = v.votedFor === currentData.scorer;
            const voteAvatar = (v.photo && v.photo.length > 10) ? v.photo : tgLogo;
            const safeName = (v.name||'').replace(/'/g,"\\'");
            const safeHandle = (v.handle||'').replace(/'/g,"\\'");
            newHtml += `
                <div class="vote-card ${isCorrect ? 'correct' : ''}" style="cursor:pointer" onclick="openChat('${v.chatId}','${safeName}','${voteAvatar}','${safeHandle}')">
                    <span style="position:absolute; top:8px; right:12px; cursor:pointer; color:#ee5253; z-index:2; font-size:1.3rem;" onclick="event.stopPropagation(); removeVote('${v.id}')">√ó</span>
                    <div style="width:56px; height:56px; background: #eee; border-radius: 50%; overflow: hidden; flex-shrink: 0;">
                        <img src="${voteAvatar}" onerror="this.onerror=null; this.src='${tgLogo}'" style="width:56px; height:56px; object-fit: cover;">
                    </div>
                    <div style="font-weight:700; font-size:0.95rem; margin-top:10px; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${v.name}</div>
                    <div style="color:var(--sibir-blue); font-size:0.85rem; font-weight:600; margin-top:4px; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${v.votedFor}</div>
                </div>`;
        });
        if (lastVotesHtml !== newHtml) { container.innerHTML = newHtml; lastVotesHtml = newHtml; }
    }

    window.addKeyword = (id, inputId) => {
        const input = document.getElementById(inputId);
        const word = input.value.trim();
        if (!word) return;
        const player = (currentData.players || {})[id];
        if (!player) return;
        const existing = player.keywords ? player.keywords.split(',').map(s => s.trim()).filter(Boolean) : [];
        if (!existing.includes(word)) existing.push(word);
        update(ref(db, `competition/players/${id}`), { keywords: existing.join(', ') });
        input.value = '';
    };

    window.removeKeyword = (id, word) => {
        const player = (currentData.players || {})[id];
        if (!player) return;
        const existing = player.keywords ? player.keywords.split(',').map(s => s.trim()).filter(Boolean) : [];
        const updated = existing.filter(k => k !== word);
        update(ref(db, `competition/players/${id}`), { keywords: updated.join(', ') });
    };

    function renderPlayers() {
        const pList = document.getElementById('playersList');
        const pSelect = document.getElementById('goalScorer');
        const players = currentData.players || {};
        const scrollPos = pList.scrollTop;
        pList.innerHTML = '';
        let optionsHtml = '<option value="">-- –ö–¢–û –ó–ê–ë–ò–õ? --</option>';
        for (let id in players) {
            const player = players[id];
            const keywords = player.keywords ? player.keywords.split(',').map(s => s.trim()).filter(Boolean) : [];
            const kwHtml = keywords.map(kw => 
                `<span class="keyword-tag">${kw}<span onclick="removeKeyword('${id}','${kw.replace(/'/g,"\\'")}')">√ó</span></span>`
            ).join('');
            const inputId = `kw-input-${id}`;
            pList.innerHTML += `
                <div class="player-row">
                    <div class="player-row-top">
                        <span class="player-name-label">üë§ ${player.name}</span>
                        <span onclick="removePlayer('${id}')" style="color:#ee5253; cursor:pointer; font-size:1.3rem; line-height:1; padding:0 5px;">√ó</span>
                    </div>
                    <div style="margin-bottom:8px;">${kwHtml || '<span style="color:#aaa;font-size:0.85rem;">–Ω–µ—Ç –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤</span>'}</div>
                    <div class="keyword-add-row">
                        <input type="text" id="${inputId}" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ..." onkeydown="if(event.key==='Enter'){addKeyword('${id}','${inputId}');}">
                        <button onclick="addKeyword('${id}','${inputId}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>`;
            optionsHtml += `<option value="${player.name}" ${currentData.scorer === player.name ? 'selected' : ''}>${player.name}</option>`;
        }
        if (pSelect.innerHTML !== optionsHtml) pSelect.innerHTML = optionsHtml;
        pList.scrollTop = scrollPos;
    }

    // ===== QUIZ FUNCTIONS =====
    const ANSWER_COLORS = ['#05caff', '#ff9f43', '#3d8b00', '#ee5253'];
    const ANSWER_LABELS = ['A', 'B', 'C', 'D'];

    window.setQuizWinnerMode = (mode) => { set(ref(db, 'competition/quiz/winnerMode'), mode); };

    window.addQuizQuestion = () => {
        const text = document.getElementById('quiz-q-text').value.trim();
        if (!text) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞!'); return; }
        const answers = [0,1,2,3].map(i => ({
            text: document.getElementById(`quiz-a${i}-text`).value.trim(),
            keywords: document.getElementById(`quiz-a${i}-keys`).value.trim(),
            isCorrect: document.getElementById(`quiz-a${i}-correct`).checked
        }));
        if (answers.every(a => !a.text)) { alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞!'); return; }
        const questions = currentData.quiz?.questions || {};
        const order = Object.keys(questions).length;
        push(ref(db, 'competition/quiz/questions'), { text, answers, order, createdAt: Date.now() });
        document.getElementById('quiz-q-text').value = '';
        [0,1,2,3].forEach(i => {
            document.getElementById(`quiz-a${i}-text`).value = '';
            document.getElementById(`quiz-a${i}-keys`).value = '';
            document.getElementById(`quiz-a${i}-correct`).checked = false;
        });
    };

    window.deleteQuizQuestion = (id) => { if (confirm('–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å?')) remove(ref(db, `competition/quiz/questions/${id}`)); };
    window.clearAllQuizQuestions = () => {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã?')) {
            remove(ref(db, 'competition/quiz/questions'));
            remove(ref(db, 'competition/quiz/responses'));
            set(ref(db, 'competition/quiz/activeQuestionId'), null);
        }
    };
    window.clearQuizResponses = () => { if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç—ã? –í–æ–ø—Ä–æ—Å—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.')) remove(ref(db, 'competition/quiz/responses')); };

    window.setActiveQuizQuestion = (id) => {
        const prevId = currentData.quiz?.activeQuestionId;
        const prevScene = currentData.quizState;

        if (prevId && prevId !== id && prevScene === 'quiz_question') {
            set(ref(db, 'competition/acceptingQuizAnswers'), false);
            set(ref(db, 'competition/quiz/revealQuestionId'), prevId);
            set(ref(db, 'competition/quizState'), 'quiz_answer_reveal');
            set(ref(db, 'competition/quizStateTs'), Date.now());

            setTimeout(() => {
                set(ref(db, 'competition/quiz/activeQuestionId'), id);
                set(ref(db, 'competition/quiz/revealQuestionId'), null);
                set(ref(db, 'competition/quizState'), 'quiz_question');
                set(ref(db, 'competition/quizStateTs'), Date.now());
                set(ref(db, 'competition/acceptingQuizAnswers'), true);
            }, 4000);
        } else {
            set(ref(db, 'competition/quiz/activeQuestionId'), id);
            if ((currentData.activeMode || 'voting') === 'quiz') {
                set(ref(db, 'competition/quizState'), 'quiz_question');
                set(ref(db, 'competition/quizStateTs'), Date.now());
            }
        }
    };

    window.removeQuizRespondent = (userId) => {
        if (!confirm('–£–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã?')) return;
        const questions = currentData.quiz?.questions || {};
        const updates = {};
        Object.keys(questions).forEach(qId => { updates[`competition/quiz/responses/${qId}/${userId}`] = null; });
        update(ref(db), updates);
    };

    window.quizLaunchRoulette = () => {
        const questions = currentData.quiz?.questions || {};
        const responses = currentData.quiz?.responses || {};
        const winnerMode = currentData.quiz?.winnerMode || 'all_correct';
        const questionIds = Object.keys(questions);
        const prevScene = currentData.quizState;

        if (questionIds.length === 0) { alert('–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤!'); return; }

        const correctMap = {};
        questionIds.forEach(qId => {
            const q = questions[qId];
            correctMap[qId] = new Set();
            (q.answers || []).forEach((a, i) => { if (a && a.isCorrect) correctMap[qId].add(i); });
        });

        const userStats = {};
        questionIds.forEach(qId => {
            const qResponses = responses[qId] || {};
            Object.entries(qResponses).forEach(([userId, r]) => {
                if (!userStats[userId]) userStats[userId] = { name: r.name, handle: r.handle, photo: r.photo, chatId: r.chatId, correctCount: 0, answeredCount: 0 };
                userStats[userId].answeredCount++;
                if (correctMap[qId].has(r.answerIndex)) userStats[userId].correctCount++;
            });
        });

        let pool = [];
        if (winnerMode === 'all_correct') {
            Object.values(userStats).forEach(u => { if (u.correctCount === questionIds.length) pool.push(u); });
        } else {
            Object.values(userStats).forEach(u => { for (let i = 0; i < u.correctCount; i++) pool.push(u); });
        }

        if (pool.length === 0) {
            const msg = winnerMode === 'all_correct' ? '–ù–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!' : '–ù–∏–∫—Ç–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∏ –Ω–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å!';
            if (!confirm(msg + '\n\n–í—Å—ë —Ä–∞–≤–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É?')) return;
        }

        set(ref(db, 'competition/quiz/roulettePool'), pool);

        if (prevScene === 'quiz_question') {
            const activeId = currentData.quiz?.activeQuestionId;
            if (activeId) {
                set(ref(db, 'competition/acceptingQuizAnswers'), false);
                set(ref(db, 'competition/quiz/revealQuestionId'), activeId);
                set(ref(db, 'competition/quizState'), 'quiz_answer_reveal');
                set(ref(db, 'competition/quizStateTs'), Date.now());
                setTimeout(() => {
                    set(ref(db, 'competition/quizState'), 'quiz_roulette');
                    set(ref(db, 'competition/quizStateTs'), Date.now());
                }, 4000);
                return;
            }
        }

        set(ref(db, 'competition/quizState'), 'quiz_roulette');
        set(ref(db, 'competition/quizStateTs'), Date.now());
    };

    window.quizPickWinner = () => {
        const pool = currentData.quiz?.roulettePool;
        if (!pool || !Array.isArray(pool) || pool.length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ä—É–ª–µ—Ç–∫—É!'); return; }
        const winner = pool[Math.floor(Math.random() * pool.length)];
        set(ref(db, 'competition/quiz/winner'), { ...winner, selectionId: Date.now() });
        set(ref(db, 'competition/quizState'), 'quiz_winner');
        set(ref(db, 'competition/quizStateTs'), Date.now());
        alert('–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã: ' + winner.name);
    };

    let lastQuizHtml = '';
    let lastRespondentsHtml = '';

    function renderQuiz() {
        const container = document.getElementById('quizQuestionsList');
        if (!container) return;
        const questions = currentData.quiz?.questions || {};
        const responses = currentData.quiz?.responses || {};
        const activeQId = currentData.quiz?.activeQuestionId;
        const winnerMode = currentData.quiz?.winnerMode || 'all_correct';
        const questionIds = Object.keys(questions);

        const sorted = Object.entries(questions).sort((a,b) => (a[1].order||0) - (b[1].order||0));
        if (sorted.length === 0) {
            container.innerHTML = '<div style="color:#aaa; text-align:center; padding: 30px;">–í–æ–ø—Ä–æ—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        } else {
            let html = '';
            sorted.forEach(([id, q], idx) => {
                const isActive = id === activeQId;
                const qResponses = responses[id] || {};
                const totalResponses = Object.keys(qResponses).length;

                const answerCounts = [0,0,0,0];
                Object.values(qResponses).forEach(r => { if (r.answerIndex >= 0 && r.answerIndex < 4) answerCounts[r.answerIndex]++; });

                const answersHtml = (q.answers || []).map((a, i) => {
                    if (!a.text) return '';
                    const pct = totalResponses > 0 ? Math.round(answerCounts[i] / totalResponses * 100) : 0;
                    return `
                    <div class="quiz-answer-block ${a.isCorrect ? 'is-correct' : ''}" style="border-left-color: ${ANSWER_COLORS[i]};">
                        <div class="quiz-answer-label" style="color:${ANSWER_COLORS[i]}; display:flex; justify-content:space-between;">
                            <span>${ANSWER_LABELS[i]}${a.isCorrect ? ' ‚úì' : ''}</span>
                            <span style="font-size:0.85rem; color:#666;">${answerCounts[i]} (${pct}%)</span>
                        </div>
                        <div class="quiz-answer-text">${a.text}</div>
                        ${a.keywords ? `<div class="quiz-answer-keys">üîë ${a.keywords}</div>` : ''}
                    </div>`;
                }).join('');

                html += `
                <div class="quiz-q-card ${isActive ? 'active-q' : ''}">
                    <div class="quiz-q-header">
                        <span class="quiz-q-num">–í–æ–ø—Ä–æ—Å ${idx + 1}</span>
                        ${isActive ? '<span class="quiz-active-badge">‚óè –í –≠–§–ò–†–ï</span>' : ''}
                        <span class="quiz-response-badge">${totalResponses} –æ—Ç–≤.</span>
                    </div>
                    <div class="quiz-q-text">${q.text}</div>
                    <div class="quiz-answers-grid">${answersHtml}</div>
                    <div class="grid-2" style="margin-top:15px; gap:8px;">
                        <button class="btn" style="padding:10px; font-size:0.85rem; background:${isActive ? '#9ef01a' : 'var(--gray)'}; color:${isActive ? '#1a5c00' : 'var(--text-main)'};" onclick="setActiveQuizQuestion('${id}')">${isActive ? 'üéØ –ê–∫—Ç–∏–≤–Ω—ã–π' : '‚ñ∂ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}</button>
                        <button class="btn" style="padding:10px; font-size:0.85rem; background:#fab1a0; color:#c0392b;" onclick="deleteQuizQuestion('${id}')">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>`;
            });

            if (lastQuizHtml !== html) { container.innerHTML = html; lastQuizHtml = html; }
        }

        const respondentsContainer = document.getElementById('quizRespondentsList');
        const titleEl = document.getElementById('quizRespondentsTitle');
        if (!respondentsContainer || questionIds.length === 0) return;

        const correctMap = {};
        questionIds.forEach(qId => {
            const q = questions[qId];
            correctMap[qId] = new Set();
            (q.answers || []).forEach((a, i) => { if (a && a.isCorrect) correctMap[qId].add(i); });
        });

        const userStats = {};
        questionIds.forEach(qId => {
            const qResponses = responses[qId] || {};
            const q = questions[qId];
            Object.entries(qResponses).forEach(([userId, r]) => {
                if (!userStats[userId]) {
                    userStats[userId] = { name: r.name, handle: r.handle, photo: r.photo, chatId: r.chatId, correctCount: 0, totalCount: 0, correctAnswers: [] };
                }
                userStats[userId].totalCount++;
                if (correctMap[qId].has(r.answerIndex)) {
                    userStats[userId].correctCount++;
                    const ansText = (q.answers || [])[r.answerIndex]?.text || '';
                    userStats[userId].correctAnswers.push(`${ANSWER_LABELS[r.answerIndex]}: ${ansText}`);
                }
            });
        });

        let eligible = [];
        if (winnerMode === 'all_correct') {
            eligible = Object.entries(userStats).filter(([,u]) => u.correctCount === questionIds.length);
            if (titleEl) titleEl.textContent = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ (${eligible.length})`;
        } else {
            eligible = Object.entries(userStats).filter(([,u]) => u.correctCount > 0);
            if (titleEl) titleEl.textContent = `–•–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π (${eligible.length})`;
        }

        eligible.sort((a,b) => b[1].correctCount - a[1].correctCount);

        if (eligible.length === 0) {
            respondentsContainer.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px;">–ü–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
            lastRespondentsHtml = '';
            return;
        }

        let rHtml = '';
        eligible.forEach(([userId, u]) => {
            const avatar = (u.photo && u.photo.length > 10) ? u.photo : 'media/tg_logo.png';
            const safeName = (u.name||'').replace(/'/g,"\\'");
            const safeHandle = (u.handle||'').replace(/'/g,"\\'");
            const correctBadge = `${u.correctCount}/${questionIds.length} ‚úì`;
            const answersPreview = u.correctAnswers.join(' ¬∑ ');
            rHtml += `
            <div class="vote-card correct" style="position:relative;">
                <button onclick="removeQuizRespondent('${userId}')" title="–£–±—Ä–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞" style="position:absolute;top:8px;right:8px;background:#ee5253;color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:12px;cursor:pointer;line-height:1;padding:0;">‚úï</button>
                <div style="width:56px; height:56px; background:#eee; border-radius:50%; overflow:hidden; flex-shrink:0; cursor:pointer;" onclick="openChat('${u.chatId}','${safeName}','${avatar}','${safeHandle}')">
                    <img src="${avatar}" onerror="this.onerror=null;this.src='media/tg_logo.png'" style="width:56px;height:56px;object-fit:cover;">
                </div>
                <div style="font-weight:700; font-size:0.95rem; margin-top:8px; width:100%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${u.name || '–ê–Ω–æ–Ω–∏–º'}</div>
                <div style="color:#10ac84; font-size:0.9rem; font-weight:700; margin-top:4px;">${correctBadge}</div>
                ${winnerMode === 'any_correct' && answersPreview ? `<div style="font-size:0.75rem; color:#666; margin-top:6px; line-height:1.3; width:100%;">${answersPreview}</div>` : ''}
            </div>`;
        });

        respondentsContainer.innerHTML = rHtml;
        lastRespondentsHtml = rHtml;
    }
</script>
</body>
</html>
