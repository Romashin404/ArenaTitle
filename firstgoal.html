<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <style>
        #bg-layer, #bg-layer-2 {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: -1; 
            transition: opacity 1.5s ease-in-out;
            background-color: transparent;
            opacity: 0;
        }
        #bg-layer-2 { z-index: -1; }

        @font-face {
            font-family: 'MyCustomFont';
            src: url('fonts/DrukCyr-HeavyItalic.ttf') format('truetype');
        }
        
        @keyframes scrollTape {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); } 
        }

        @keyframes fadeInOutCustom {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.2); }
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); }
            50% { transform: scale(1.03); text-shadow: 0 0 50px rgba(0, 242, 255, 0.9); }
        }

        #tape.rolling {
            display: flex;
            position: absolute;
            left: 0;
            animation: scrollTape 20s linear infinite; 
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: transparent; font-family: 'MyCustomFont', sans-serif; color: white; }
        
        .scene {
            position: absolute; 
            width: 100%; 
            height: 100%;
            display: flex;
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            text-align: center;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.8s;
        }

        .scene.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
            z-index: 5;
        }

        #bg-video {
            transition: opacity 1.5s ease-in-out;
        }

        h1 { font-size: 80px; text-transform: uppercase; text-shadow: 4px 4px 15px rgba(0,0,0,0.8); margin: 20px; }
        h2 { font-size: 80px; text-shadow: 4px 4px 15px rgba(0,0,0,0.8); }

        .roulette-wrapper {
            position: relative; width: 1920px; height: 400px;
            display: flex; align-items: center;
        }
        #tape { display: flex; position: absolute; left: 0; }
        .user-card { min-width: 300px; display: flex; flex-direction: column; align-items: center; }
        .user-card img { width: 270px; height: 270px; border-radius: 50%; border: 5px solid white; object-fit: cover; }
        .user-card span { margin-top: 15px; font-size: 24px; font-weight: bold; }

        #winner { flex-direction: column; align-items: center; justify-content: center; }

        .winner-title {
            font-size: 140px;
            text-shadow: 0 0 20px rgba(0, 242, 255, 0.6);
            margin: 0 0 40px 0;
        }

        .winner-content { display: flex; flex-direction: column; align-items: center; }

        .winner-avatar {
            width: 380px; height: 380px;
            border-radius: 50%;
            border: 10px solid rgb(42, 138, 255);
            box-shadow: 0 0 60px rgb(42, 138, 255);
            object-fit: cover;
            margin-bottom: 30px;
        }

        .fade-out-text { 
            font-size: 250px; font-weight: bold; color: white; 
            text-shadow: 0 0 30px rgba(0, 242, 255, 0.9); 
            position: absolute; width: 100%; left: 50%; top: 50%; 
            transform: translate(-50%, -50%); opacity: 0;
        }

        .scene.active .fade-out-text {
            animation: fadeInOutCustom 3s forwards;
        }

        .final-pulse-container { opacity: 0; }
        
        .scene.active .final-pulse-container { 
            animation: fadeInMain 0.5s forwards 3.1s, pulse-glow 3s ease-in-out infinite 5.0s; 
        }

        .line1, .line2, .line3 { 
            opacity: 0; text-transform: uppercase; transform: translateY(100px); 
        }

        .scene.active .line1 { font-size: 220px; font-weight: bold; animation: slideUpFade 0.8s forwards 3.3s; text-shadow: 0 0 30px rgba(0, 242, 255, 0.9);}
        .scene.active .line2 { font-size: 220px; font-weight: bold; margin-top: -30px; animation: slideUpFade 0.8s forwards 3.8s; text-shadow: 0 0 30px rgba(0, 242, 255, 0.9);}
        .scene.active .line3 { font-size: 100px; margin-top: 30px; animation: slideUpFade 0.8s forwards 4.3s; }

        .announcement-content { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 200px; text-shadow: 0 0 30px rgba(0, 242, 255, 0.9);}
        
        @keyframes fadeInMain { to { opacity: 1; } }
        @keyframes slideUpFade { to { opacity: 1; transform: translateY(0); } }

        .qr-row { display: flex; gap: 100px; justify-content: center; align-items: flex-start; }
        .qr-item { display: flex; flex-direction: column; align-items: center; }
        .qr-item img { width: 700px; border: 10px solid white; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .top-logo { position: absolute; top: 0px; left: 50%; transform: translateX(-50%); width: 350px; z-index: 10; outline: none; }
        
        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; transition: opacity 1.5s ease-in-out; }
        .video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: transparent; }
    </style>
</head>
<body>
    <div id="bg-layer"></div>
    <div id="bg-layer-2"></div>

    <div id="announcement" class="scene">
        <video muted playsinline id="logo-video" class="top-logo">
            <source src="media/logoVideo.webm" type="video/webm">
        </video>
        <div class="announcement-content">
            <h1 class="fade-out-text">УГАДАЙ!</h1>
            <div class="staggered-text final-pulse-container">
                <div class="line1">КТО ЗАБРОСИТ</div>
                <div class="line2">ПЕРВУЮ ШАЙБУ?</div>
                <div class="line3">В СОСТАВЕ ХК «СИБИРЬ»</div>
            </div>
        </div>
    </div>
    
    <div id="qr" class="scene">
        <div class="qr-row">
            <div class="qr-item"><img src="media/telegramqr.png" loading="lazy"></div>
            <div class="qr-item"><img src="media/vkqr.png" loading="lazy"></div>
        </div>
        <h1 style="text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); font-size: 160px; animation: pulse-glow 2s ease-in-out infinite;">Переходи и голосуй!</h1>
    </div>

    <div id="roulette" class="scene">
        <h1 style="text-shadow: 0 0 20px rgba(0, 242, 255, 0.6); font-size: 150px">Выбираем победителя...</h1>
        <div class="roulette-wrapper">
            <div id="tape"></div>
        </div>
    </div>

    <div id="winner" class="scene">
        <h1 class="winner-title">ПОБЕДИТЕЛЬ:</h1>
        <div id="winner-display" class="winner-content"></div>
    </div>

    <video autoplay muted loop playsinline id="bg-video">
        <source src="media/backgroundvideo.webm" type="video/webm">
    </video>
    <div class="video-overlay"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCWMrknceb-9SolXGBv8NB3CoOEKkD4rk8",
            authDomain: "arenawork-94e68.firebaseapp.com",
            databaseURL: "https://arenawork-94e68-default-rtdb.firebaseio.com",
            projectId: "arenawork-94e68",
            storageBucket: "arenawork-94e68.firebasestorage.app",
            messagingSenderId: "504372844993",
            appId: "1:504372844993:web:1783bb75879ee074953740"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        const tape        = document.getElementById('tape');
        const bgLayer     = document.getElementById('bg-layer');
        const bgLayer2    = document.getElementById('bg-layer-2');
        const bgVideo     = document.getElementById('bg-video');
        const logoVid     = document.getElementById('logo-video');

        const defaultPhoto = 'media/tg_logo.png';
        const preloadedImages = new Map();

        let lastScene   = '';
        let lastBgUrl   = '';
        let allWinners  = [];
        let currentVotes  = {};
        let currentScorer = '';

        // ── Фон с crossfade — грузим в скрытый слой, показываем только после загрузки ──
        function applyBackground(url) {
            if (url === lastBgUrl) return;
            lastBgUrl = url;

            if (!url || !url.trim()) {
                bgLayer.style.opacity  = '0';
                bgLayer2.style.opacity = '0';
                bgVideo.style.opacity  = '1';
                return;
            }

            // Грузим в скрытый слой
            const img = new Image();
            img.onload = () => {
                bgLayer2.style.backgroundImage = `url('${url}')`;
                bgLayer2.style.opacity = '1';
                bgVideo.style.opacity  = '0';
                // После перехода копируем в основной и скрываем второй
                setTimeout(() => {
                    bgLayer.style.backgroundImage = `url('${url}')`;
                    bgLayer.style.opacity  = '1';
                    bgLayer2.style.opacity = '0';
                }, 1600);
            };
            img.onerror = () => {
                // Если не загрузилось — оставляем видео
                bgVideo.style.opacity = '1';
            };
            img.src = url;
        }

        // ── Предзагрузка фото болельщиков ──
        function smartPreload(url) {
            if (!url || url === defaultPhoto || preloadedImages.has(url)) return;
            preloadedImages.set(url, false);
            const img = new Image();
            img.onload  = () => preloadedImages.set(url, true);
            img.onerror = () => preloadedImages.delete(url);
            img.src = url;
        }

        // ── Переключение сцен ──
        function switchScene(sceneId) {
            if (sceneId === lastScene) return;
            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(sceneId);
            if (target) target.classList.add('active');

            if (sceneId === 'announcement') {
                logoVid.currentTime = 0;
                logoVid.play().catch(() => {});
            } else {
                logoVid.pause();
            }

            if (sceneId === 'roulette') {
                allWinners = Object.values(currentVotes).filter(v => v.votedFor === currentScorer);
                startRoulette();
            } else {
                stopRoulette();
            }

            lastScene = sceneId;
        }

        // ── Рулетка ──
        function startRoulette() {
            tape.innerHTML = '';
            tape.classList.add('rolling');
            if (allWinners.length === 0) return;

            const repeatCount = Math.ceil(40 / allWinners.length);
            let displayList = [...allWinners].sort(() => Math.random() - 0.5);
            let fullSet = [];
            for (let i = 0; i < repeatCount; i++) fullSet = fullSet.concat(displayList);
            const finalList = [...fullSet, ...fullSet];

            // Строим через fragment — быстрее чем innerHTML +=
            const frag = document.createDocumentFragment();
            finalList.forEach(user => {
                const photo = (user.photo && user.photo.trim()) ? user.photo : defaultPhoto;
                const div = document.createElement('div');
                div.className = 'user-card';
                div.innerHTML = `<img src="${photo}" onerror="this.src='${defaultPhoto}'" loading="lazy">
                                 <span>@${user.handle || user.name || 'Anonymous'}</span>`;
                frag.appendChild(div);
            });
            tape.appendChild(frag);

            tape.style.animationDuration = `${Math.max(10, allWinners.length * 0.8)}s`;
        }

        function stopRoulette() {
            tape.classList.remove('rolling');
            tape.innerHTML = '';
        }

        function displayWinner(winner) {
            const container = document.getElementById('winner-display');
            if (!winner || !container) return;
            const photo = (winner.photo && winner.photo.trim()) ? winner.photo : defaultPhoto;
            container.innerHTML = `
                <img src="${photo}" class="winner-avatar" onerror="this.src='${defaultPhoto}'">
                <h1 style="font-size:150px;margin:10px 0;">${winner.name || 'Без имени'}</h1>
                <h2 style="font-size:70px;margin:0;">@${winner.handle || 'no_nickname'}</h2>`;
        }

        // ════════════════════════════════════════════════════
        // Разбитые Firebase listeners — каждый слушает только своё
        // ════════════════════════════════════════════════════

        // 1. Фон
        onValue(ref(db, 'competition/backgrounds/voting'), snap => {
            applyBackground(snap.val() || '');
        });

        // 2. Сцена
        onValue(ref(db, 'competition/votingState'), snap => {
            switchScene(snap.val() || 'announcement');
        });

        // 3. Счёт/автор гола — нужен для рулетки
        onValue(ref(db, 'competition/scorer'), snap => {
            currentScorer = snap.val() || '';
        });

        // 4. Голоса — предзагружаем фото, обновляем список для рулетки
        onValue(ref(db, 'competition/votes'), snap => {
            currentVotes = snap.val() || {};
            Object.values(currentVotes).forEach(v => {
                if (v.photo) smartPreload(v.photo);
            });
        });

        // 5. Победитель
        onValue(ref(db, 'competition/winner'), snap => {
            const winner = snap.val();
            if (winner) {
                if (winner.photo) smartPreload(winner.photo);
                displayWinner(winner);
            }
        });

    </script>
</body>
</html>
